{% load static %}
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Bijouterie Hafsa - ERP{% endblock %}</title>

    <!-- Modern Design System -->
    <link rel="stylesheet" href="{% static 'css/design-system.css' %}">
    <link rel="stylesheet" href="{% static 'css/mobile-forms.css' %}">

    <!-- Bootstrap CSS (for modals only) -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* Enhanced Responsive Sidebar Styles */
        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            bottom: 0;
            width: var(--sidebar-width);
            background: white;
            border-right: 1px solid var(--neutral-200);
            display: flex;
            flex-direction: column;
            z-index: var(--z-fixed);
            transition: transform var(--transition-slow), width var(--transition-slow);
            overflow: hidden;
        }

        /* Mobile Sidebar - Hidden by default */
        @media (max-width: 1023px) {
            .sidebar {
                transform: translateX(-100%);
                box-shadow: var(--shadow-2xl);
            }

            .sidebar.open {
                transform: translateX(0);
            }

            .main-content {
                margin-left: 0 !important;
            }

            .sidebar-toggle {
                display: flex !important;
            }
        }

        /* Tablet adjustments */
        @media (min-width: 768px) and (max-width: 1023px) {
            .page-wrapper {
                padding: var(--space-6);
            }
        }

        /* Mobile adjustments */
        @media (max-width: 767px) {
            :root {
                --navbar-height: 64px;
            }

            .navbar {
                padding: 0 var(--space-4);
            }

            .search-wrapper {
                display: none;
            }

            .user-info {
                display: none;
            }

            .page-wrapper {
                padding: var(--space-4);
            }

            .page-header-inner {
                flex-direction: column;
                align-items: stretch;
                gap: var(--space-4);
            }

            .page-actions {
                flex-direction: column;
            }

            .page-actions .btn {
                width: 100%;
                justify-content: center;
            }

            /* Mobile grid adjustments */
            .grid-cols-2,
            .grid-cols-3,
            .grid-cols-4 {
                grid-template-columns: 1fr !important;
            }

            /* Mobile stat cards */
            .stat-card {
                padding: var(--space-4);
            }

            .stat-value {
                font-size: var(--text-2xl);
            }

            /* Mobile cards */
            .card-body {
                padding: var(--space-4);
            }

            .card-header {
                padding: var(--space-4);
                flex-direction: column;
                align-items: flex-start;
                gap: var(--space-3);
            }

            .card-footer {
                padding: var(--space-4);
                flex-direction: column;
                gap: var(--space-3);
            }

            /* Mobile tables */
            .table-wrapper {
                margin: 0 calc(var(--space-4) * -1);
                border-radius: 0;
                border-left: none;
                border-right: none;
            }

            .table th,
            .table td {
                padding: var(--space-3);
                font-size: var(--text-xs);
            }

            /* Mobile forms */
            .form-row,
            .form-row-3 {
                grid-template-columns: 1fr !important;
            }

            .btn-group {
                flex-direction: column;
            }

            .btn-group .btn {
                width: 100%;
            }

            /* Mobile breadcrumb */
            .breadcrumb {
                display: none;
            }
        }

        /* Overlay for mobile sidebar */
        .sidebar-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
            z-index: calc(var(--z-fixed) - 1);
            opacity: 0;
            visibility: hidden;
            transition: all var(--transition-base);
        }

        .sidebar-overlay.show {
            opacity: 1;
            visibility: visible;
        }

        /* Mobile bottom navigation (optional) */
        .mobile-bottom-nav {
            display: none;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-top: 1px solid var(--neutral-200);
            padding: var(--space-2) var(--space-4);
            z-index: var(--z-sticky);
            box-shadow: 0 -4px 6px -1px rgb(0 0 0 / 0.1);
        }

        @media (max-width: 767px) {
            .mobile-bottom-nav {
                display: flex;
                justify-content: space-around;
                align-items: center;
            }

            .page-wrapper {
                padding-bottom: calc(var(--space-4) + 70px);
            }
        }

        .mobile-nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: var(--space-1);
            padding: var(--space-2);
            color: var(--neutral-500);
            text-decoration: none;
            font-size: var(--text-xs);
            transition: color var(--transition-fast);
            min-width: 60px;
        }

        .mobile-nav-item:hover,
        .mobile-nav-item.active {
            color: var(--primary-600);
        }

        .mobile-nav-item i {
            font-size: var(--text-lg);
        }

        /* Enhanced sidebar toggle button */
        .sidebar-toggle {
            display: none;
            width: 44px;
            height: 44px;
            border-radius: var(--radius-lg);
            border: none;
            background: transparent;
            color: var(--neutral-600);
            cursor: pointer;
            transition: all var(--transition-fast);
            align-items: center;
            justify-content: center;
        }

        .sidebar-toggle:hover {
            background: var(--neutral-100);
            color: var(--neutral-900);
        }

        /* Sidebar close button for mobile */
        .sidebar-close {
            display: none;
            position: absolute;
            top: var(--space-4);
            right: var(--space-4);
            width: 36px;
            height: 36px;
            border-radius: var(--radius-full);
            border: none;
            background: var(--neutral-100);
            color: var(--neutral-600);
            cursor: pointer;
            transition: all var(--transition-fast);
            align-items: center;
            justify-content: center;
            z-index: 10;
        }

        .sidebar-close:hover {
            background: var(--neutral-200);
            color: var(--neutral-900);
        }

        @media (max-width: 1023px) {
            .sidebar-close {
                display: flex;
            }
        }

        /* Fix for small screens nav sections */
        @media (max-width: 1023px) {
            .nav-section-title {
                padding: 0 var(--space-4);
            }
        }

        /* Barcode Scanner Button */
        .barcode-scan-btn {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            background: var(--primary-500);
            color: white;
            border: none;
            border-radius: var(--radius-md);
            width: 36px;
            height: 36px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all var(--transition-fast);
        }

        .barcode-scan-btn:hover {
            background: var(--primary-600);
        }

        .search-wrapper {
            position: relative;
        }

        .search-input {
            padding-right: 50px !important;
        }

        /* Barcode Scanner Modal */
        .scanner-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 100000;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }

        .scanner-modal.active {
            display: flex;
        }

        .scanner-container {
            position: relative;
            width: 100%;
            max-width: 500px;
            aspect-ratio: 1;
            background: #000;
            border-radius: var(--radius-lg);
            overflow: hidden;
        }

        .scanner-container video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .scanner-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 70%;
            height: 30%;
            border: 3px solid var(--primary-500);
            border-radius: var(--radius-md);
            box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.5);
        }

        .scanner-line {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--primary-500);
            animation: scanLine 2s ease-in-out infinite;
        }

        @keyframes scanLine {
            0%, 100% { top: 0; }
            50% { top: calc(100% - 3px); }
        }

        .scanner-close {
            position: absolute;
            top: 20px;
            right: 20px;
            background: white;
            border: none;
            width: 48px;
            height: 48px;
            border-radius: var(--radius-full);
            font-size: 24px;
            cursor: pointer;
            z-index: 10;
        }

        .scanner-status {
            color: white;
            margin-top: 20px;
            font-size: var(--text-lg);
            text-align: center;
        }

        .scanner-result {
            background: var(--success-500);
            color: white;
            padding: 12px 24px;
            border-radius: var(--radius-lg);
            margin-top: 16px;
            font-weight: 600;
        }

        /* Mobile scan button in bottom nav */
        @media (max-width: 767px) {
            .mobile-scan-btn {
                display: flex;
            }
        }
    </style>

    {% block extra_css %}{% endblock %}
</head>
<body>
    <!-- Sidebar Overlay (mobile) -->
    <div class="sidebar-overlay" id="sidebarOverlay" onclick="closeSidebar()"></div>

    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
        <!-- Close button for mobile -->
        <button class="sidebar-close" onclick="closeSidebar()">
            <i class="fas fa-times"></i>
        </button>

        <!-- Sidebar Header -->
        <div class="sidebar-header">
            <a href="{% url 'dashboard' %}" class="sidebar-brand">
                <div class="sidebar-logo">HF</div>
                <div class="sidebar-brand-text">
                    <div class="sidebar-brand-name">Bijouterie Hafsa</div>
                    <div class="sidebar-brand-subtitle">Gestion d'Entreprise</div>
                </div>
            </a>
        </div>

        <!-- Sidebar Navigation -->
        <nav class="sidebar-nav">
            <!-- Main Section -->
            <div class="nav-section">
                <div class="nav-section-title">Menu Principal</div>

                <!-- Dashboard -->
                <div class="nav-item">
                    <a href="{% url 'dashboard' %}" class="nav-link {% if request.resolver_match.url_name == 'dashboard' %}active{% endif %}">
                        <i class="fas fa-home nav-icon"></i>
                        <span class="nav-text">Tableau de Bord</span>
                    </a>
                </div>

                <!-- Products -->
                <div class="nav-item {% if 'products' in request.path %}open{% endif %}" id="nav-products">
                    <a href="#" class="nav-link" onclick="toggleSubmenu('nav-products'); return false;">
                        <i class="fas fa-gem nav-icon"></i>
                        <span class="nav-text">Produits</span>
                        <i class="fas fa-chevron-right nav-chevron"></i>
                    </a>
                    <div class="nav-submenu">
                        <a href="{% url 'products:inventory_dashboard' %}" class="nav-link {% if 'inventory' in request.path %}active{% endif %}">
                            <span class="nav-text">Inventaire</span>
                        </a>
                        <a href="{% url 'products:list' %}" class="nav-link {% if request.resolver_match.url_name == 'list' and 'products' in request.path %}active{% endif %}">
                            <span class="nav-text">Tous les Produits</span>
                        </a>
                        <a href="{% url 'products:create' %}" class="nav-link {% if 'create' in request.path and 'products' in request.path %}active{% endif %}">
                            <span class="nav-text">Nouveau Produit</span>
                        </a>
                        <a href="{% url 'products:batch_create' %}" class="nav-link">
                            <span class="nav-text">Ajout en Lot</span>
                        </a>
                    </div>
                </div>

                <!-- Sales -->
                <div class="nav-item {% if 'sales' in request.path %}open{% endif %}" id="nav-sales">
                    <a href="#" class="nav-link" onclick="toggleSubmenu('nav-sales'); return false;">
                        <i class="fas fa-shopping-cart nav-icon"></i>
                        <span class="nav-text">Ventes</span>
                        <i class="fas fa-chevron-right nav-chevron"></i>
                    </a>
                    <div class="nav-submenu">
                        <a href="{% url 'sales:invoice_create' %}" class="nav-link {% if 'create' in request.path and 'sales' in request.path %}active{% endif %}">
                            <span class="nav-text">Nouvelle Facture</span>
                        </a>
                        <a href="{% url 'sales:bulk_create' %}" class="nav-link">
                            <span class="nav-text">Facturation en Lot</span>
                        </a>
                        <a href="{% url 'sales:pending_invoices' %}" class="nav-link {% if 'pending' in request.path and 'sales' in request.path %}active{% endif %}">
                            <i class="fas fa-clock text-warning" style="margin-right: 6px;"></i>
                            <span class="nav-text">En Attente (Telegram)</span>
                        </a>
                        <a href="{% url 'sales:invoice_list' %}" class="nav-link {% if 'invoices' in request.path and 'sales' in request.path %}active{% endif %}">
                            <span class="nav-text">Historique</span>
                        </a>
                        <a href="{% url 'sales:delivery_list' %}" class="nav-link {% if 'livraisons' in request.path %}active{% endif %}">
                            <i class="fas fa-truck text-info" style="margin-right: 6px;"></i>
                            <span class="nav-text">Livraisons</span>
                        </a>
                    </div>
                </div>

                <!-- Purchases -->
                <div class="nav-item {% if 'purchases' in request.path %}open{% endif %}" id="nav-purchases">
                    <a href="#" class="nav-link" onclick="toggleSubmenu('nav-purchases'); return false;">
                        <i class="fas fa-boxes nav-icon"></i>
                        <span class="nav-text">Achats</span>
                        <i class="fas fa-chevron-right nav-chevron"></i>
                    </a>
                    <div class="nav-submenu">
                        <a href="{% url 'purchases:purchase_order_list' %}" class="nav-link">
                            <span class="nav-text">Commandes</span>
                        </a>
                        <a href="{% url 'purchases:purchase_invoice_list' %}" class="nav-link">
                            <span class="nav-text">Factures d'Achat</span>
                        </a>
                        <a href="{% url 'purchases:consignment_list' %}" class="nav-link">
                            <span class="nav-text">Consignations</span>
                        </a>
                    </div>
                </div>

                <!-- Suppliers -->
                <div class="nav-item {% if 'suppliers' in request.path %}open{% endif %}" id="nav-suppliers">
                    <a href="#" class="nav-link" onclick="toggleSubmenu('nav-suppliers'); return false;">
                        <i class="fas fa-industry nav-icon"></i>
                        <span class="nav-text">Fournisseurs</span>
                        <i class="fas fa-chevron-right nav-chevron"></i>
                    </a>
                    <div class="nav-submenu">
                        <a href="{% url 'suppliers:list' %}" class="nav-link">
                            <span class="nav-text">Tous les Fournisseurs</span>
                        </a>
                        <a href="{% url 'suppliers:create' %}" class="nav-link">
                            <span class="nav-text">Nouveau Fournisseur</span>
                        </a>
                    </div>
                </div>

                <!-- Clients -->
                <div class="nav-item {% if 'clients' in request.path %}open{% endif %}" id="nav-clients">
                    <a href="#" class="nav-link" onclick="toggleSubmenu('nav-clients'); return false;">
                        <i class="fas fa-users nav-icon"></i>
                        <span class="nav-text">Clients</span>
                        <i class="fas fa-chevron-right nav-chevron"></i>
                    </a>
                    <div class="nav-submenu">
                        <a href="{% url 'clients:list' %}" class="nav-link {% if request.resolver_match.url_name == 'list' and 'clients' in request.path %}active{% endif %}">
                            <span class="nav-text">Tous les Clients</span>
                        </a>
                        <a href="{% url 'clients:create' %}" class="nav-link {% if request.resolver_match.url_name == 'create' and 'clients' in request.path %}active{% endif %}">
                            <span class="nav-text">Nouveau Client</span>
                        </a>
                    </div>
                </div>
            </div>

            <!-- Services Section -->
            <div class="nav-section">
                <div class="nav-section-title">Services</div>

                <!-- Deposits -->
                <div class="nav-item {% if 'deposits' in request.path %}open{% endif %}" id="nav-deposits">
                    <a href="#" class="nav-link" onclick="toggleSubmenu('nav-deposits'); return false;">
                        <i class="fas fa-wallet nav-icon"></i>
                        <span class="nav-text">Dépôts Clients</span>
                        <i class="fas fa-chevron-right nav-chevron"></i>
                    </a>
                    <div class="nav-submenu">
                        <a href="{% url 'deposits:list' %}" class="nav-link {% if request.resolver_match.url_name == 'list' and 'deposits' in request.path %}active{% endif %}">
                            <span class="nav-text">Tous les Comptes</span>
                        </a>
                        <a href="{% url 'deposits:create' %}" class="nav-link {% if request.resolver_match.url_name == 'create' and 'deposits' in request.path %}active{% endif %}">
                            <span class="nav-text">Nouveau Compte</span>
                        </a>
                    </div>
                </div>

                <!-- Quotes -->
                <div class="nav-item {% if 'quotes' in request.path %}open{% endif %}" id="nav-quotes">
                    <a href="#" class="nav-link" onclick="toggleSubmenu('nav-quotes'); return false;">
                        <i class="fas fa-file-invoice nav-icon"></i>
                        <span class="nav-text">Devis</span>
                        <i class="fas fa-chevron-right nav-chevron"></i>
                    </a>
                    <div class="nav-submenu">
                        <a href="{% url 'quotes:quote_list' %}" class="nav-link">
                            <span class="nav-text">Tous les Devis</span>
                        </a>
                        <a href="{% url 'quotes:quote_create' %}" class="nav-link">
                            <span class="nav-text">Nouveau Devis</span>
                        </a>
                    </div>
                </div>

                <!-- Repairs -->
                <div class="nav-item {% if 'repairs' in request.path %}open{% endif %}" id="nav-repairs">
                    <a href="#" class="nav-link" onclick="toggleSubmenu('nav-repairs'); return false;">
                        <i class="fas fa-wrench nav-icon"></i>
                        <span class="nav-text">Reparations</span>
                        <i class="fas fa-chevron-right nav-chevron"></i>
                    </a>
                    <div class="nav-submenu">
                        <a href="{% url 'repairs:repair_list' %}" class="nav-link">
                            <span class="nav-text">Toutes les Reparations</span>
                        </a>
                        <a href="{% url 'repairs:repair_create' %}" class="nav-link">
                            <span class="nav-text">Nouvelle Reparation</span>
                        </a>
                    </div>
                </div>

            </div>

            {% if user.is_staff %}
            <!-- Admin Section -->
            <div class="nav-section">
                <div class="nav-section-title">Administration</div>

                <div class="nav-item">
                    <a href="{% url 'admin_dashboard:home' %}" class="nav-link {% if 'admin-dashboard' in request.path %}active{% endif %}">
                        <i class="fas fa-sliders-h nav-icon"></i>
                        <span class="nav-text">Panneau Admin</span>
                    </a>
                </div>

                <div class="nav-item">
                    <a href="{% url 'users:user_list' %}" class="nav-link {% if 'users' in request.path and 'list' in request.path %}active{% endif %}">
                        <i class="fas fa-user-cog nav-icon"></i>
                        <span class="nav-text">Utilisateurs</span>
                    </a>
                </div>
            </div>
            {% endif %}
        </nav>

        <!-- Sidebar Footer -->
        <div class="sidebar-footer">
            <a href="{% url 'logout' %}" class="btn btn-ghost" style="width: 100%; justify-content: flex-start;">
                <i class="fas fa-sign-out-alt"></i>
                <span>Deconnexion</span>
            </a>
        </div>
    </aside>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Navigation Bar -->
        <header class="navbar">
            <div class="navbar-inner">
                <div class="navbar-left">
                    <!-- Mobile Menu Toggle -->
                    <button class="sidebar-toggle" id="sidebarToggle" onclick="toggleSidebar()">
                        <i class="fas fa-bars"></i>
                    </button>

                    <!-- Search Bar -->
                    <div class="search-wrapper">
                        <i class="fas fa-search search-icon"></i>
                        <input type="text" class="search-input" id="globalSearchInput" placeholder="Rechercher produits, clients, factures..." autocomplete="off">
                        <button type="button" class="barcode-scan-btn" onclick="openBarcodeScanner()" title="Scanner code-barres">
                            <i class="fas fa-barcode"></i>
                        </button>
                    </div>
                </div>

                <div class="navbar-right">
                    <!-- Notifications -->
                    <button class="navbar-action" title="Notifications">
                        <i class="fas fa-bell"></i>
                        <span class="badge-dot"></span>
                    </button>

                    <!-- Quick Add -->
                    <a href="{% url 'sales:invoice_create' %}" class="navbar-action" title="Nouvelle Vente" style="display: none;">
                        <i class="fas fa-plus"></i>
                    </a>

                    <!-- User Menu -->
                    <div class="user-menu" id="userMenu">
                        <button class="user-menu-trigger" onclick="toggleUserMenu()">
                            <div class="user-avatar">
                                {% if user.first_name %}{{ user.first_name|slice:":1"|upper }}{{ user.last_name|slice:":1"|upper }}{% else %}{{ user.username|slice:":2"|upper }}{% endif %}
                            </div>
                            <div class="user-info">
                                <div class="user-name">{% if user.first_name %}{{ user.first_name }} {{ user.last_name }}{% else %}{{ user.username }}{% endif %}</div>
                                <div class="user-role">{% if user.is_staff %}Administrateur{% else %}Utilisateur{% endif %}</div>
                            </div>
                            <i class="fas fa-chevron-down" style="color: var(--neutral-400); font-size: var(--text-xs);"></i>
                        </button>

                        <div class="dropdown-menu" id="userDropdown">
                            <a href="{% url 'users:profile' %}" class="dropdown-item">
                                <i class="fas fa-user-circle"></i>
                                <span>Mon Profil</span>
                            </a>
                            <a href="{% url 'users:profile_edit' %}" class="dropdown-item">
                                <i class="fas fa-cog"></i>
                                <span>Parametres</span>
                            </a>
                            {% if user.is_staff %}
                            <a href="{% url 'admin_dashboard:home' %}" class="dropdown-item">
                                <i class="fas fa-sliders-h"></i>
                                <span>Administration</span>
                            </a>
                            {% endif %}
                            <div class="dropdown-divider"></div>
                            <a href="{% url 'logout' %}" class="dropdown-item danger">
                                <i class="fas fa-sign-out-alt"></i>
                                <span>Deconnexion</span>
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Page Content -->
        <main class="page-wrapper">
            <!-- Breadcrumb -->
            <nav class="breadcrumb">
                <div class="breadcrumb-item">
                    <a href="{% url 'dashboard' %}"><i class="fas fa-home"></i></a>
                </div>
                {% block breadcrumb %}{% endblock %}
            </nav>

            <!-- Page Header -->
            {% block page_header %}{% endblock %}

            <!-- Alerts -->
            {% if messages %}
                {% for message in messages %}
                    <div class="alert {% if message.tags == 'error' %}alert-error{% elif message.tags == 'success' %}alert-success{% elif message.tags == 'warning' %}alert-warning{% else %}alert-info{% endif %} animate-slide-down">
                        <i class="alert-icon fas {% if message.tags == 'error' %}fa-exclamation-circle{% elif message.tags == 'success' %}fa-check-circle{% elif message.tags == 'warning' %}fa-exclamation-triangle{% else %}fa-info-circle{% endif %}"></i>
                        <div class="alert-content">
                            <p class="alert-message">{{ message }}</p>
                        </div>
                        <button type="button" class="alert-close" onclick="this.parentElement.remove()">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                {% endfor %}
            {% endif %}

            <!-- Main Content -->
            {% block content %}{% endblock %}
        </main>
    </div>

    <!-- Barcode Scanner Modal -->
    <div class="scanner-modal" id="scannerModal">
        <button class="scanner-close" onclick="closeBarcodeScanner()">
            <i class="fas fa-times"></i>
        </button>
        <div class="scanner-container" id="scannerContainer">
            <div id="scannerVideoContainer"></div>
            <div class="scanner-overlay">
                <div class="scanner-line"></div>
            </div>
        </div>
        <!-- Manual input fallback -->
        <div class="scanner-manual" id="scannerManual" style="display: none;">
            <div style="background: white; padding: 24px; border-radius: 12px; width: 90%; max-width: 400px;">
                <h3 style="margin: 0 0 16px; color: #333;"><i class="fas fa-keyboard" style="margin-right: 8px;"></i> Saisie manuelle</h3>
                <p style="color: #666; margin-bottom: 16px; font-size: 14px;">Camera non disponible. Entrez le code-barres ou reference manuellement:</p>
                <input type="text" id="manualBarcodeInput" class="form-control" placeholder="Ex: 20260209-0004" style="font-size: 18px; padding: 12px; margin-bottom: 16px;">
                <div style="display: flex; gap: 12px;">
                    <button type="button" class="btn btn-secondary" onclick="closeBarcodeScanner()" style="flex: 1;">Annuler</button>
                    <button type="button" class="btn btn-primary" onclick="searchManualBarcode()" style="flex: 1;"><i class="fas fa-search"></i> Rechercher</button>
                </div>
            </div>
        </div>
        <div class="scanner-status" id="scannerStatus">Positionnez le code-barres dans le cadre</div>
        <div class="scanner-result" id="scannerResult" style="display: none;"></div>
    </div>

    <!-- Mobile Bottom Navigation -->
    <nav class="mobile-bottom-nav">
        <a href="{% url 'dashboard' %}" class="mobile-nav-item {% if request.resolver_match.url_name == 'dashboard' %}active{% endif %}">
            <i class="fas fa-home"></i>
            <span>Accueil</span>
        </a>
        <a href="#" class="mobile-nav-item" onclick="openBarcodeScanner(); return false;">
            <i class="fas fa-barcode"></i>
            <span>Scanner</span>
        </a>
        <a href="{% url 'sales:invoice_create' %}" class="mobile-nav-item" style="background: var(--primary-500); color: white; border-radius: var(--radius-full); margin: -10px 0;">
            <i class="fas fa-plus"></i>
            <span>Vendre</span>
        </a>
        <a href="{% url 'products:list' %}" class="mobile-nav-item {% if 'products' in request.path %}active{% endif %}">
            <i class="fas fa-gem"></i>
            <span>Produits</span>
        </a>
        <a href="#" class="mobile-nav-item" onclick="toggleSidebar(); return false;">
            <i class="fas fa-bars"></i>
            <span>Menu</span>
        </a>
    </nav>

    <!-- Bootstrap JS (for modals) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- QuaggaJS for barcode scanning -->
    <script src="https://cdn.jsdelivr.net/npm/@ericblade/quagga2@1.8.4/dist/quagga.min.js"></script>

    <!-- Mobile-Friendly Forms JavaScript -->
    <script src="{% static 'js/mobile-forms.js' %}"></script>

    <!-- Form Validation JavaScript -->
    <script src="{% static 'js/form-validation.js' %}"></script>

    <!-- Field Dependencies JavaScript -->
    <script src="{% static 'js/field-dependencies.js' %}"></script>

    <script>
        // Sidebar toggle functionality
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            sidebar.classList.toggle('open');
            overlay.classList.toggle('show');
            document.body.style.overflow = sidebar.classList.contains('open') ? 'hidden' : '';
        }

        function closeSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            sidebar.classList.remove('open');
            overlay.classList.remove('show');
            document.body.style.overflow = '';
        }

        // Submenu toggle
        function toggleSubmenu(navItemId) {
            const navItem = document.getElementById(navItemId);
            const wasOpen = navItem.classList.contains('open');

            // Close all other submenus on mobile
            if (window.innerWidth < 1024) {
                document.querySelectorAll('.nav-item.open').forEach(item => {
                    if (item.id !== navItemId) {
                        item.classList.remove('open');
                    }
                });
            }

            navItem.classList.toggle('open');
        }

        // User dropdown toggle
        function toggleUserMenu() {
            const dropdown = document.getElementById('userDropdown');
            dropdown.classList.toggle('show');
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', function(event) {
            const userMenu = document.getElementById('userMenu');
            const dropdown = document.getElementById('userDropdown');

            if (userMenu && !userMenu.contains(event.target)) {
                dropdown.classList.remove('show');
            }
        });

        // Close sidebar on window resize if open
        window.addEventListener('resize', function() {
            if (window.innerWidth > 1023) {
                closeSidebar();
            }
        });

        // Handle escape key to close sidebar
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                closeSidebar();
                document.getElementById('userDropdown').classList.remove('show');
            }
        });

        // Auto-dismiss alerts after 5 seconds
        document.addEventListener('DOMContentLoaded', function() {
            const alerts = document.querySelectorAll('.alert');
            alerts.forEach(function(alert) {
                setTimeout(function() {
                    alert.style.opacity = '0';
                    alert.style.transform = 'translateY(-10px)';
                    setTimeout(function() {
                        alert.remove();
                    }, 300);
                }, 5000);
            });
        });

        // Barcode Scanner Functions
        let scannerActive = false;

        function openBarcodeScanner() {
            const modal = document.getElementById('scannerModal');
            const status = document.getElementById('scannerStatus');
            const result = document.getElementById('scannerResult');
            const scannerContainer = document.getElementById('scannerContainer');
            const manualInput = document.getElementById('scannerManual');

            modal.classList.add('active');
            status.textContent = 'Initialisation de la camera...';
            result.style.display = 'none';
            scannerContainer.style.display = 'block';
            manualInput.style.display = 'none';

            // Check if we're on HTTPS or localhost (required for camera)
            const isSecure = location.protocol === 'https:' || location.hostname === 'localhost' || location.hostname === '127.0.0.1';

            if (!isSecure) {
                showManualInput('Camera requiert HTTPS. Utilisez la saisie manuelle.');
                return;
            }

            // Initialize Quagga with live stream auto-detection
            Quagga.init({
                inputStream: {
                    name: "Live",
                    type: "LiveStream",
                    target: document.querySelector('#scannerVideoContainer'),
                    constraints: {
                        facingMode: "environment",
                        width: { min: 640, ideal: 1280, max: 1920 },
                        height: { min: 480, ideal: 720, max: 1080 }
                    }
                },
                locator: {
                    patchSize: "small",
                    halfSample: false
                },
                frequency: 10,
                numOfWorkers: navigator.hardwareConcurrency || 4,
                decoder: {
                    readers: [
                        "code_128_reader",
                        "ean_reader",
                        "ean_8_reader",
                        "code_39_reader",
                        "code_39_vin_reader",
                        "codabar_reader",
                        "upc_reader",
                        "upc_e_reader",
                        "i2of5_reader"
                    ]
                },
                locate: true
            }, function(err) {
                if (err) {
                    console.error('Scanner error:', err);
                    showManualInput('Camera non disponible. Utilisez la saisie manuelle.');
                    return;
                }
                Quagga.start();
                scannerActive = true;
                status.textContent = 'Positionnez le code-barres dans le cadre';
            });

            // Handle automatic barcode detection
            Quagga.onDetected(function(data) {
                if (!scannerActive) return;

                const code = data.codeResult.code;
                console.log('Barcode detected:', code);

                // Success feedback
                if (navigator.vibrate) navigator.vibrate(200);

                const resultDiv = document.getElementById('scannerResult');
                resultDiv.textContent = 'Code: ' + code;
                resultDiv.style.display = 'block';
                resultDiv.style.background = '#4CAF50';
                status.textContent = 'Code detecte! Recherche...';

                // Stop scanner and search
                scannerActive = false;
                Quagga.stop();
                searchProductByBarcode(code);
            });
        }

        function showManualInput(message) {
            const scannerContainer = document.getElementById('scannerContainer');
            const manualInput = document.getElementById('scannerManual');
            const status = document.getElementById('scannerStatus');

            if (scannerActive) {
                Quagga.stop();
                scannerActive = false;
            }
            scannerContainer.style.display = 'none';
            manualInput.style.display = 'flex';
            manualInput.style.justifyContent = 'center';
            manualInput.style.alignItems = 'center';
            manualInput.style.height = '100%';
            status.textContent = message;

            setTimeout(() => {
                document.getElementById('manualBarcodeInput').focus();
            }, 100);
        }

        function searchManualBarcode() {
            const input = document.getElementById('manualBarcodeInput');
            const code = input.value.trim();

            if (!code) {
                input.focus();
                return;
            }

            const status = document.getElementById('scannerStatus');
            const result = document.getElementById('scannerResult');

            result.textContent = 'Code: ' + code;
            result.style.display = 'block';
            result.style.background = '#4CAF50';
            status.textContent = 'Recherche du produit...';

            searchProductByBarcode(code);
        }

        // Handle Enter key in manual input
        document.addEventListener('DOMContentLoaded', function() {
            const manualInput = document.getElementById('manualBarcodeInput');
            if (manualInput) {
                manualInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        searchManualBarcode();
                    }
                });
            }
        });

        function closeBarcodeScanner() {
            const modal = document.getElementById('scannerModal');
            modal.classList.remove('active');

            const manualInput = document.getElementById('manualBarcodeInput');
            if (manualInput) manualInput.value = '';

            if (scannerActive) {
                Quagga.stop();
                scannerActive = false;
            }
        }

        async function searchProductByBarcode(code) {
            const status = document.getElementById('scannerStatus');
            const result = document.getElementById('scannerResult');

            try {
                const response = await fetch(`/products/api/search/?q=${encodeURIComponent(code)}`);
                const data = await response.json();

                if (data.products && data.products.length > 0) {
                    const product = data.products[0];
                    status.textContent = 'Produit trouve! Redirection...';
                    result.textContent = product.reference + ' - ' + product.name;

                    setTimeout(() => {
                        window.location.href = `/products/${product.reference}/`;
                    }, 1000);
                } else {
                    status.textContent = 'Aucun produit trouve pour ce code';
                    result.style.background = '#FF9800';
                    result.textContent = 'Code: ' + code + ' - Non trouve';

                    setTimeout(() => {
                        closeBarcodeScanner();
                    }, 2000);
                }
            } catch (error) {
                console.error('Search error:', error);
                status.textContent = 'Erreur de recherche';

                setTimeout(() => {
                    closeBarcodeScanner();
                }, 2000);
            }
        }

        // Handle escape key to close scanner
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape' && document.getElementById('scannerModal').classList.contains('active')) {
                closeBarcodeScanner();
            }
        });



        // Handle escape key to close scanner
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape' && document.getElementById('scannerModal').classList.contains('active')) {
                closeBarcodeScanner();
            }
        });
    </script>

    {% block extra_js %}{% endblock %}
</body>
</html>
