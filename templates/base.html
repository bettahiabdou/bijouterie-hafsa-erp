{% load static %}
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Bijouterie Hafsa - ERP{% endblock %}</title>

    <!-- Modern Design System -->
    <link rel="stylesheet" href="{% static 'css/design-system.css' %}">
    <link rel="stylesheet" href="{% static 'css/mobile-forms.css' %}">

    <!-- Bootstrap CSS (for modals only) -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* Enhanced Responsive Sidebar Styles */
        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            bottom: 0;
            width: var(--sidebar-width);
            background: white;
            border-right: 1px solid var(--neutral-200);
            display: flex;
            flex-direction: column;
            z-index: var(--z-fixed);
            transition: transform var(--transition-slow), width var(--transition-slow);
            overflow: hidden;
        }

        /* Mobile Sidebar - Hidden by default */
        @media (max-width: 1023px) {
            .sidebar {
                transform: translateX(-100%);
                box-shadow: var(--shadow-2xl);
            }

            .sidebar.open {
                transform: translateX(0);
            }

            .main-content {
                margin-left: 0 !important;
            }

            .sidebar-toggle {
                display: flex !important;
            }
        }

        /* Tablet adjustments */
        @media (min-width: 768px) and (max-width: 1023px) {
            .page-wrapper {
                padding: var(--space-6);
            }
        }

        /* Mobile adjustments */
        @media (max-width: 767px) {
            :root {
                --navbar-height: 64px;
            }

            .navbar {
                padding: 0 var(--space-4);
            }

            .search-wrapper {
                display: none;
            }

            .user-info {
                display: none;
            }

            .page-wrapper {
                padding: var(--space-4);
            }

            .page-header-inner {
                flex-direction: column;
                align-items: stretch;
                gap: var(--space-4);
            }

            .page-actions {
                flex-direction: column;
            }

            .page-actions .btn {
                width: 100%;
                justify-content: center;
            }

            /* Mobile grid adjustments */
            .grid-cols-2,
            .grid-cols-3,
            .grid-cols-4 {
                grid-template-columns: 1fr !important;
            }

            /* Mobile stat cards */
            .stat-card {
                padding: var(--space-4);
            }

            .stat-value {
                font-size: var(--text-2xl);
            }

            /* Mobile cards */
            .card-body {
                padding: var(--space-4);
            }

            .card-header {
                padding: var(--space-4);
                flex-direction: column;
                align-items: flex-start;
                gap: var(--space-3);
            }

            .card-footer {
                padding: var(--space-4);
                flex-direction: column;
                gap: var(--space-3);
            }

            /* Mobile tables */
            .table-wrapper {
                margin: 0 calc(var(--space-4) * -1);
                border-radius: 0;
                border-left: none;
                border-right: none;
            }

            .table th,
            .table td {
                padding: var(--space-3);
                font-size: var(--text-xs);
            }

            /* Mobile forms */
            .form-row,
            .form-row-3 {
                grid-template-columns: 1fr !important;
            }

            .btn-group {
                flex-direction: column;
            }

            .btn-group .btn {
                width: 100%;
            }

            /* Mobile breadcrumb */
            .breadcrumb {
                display: none;
            }
        }

        /* Overlay for mobile sidebar */
        .sidebar-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
            z-index: calc(var(--z-fixed) - 1);
            opacity: 0;
            visibility: hidden;
            transition: all var(--transition-base);
        }

        .sidebar-overlay.show {
            opacity: 1;
            visibility: visible;
        }

        /* Mobile bottom navigation (optional) */
        .mobile-bottom-nav {
            display: none;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-top: 1px solid var(--neutral-200);
            padding: var(--space-2) var(--space-4);
            z-index: var(--z-sticky);
            box-shadow: 0 -4px 6px -1px rgb(0 0 0 / 0.1);
        }

        @media (max-width: 767px) {
            .mobile-bottom-nav {
                display: flex;
                justify-content: space-around;
                align-items: center;
            }

            .page-wrapper {
                padding-bottom: calc(var(--space-4) + 70px);
            }
        }

        .mobile-nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: var(--space-1);
            padding: var(--space-2);
            color: var(--neutral-500);
            text-decoration: none;
            font-size: var(--text-xs);
            transition: color var(--transition-fast);
            min-width: 60px;
        }

        .mobile-nav-item:hover,
        .mobile-nav-item.active {
            color: var(--primary-600);
        }

        .mobile-nav-item i {
            font-size: var(--text-lg);
        }

        /* Enhanced sidebar toggle button */
        .sidebar-toggle {
            display: none;
            width: 44px;
            height: 44px;
            border-radius: var(--radius-lg);
            border: none;
            background: transparent;
            color: var(--neutral-600);
            cursor: pointer;
            transition: all var(--transition-fast);
            align-items: center;
            justify-content: center;
        }

        .sidebar-toggle:hover {
            background: var(--neutral-100);
            color: var(--neutral-900);
        }

        /* Sidebar close button for mobile */
        .sidebar-close {
            display: none;
            position: absolute;
            top: var(--space-4);
            right: var(--space-4);
            width: 36px;
            height: 36px;
            border-radius: var(--radius-full);
            border: none;
            background: var(--neutral-100);
            color: var(--neutral-600);
            cursor: pointer;
            transition: all var(--transition-fast);
            align-items: center;
            justify-content: center;
            z-index: 10;
        }

        .sidebar-close:hover {
            background: var(--neutral-200);
            color: var(--neutral-900);
        }

        @media (max-width: 1023px) {
            .sidebar-close {
                display: flex;
            }
        }

        /* Fix for small screens nav sections */
        @media (max-width: 1023px) {
            .nav-section-title {
                padding: 0 var(--space-4);
            }
        }
    </style>

    {% block extra_css %}{% endblock %}
</head>
<body>
    <!-- Sidebar Overlay (mobile) -->
    <div class="sidebar-overlay" id="sidebarOverlay" onclick="closeSidebar()"></div>

    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
        <!-- Close button for mobile -->
        <button class="sidebar-close" onclick="closeSidebar()">
            <i class="fas fa-times"></i>
        </button>

        <!-- Sidebar Header -->
        <div class="sidebar-header">
            <a href="{% url 'dashboard' %}" class="sidebar-brand">
                <div class="sidebar-logo">HF</div>
                <div class="sidebar-brand-text">
                    <div class="sidebar-brand-name">Bijouterie Hafsa</div>
                    <div class="sidebar-brand-subtitle">Gestion d'Entreprise</div>
                </div>
            </a>
        </div>

        <!-- Sidebar Navigation -->
        <nav class="sidebar-nav">
            <!-- Main Section -->
            <div class="nav-section">
                <div class="nav-section-title">Menu Principal</div>

                <!-- Dashboard -->
                <div class="nav-item">
                    <a href="{% url 'dashboard' %}" class="nav-link {% if request.resolver_match.url_name == 'dashboard' %}active{% endif %}">
                        <i class="fas fa-home nav-icon"></i>
                        <span class="nav-text">Tableau de Bord</span>
                    </a>
                </div>

                <!-- Products -->
                <div class="nav-item {% if 'products' in request.path %}open{% endif %}" id="nav-products">
                    <a href="#" class="nav-link" onclick="toggleSubmenu('nav-products'); return false;">
                        <i class="fas fa-gem nav-icon"></i>
                        <span class="nav-text">Produits</span>
                        <i class="fas fa-chevron-right nav-chevron"></i>
                    </a>
                    <div class="nav-submenu">
                        <a href="{% url 'products:inventory_dashboard' %}" class="nav-link {% if 'inventory' in request.path %}active{% endif %}">
                            <span class="nav-text">Inventaire</span>
                        </a>
                        <a href="{% url 'products:list' %}" class="nav-link {% if request.resolver_match.url_name == 'list' and 'products' in request.path %}active{% endif %}">
                            <span class="nav-text">Tous les Produits</span>
                        </a>
                        <a href="{% url 'products:create' %}" class="nav-link {% if 'create' in request.path and 'products' in request.path %}active{% endif %}">
                            <span class="nav-text">Nouveau Produit</span>
                        </a>
                        <a href="{% url 'products:batch_create' %}" class="nav-link">
                            <span class="nav-text">Ajout en Lot</span>
                        </a>
                    </div>
                </div>

                <!-- Sales -->
                <div class="nav-item {% if 'sales' in request.path %}open{% endif %}" id="nav-sales">
                    <a href="#" class="nav-link" onclick="toggleSubmenu('nav-sales'); return false;">
                        <i class="fas fa-shopping-cart nav-icon"></i>
                        <span class="nav-text">Ventes</span>
                        <i class="fas fa-chevron-right nav-chevron"></i>
                    </a>
                    <div class="nav-submenu">
                        <a href="{% url 'sales:invoice_create' %}" class="nav-link {% if 'create' in request.path and 'sales' in request.path %}active{% endif %}">
                            <span class="nav-text">Nouvelle Facture</span>
                        </a>
                        <a href="{% url 'sales:bulk_create' %}" class="nav-link">
                            <span class="nav-text">Facturation en Lot</span>
                        </a>
                        <a href="{% url 'sales:pending_invoices' %}" class="nav-link {% if 'pending' in request.path and 'sales' in request.path %}active{% endif %}">
                            <i class="fas fa-clock text-warning" style="margin-right: 6px;"></i>
                            <span class="nav-text">En Attente (Telegram)</span>
                        </a>
                        <a href="{% url 'sales:invoice_list' %}" class="nav-link {% if 'list' in request.path and 'sales' in request.path %}active{% endif %}">
                            <span class="nav-text">Historique</span>
                        </a>
                    </div>
                </div>

                <!-- Purchases -->
                <div class="nav-item {% if 'purchases' in request.path %}open{% endif %}" id="nav-purchases">
                    <a href="#" class="nav-link" onclick="toggleSubmenu('nav-purchases'); return false;">
                        <i class="fas fa-boxes nav-icon"></i>
                        <span class="nav-text">Achats</span>
                        <i class="fas fa-chevron-right nav-chevron"></i>
                    </a>
                    <div class="nav-submenu">
                        <a href="{% url 'purchases:purchase_order_list' %}" class="nav-link">
                            <span class="nav-text">Commandes</span>
                        </a>
                        <a href="{% url 'purchases:purchase_invoice_list' %}" class="nav-link">
                            <span class="nav-text">Factures d'Achat</span>
                        </a>
                        <a href="{% url 'purchases:consignment_list' %}" class="nav-link">
                            <span class="nav-text">Consignations</span>
                        </a>
                    </div>
                </div>

                <!-- Suppliers -->
                <div class="nav-item {% if 'suppliers' in request.path %}open{% endif %}" id="nav-suppliers">
                    <a href="#" class="nav-link" onclick="toggleSubmenu('nav-suppliers'); return false;">
                        <i class="fas fa-industry nav-icon"></i>
                        <span class="nav-text">Fournisseurs</span>
                        <i class="fas fa-chevron-right nav-chevron"></i>
                    </a>
                    <div class="nav-submenu">
                        <a href="{% url 'suppliers:list' %}" class="nav-link">
                            <span class="nav-text">Tous les Fournisseurs</span>
                        </a>
                        <a href="{% url 'suppliers:create' %}" class="nav-link">
                            <span class="nav-text">Nouveau Fournisseur</span>
                        </a>
                    </div>
                </div>

                <!-- Clients -->
                <div class="nav-item {% if 'clients' in request.path %}open{% endif %}" id="nav-clients">
                    <a href="#" class="nav-link" onclick="toggleSubmenu('nav-clients'); return false;">
                        <i class="fas fa-users nav-icon"></i>
                        <span class="nav-text">Clients</span>
                        <i class="fas fa-chevron-right nav-chevron"></i>
                    </a>
                    <div class="nav-submenu">
                        <a href="{% url 'clients:list' %}" class="nav-link {% if request.resolver_match.url_name == 'list' and 'clients' in request.path %}active{% endif %}">
                            <span class="nav-text">Tous les Clients</span>
                        </a>
                        <a href="{% url 'clients:create' %}" class="nav-link {% if request.resolver_match.url_name == 'create' and 'clients' in request.path %}active{% endif %}">
                            <span class="nav-text">Nouveau Client</span>
                        </a>
                    </div>
                </div>
            </div>

            <!-- Services Section -->
            <div class="nav-section">
                <div class="nav-section-title">Services</div>

                <!-- Deposits -->
                <div class="nav-item {% if 'deposits' in request.path %}open{% endif %}" id="nav-deposits">
                    <a href="#" class="nav-link" onclick="toggleSubmenu('nav-deposits'); return false;">
                        <i class="fas fa-wallet nav-icon"></i>
                        <span class="nav-text">Dépôts Clients</span>
                        <i class="fas fa-chevron-right nav-chevron"></i>
                    </a>
                    <div class="nav-submenu">
                        <a href="{% url 'deposits:list' %}" class="nav-link {% if request.resolver_match.url_name == 'list' and 'deposits' in request.path %}active{% endif %}">
                            <span class="nav-text">Tous les Comptes</span>
                        </a>
                        <a href="{% url 'deposits:create' %}" class="nav-link {% if request.resolver_match.url_name == 'create' and 'deposits' in request.path %}active{% endif %}">
                            <span class="nav-text">Nouveau Compte</span>
                        </a>
                    </div>
                </div>

                <!-- Quotes -->
                <div class="nav-item {% if 'quotes' in request.path %}open{% endif %}" id="nav-quotes">
                    <a href="#" class="nav-link" onclick="toggleSubmenu('nav-quotes'); return false;">
                        <i class="fas fa-file-invoice nav-icon"></i>
                        <span class="nav-text">Devis</span>
                        <i class="fas fa-chevron-right nav-chevron"></i>
                    </a>
                    <div class="nav-submenu">
                        <a href="{% url 'quotes:quote_list' %}" class="nav-link">
                            <span class="nav-text">Tous les Devis</span>
                        </a>
                        <a href="{% url 'quotes:quote_create' %}" class="nav-link">
                            <span class="nav-text">Nouveau Devis</span>
                        </a>
                    </div>
                </div>

                <!-- Repairs -->
                <div class="nav-item {% if 'repairs' in request.path %}open{% endif %}" id="nav-repairs">
                    <a href="#" class="nav-link" onclick="toggleSubmenu('nav-repairs'); return false;">
                        <i class="fas fa-wrench nav-icon"></i>
                        <span class="nav-text">Reparations</span>
                        <i class="fas fa-chevron-right nav-chevron"></i>
                    </a>
                    <div class="nav-submenu">
                        <a href="{% url 'repairs:repair_list' %}" class="nav-link">
                            <span class="nav-text">Toutes les Reparations</span>
                        </a>
                        <a href="{% url 'repairs:repair_create' %}" class="nav-link">
                            <span class="nav-text">Nouvelle Reparation</span>
                        </a>
                    </div>
                </div>

            </div>

            {% if user.is_staff %}
            <!-- Admin Section -->
            <div class="nav-section">
                <div class="nav-section-title">Administration</div>

                <div class="nav-item">
                    <a href="{% url 'admin_dashboard:home' %}" class="nav-link {% if 'admin-dashboard' in request.path %}active{% endif %}">
                        <i class="fas fa-sliders-h nav-icon"></i>
                        <span class="nav-text">Panneau Admin</span>
                    </a>
                </div>

                <div class="nav-item">
                    <a href="{% url 'users:user_list' %}" class="nav-link {% if 'users' in request.path and 'list' in request.path %}active{% endif %}">
                        <i class="fas fa-user-cog nav-icon"></i>
                        <span class="nav-text">Utilisateurs</span>
                    </a>
                </div>
            </div>
            {% endif %}
        </nav>

        <!-- Sidebar Footer -->
        <div class="sidebar-footer">
            <a href="{% url 'logout' %}" class="btn btn-ghost" style="width: 100%; justify-content: flex-start;">
                <i class="fas fa-sign-out-alt"></i>
                <span>Deconnexion</span>
            </a>
        </div>
    </aside>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Navigation Bar -->
        <header class="navbar">
            <div class="navbar-inner">
                <div class="navbar-left">
                    <!-- Mobile Menu Toggle -->
                    <button class="sidebar-toggle" id="sidebarToggle" onclick="toggleSidebar()">
                        <i class="fas fa-bars"></i>
                    </button>

                    <!-- Search Bar -->
                    <div class="search-wrapper">
                        <i class="fas fa-search search-icon"></i>
                        <input type="text" class="search-input" placeholder="Rechercher produits, clients, factures...">
                    </div>
                </div>

                <div class="navbar-right">
                    <!-- Notifications -->
                    <button class="navbar-action" title="Notifications">
                        <i class="fas fa-bell"></i>
                        <span class="badge-dot"></span>
                    </button>

                    <!-- Quick Add -->
                    <a href="{% url 'sales:invoice_create' %}" class="navbar-action" title="Nouvelle Vente" style="display: none;">
                        <i class="fas fa-plus"></i>
                    </a>

                    <!-- User Menu -->
                    <div class="user-menu" id="userMenu">
                        <button class="user-menu-trigger" onclick="toggleUserMenu()">
                            <div class="user-avatar">
                                {% if user.first_name %}{{ user.first_name|slice:":1"|upper }}{{ user.last_name|slice:":1"|upper }}{% else %}{{ user.username|slice:":2"|upper }}{% endif %}
                            </div>
                            <div class="user-info">
                                <div class="user-name">{% if user.first_name %}{{ user.first_name }} {{ user.last_name }}{% else %}{{ user.username }}{% endif %}</div>
                                <div class="user-role">{% if user.is_staff %}Administrateur{% else %}Utilisateur{% endif %}</div>
                            </div>
                            <i class="fas fa-chevron-down" style="color: var(--neutral-400); font-size: var(--text-xs);"></i>
                        </button>

                        <div class="dropdown-menu" id="userDropdown">
                            <a href="{% url 'users:profile' %}" class="dropdown-item">
                                <i class="fas fa-user-circle"></i>
                                <span>Mon Profil</span>
                            </a>
                            <a href="{% url 'users:profile_edit' %}" class="dropdown-item">
                                <i class="fas fa-cog"></i>
                                <span>Parametres</span>
                            </a>
                            {% if user.is_staff %}
                            <a href="{% url 'admin_dashboard:home' %}" class="dropdown-item">
                                <i class="fas fa-sliders-h"></i>
                                <span>Administration</span>
                            </a>
                            {% endif %}
                            <div class="dropdown-divider"></div>
                            <a href="{% url 'logout' %}" class="dropdown-item danger">
                                <i class="fas fa-sign-out-alt"></i>
                                <span>Deconnexion</span>
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Page Content -->
        <main class="page-wrapper">
            <!-- Breadcrumb -->
            <nav class="breadcrumb">
                <div class="breadcrumb-item">
                    <a href="{% url 'dashboard' %}"><i class="fas fa-home"></i></a>
                </div>
                {% block breadcrumb %}{% endblock %}
            </nav>

            <!-- Page Header -->
            {% block page_header %}{% endblock %}

            <!-- Alerts -->
            {% if messages %}
                {% for message in messages %}
                    <div class="alert {% if message.tags == 'error' %}alert-error{% elif message.tags == 'success' %}alert-success{% elif message.tags == 'warning' %}alert-warning{% else %}alert-info{% endif %} animate-slide-down">
                        <i class="alert-icon fas {% if message.tags == 'error' %}fa-exclamation-circle{% elif message.tags == 'success' %}fa-check-circle{% elif message.tags == 'warning' %}fa-exclamation-triangle{% else %}fa-info-circle{% endif %}"></i>
                        <div class="alert-content">
                            <p class="alert-message">{{ message }}</p>
                        </div>
                        <button type="button" class="alert-close" onclick="this.parentElement.remove()">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                {% endfor %}
            {% endif %}

            <!-- Main Content -->
            {% block content %}{% endblock %}
        </main>
    </div>

    <!-- Mobile Bottom Navigation -->
    <nav class="mobile-bottom-nav">
        <a href="{% url 'dashboard' %}" class="mobile-nav-item {% if request.resolver_match.url_name == 'dashboard' %}active{% endif %}">
            <i class="fas fa-home"></i>
            <span>Accueil</span>
        </a>
        <a href="{% url 'products:list' %}" class="mobile-nav-item {% if 'products' in request.path %}active{% endif %}">
            <i class="fas fa-gem"></i>
            <span>Produits</span>
        </a>
        <a href="{% url 'sales:invoice_create' %}" class="mobile-nav-item" style="background: var(--primary-500); color: white; border-radius: var(--radius-full); margin: -10px 0;">
            <i class="fas fa-plus"></i>
            <span>Vendre</span>
        </a>
        <a href="{% url 'sales:invoice_list' %}" class="mobile-nav-item {% if 'sales' in request.path %}active{% endif %}">
            <i class="fas fa-receipt"></i>
            <span>Ventes</span>
        </a>
        <a href="#" class="mobile-nav-item" onclick="toggleSidebar(); return false;">
            <i class="fas fa-bars"></i>
            <span>Menu</span>
        </a>
    </nav>

    <!-- Bootstrap JS (for modals) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Mobile-Friendly Forms JavaScript -->
    <script src="{% static 'js/mobile-forms.js' %}"></script>

    <!-- Form Validation JavaScript -->
    <script src="{% static 'js/form-validation.js' %}"></script>

    <!-- Field Dependencies JavaScript -->
    <script src="{% static 'js/field-dependencies.js' %}"></script>

    <script>
        // Sidebar toggle functionality
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            sidebar.classList.toggle('open');
            overlay.classList.toggle('show');
            document.body.style.overflow = sidebar.classList.contains('open') ? 'hidden' : '';
        }

        function closeSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            sidebar.classList.remove('open');
            overlay.classList.remove('show');
            document.body.style.overflow = '';
        }

        // Submenu toggle
        function toggleSubmenu(navItemId) {
            const navItem = document.getElementById(navItemId);
            const wasOpen = navItem.classList.contains('open');

            // Close all other submenus on mobile
            if (window.innerWidth < 1024) {
                document.querySelectorAll('.nav-item.open').forEach(item => {
                    if (item.id !== navItemId) {
                        item.classList.remove('open');
                    }
                });
            }

            navItem.classList.toggle('open');
        }

        // User dropdown toggle
        function toggleUserMenu() {
            const dropdown = document.getElementById('userDropdown');
            dropdown.classList.toggle('show');
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', function(event) {
            const userMenu = document.getElementById('userMenu');
            const dropdown = document.getElementById('userDropdown');

            if (userMenu && !userMenu.contains(event.target)) {
                dropdown.classList.remove('show');
            }
        });

        // Close sidebar on window resize if open
        window.addEventListener('resize', function() {
            if (window.innerWidth > 1023) {
                closeSidebar();
            }
        });

        // Handle escape key to close sidebar
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                closeSidebar();
                document.getElementById('userDropdown').classList.remove('show');
            }
        });

        // Auto-dismiss alerts after 5 seconds
        document.addEventListener('DOMContentLoaded', function() {
            const alerts = document.querySelectorAll('.alert');
            alerts.forEach(function(alert) {
                setTimeout(function() {
                    alert.style.opacity = '0';
                    alert.style.transform = 'translateY(-10px)';
                    setTimeout(function() {
                        alert.remove();
                    }, 300);
                }, 5000);
            });
        });
    </script>

    {% block extra_js %}{% endblock %}
</body>
</html>
