{% extends 'base.html' %}

{% block title %}{% if product %}Modifier{% else %}Creer{% endif %} Produit - Bijouterie Hafsa ERP{% endblock %}

{% block breadcrumb %}
    <span class="breadcrumb-separator">/</span>
    <a href="{% url 'products:list' %}" class="breadcrumb-item">Produits</a>
    <span class="breadcrumb-separator">/</span>
    <span class="breadcrumb-item active">{% if product %}{{ product.reference }}{% else %}Nouveau{% endif %}</span>
{% endblock %}

{% block page_header %}
    <div class="page-header">
        <div class="page-header-inner">
            <div>
                <h1 class="page-title">{% if product %}Modifier Produit{% else %}Nouveau Produit{% endif %}</h1>
                {% if product %}
                    <p class="page-subtitle">Reference: <strong>{{ product.reference }}</strong></p>
                {% else %}
                    <p class="page-subtitle">Remplissez les informations du nouveau produit</p>
                {% endif %}
            </div>
            <div class="page-actions">
                <a href="{% if product %}{% url 'products:detail' product.reference %}{% else %}{% url 'products:list' %}{% endif %}" class="btn btn-secondary">
                    <i class="fas fa-arrow-left"></i>
                    <span>Annuler</span>
                </a>
            </div>
        </div>
    </div>
{% endblock %}

{% block content %}
    <form method="post" enctype="multipart/form-data" class="card animate-slide-up">
        {% csrf_token %}

        {% if form.non_field_errors %}
            <div class="alert alert-error mb-6">
                <i class="alert-icon fas fa-exclamation-circle"></i>
                <div class="alert-content">
                    {% for error in form.non_field_errors %}
                        <p class="alert-message">{{ error }}</p>
                    {% endfor %}
                </div>
            </div>
        {% endif %}

        <div class="card-body">
            <!-- Images Section -->
            <div class="mb-8">
                <h2 class="text-lg font-semibold mb-4" style="font-family: var(--font-display);">
                    <i class="fas fa-images text-primary mr-2"></i>
                    Images du Produit
                </h2>

                <!-- Current Images (edit mode) -->
                {% if product and product.images.all %}
                    <div class="current-images mb-4">
                        <label class="form-label">Images actuelles</label>
                        <div class="images-grid">
                            {% if product.main_image %}
                                <div class="image-item main-image">
                                    <img src="{{ product.main_image.url }}" alt="Image principale">
                                    <span class="image-badge">Principale</span>
                                    <label class="image-delete">
                                        <input type="checkbox" name="delete_main_image" value="1">
                                        <i class="fas fa-trash"></i>
                                    </label>
                                </div>
                            {% endif %}
                            {% for image in product.images.all %}
                                <div class="image-item">
                                    <img src="{{ image.image.url }}" alt="Image produit">
                                    {% if image.is_primary %}<span class="image-badge">Principale</span>{% endif %}
                                    <label class="image-delete">
                                        <input type="checkbox" name="delete_images" value="{{ image.id }}">
                                        <i class="fas fa-trash"></i>
                                    </label>
                                </div>
                            {% endfor %}
                        </div>
                        <p class="form-help mt-2">Cochez pour supprimer une image</p>
                    </div>
                {% endif %}

                <!-- Upload New Images -->
                <div class="image-upload-section">
                    <label class="form-label">{% if product %}Ajouter des images{% else %}Images du produit{% endif %}</label>
                    <div class="image-upload-area" id="imageUploadArea">
                        <input type="file" name="images" id="imageInput" multiple accept="image/*" class="image-input">
                        <div class="upload-placeholder">
                            <i class="fas fa-cloud-upload-alt"></i>
                            <p>Glissez vos images ici ou cliquez pour selectionner</p>
                            <span class="upload-hint">JPG, PNG - Max 5MB par image</span>
                        </div>
                    </div>
                    <div class="image-preview-grid" id="imagePreviewGrid"></div>
                </div>
            </div>

            <!-- Basic Information -->
            <div class="mb-8">
                <h2 class="text-lg font-semibold mb-4" style="font-family: var(--font-display);">
                    <i class="fas fa-info-circle text-primary mr-2"></i>
                    Informations de Base
                </h2>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Reference</label>
                        <input type="text" name="reference" value="{% if product %}{{ product.reference }}{% endif %}"
                            readonly class="form-input" style="background: var(--neutral-100); color: var(--neutral-500);">
                        <p class="form-help">{% if product %}Reference unique du produit{% else %}Generee automatiquement{% endif %}</p>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Type <span class="required">*</span></label>
                        <select name="product_type" class="form-select" required>
                            {% for value, label in product_types %}
                                <option value="{{ value }}" {% if product.product_type == value %}selected{% endif %}>{{ label }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Nom (Francais) <span class="required">*</span></label>
                        <input type="text" name="name" value="{% if product %}{{ product.name }}{% endif %}" required class="form-input" placeholder="Nom du produit">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Nom (Arabe)</label>
                        <input type="text" name="name_ar" value="{% if product %}{{ product.name_ar }}{% endif %}" class="form-input" dir="rtl" placeholder="اسم المنتج">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Categorie <span class="required">*</span></label>
                        <select name="category" required class="form-select">
                            <option value="">Selectionner une categorie</option>
                            {% for category in categories %}
                                <option value="{{ category.id }}" {% if product.category_id == category.id %}selected{% endif %}>{{ category.name }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Code-barres</label>
                        <input type="text" name="barcode" value="{% if product %}{{ product.barcode }}{% endif %}" class="form-input" placeholder="Optionnel">
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Description</label>
                    <textarea name="description" rows="3" class="form-textarea" placeholder="Description du produit (optionnel)">{% if product %}{{ product.description }}{% endif %}</textarea>
                </div>
            </div>

            <!-- Metal & Purity -->
            <div class="mb-8">
                <h2 class="text-lg font-semibold mb-4" style="font-family: var(--font-display);">
                    <i class="fas fa-ring text-primary mr-2"></i>
                    Metaux & Purete
                </h2>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Type de Metal</label>
                        <select name="metal_type" class="form-select">
                            <option value="">Non specifie</option>
                            {% for metal in metals %}
                                <option value="{{ metal.id }}" {% if product.metal_type_id == metal.id %}selected{% endif %}>{{ metal.name }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Purete</label>
                        <select name="metal_purity" class="form-select">
                            <option value="">Non specifiee</option>
                            {% for purity in purities %}
                                <option value="{{ purity.id }}" {% if product.metal_purity_id == purity.id %}selected{% endif %}>{{ purity.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
            </div>

            <!-- Weight & Size -->
            <div class="mb-8">
                <h2 class="text-lg font-semibold mb-4" style="font-family: var(--font-display);">
                    <i class="fas fa-balance-scale text-primary mr-2"></i>
                    Poids & Dimensions
                </h2>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Poids Brut (g) <span class="required">*</span></label>
                        <input type="number" name="gross_weight" value="{% if product %}{{ product.gross_weight|stringformat:'f' }}{% else %}0{% endif %}"
                            step="0.001" min="0" required class="form-input">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Poids Net (g)</label>
                        <input type="number" id="net_weight" name="net_weight" value="{% if product %}{{ product.net_weight|stringformat:'f' }}{% else %}0{% endif %}"
                            step="0.001" min="0" onchange="calculateCosts()" class="form-input">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Taille (cm)</label>
                        <input type="text" name="size" value="{% if product %}{{ product.size }}{% endif %}"
                            class="form-input" placeholder="Ex: 18, 45, 52...">
                        <p class="form-help">Taille de bague, longueur de chaine, tour de cou, etc. Apparait sur l'etiquette.</p>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Longueur (cm)</label>
                        <input type="number" name="length" value="{% if product and product.length %}{{ product.length|stringformat:'f' }}{% endif %}"
                            step="0.01" min="0" class="form-input" placeholder="Optionnel">
                    </div>
                </div>
            </div>

            <!-- Pricing -->
            <div class="mb-8">
                <h2 class="text-lg font-semibold mb-4" style="font-family: var(--font-display);">
                    <i class="fas fa-tags text-primary mr-2"></i>
                    Tarification
                </h2>

                <div class="form-row-3">
                    <div class="form-group">
                        <label class="form-label">Prix d'Achat/g (DH) <span class="required">*</span></label>
                        <input type="number" id="purchase_price_per_gram" name="purchase_price_per_gram"
                            value="{% if product %}{{ product.purchase_price_per_gram|stringformat:'f' }}{% else %}0{% endif %}"
                            step="0.01" min="0" required onchange="calculateCosts()" class="form-input">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Cout du Metal (DH)</label>
                        <input type="number" id="metal_cost" name="metal_cost"
                            value="{% if product %}{{ product.metal_cost|stringformat:'f' }}{% else %}0{% endif %}"
                            step="0.01" min="0" readonly class="form-input"
                            style="background: var(--info-50); border-color: var(--info-500); color: var(--info-700); font-weight: 600;">
                        <p class="form-help">Calcule = Poids Net x Prix/g</p>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Main d'Oeuvre (DH)</label>
                        <input type="number" id="labor_cost" name="labor_cost"
                            value="{% if product %}{{ product.labor_cost|stringformat:'f' }}{% else %}0{% endif %}"
                            step="0.01" min="0" onchange="calculateCosts()" class="form-input">
                    </div>
                </div>

                <div class="form-row-3">
                    <div class="form-group">
                        <label class="form-label">Cout des Pierres (DH)</label>
                        <input type="number" id="stone_cost" name="stone_cost"
                            value="{% if product %}{{ product.stone_cost|stringformat:'f' }}{% else %}0{% endif %}"
                            step="0.01" min="0" onchange="calculateCosts()" class="form-input">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Autres Couts (DH)</label>
                        <input type="number" id="other_cost" name="other_cost"
                            value="{% if product %}{{ product.other_cost|stringformat:'f' }}{% else %}0{% endif %}"
                            step="0.01" min="0" onchange="calculateCosts()" class="form-input">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Cout Total (DH)</label>
                        <input type="number" id="total_cost" name="total_cost"
                            value="{% if product %}{{ product.total_cost|stringformat:'f' }}{% else %}0{% endif %}"
                            step="0.01" min="0" readonly class="form-input"
                            style="background: var(--success-50); border-color: var(--success-500); color: var(--success-700); font-weight: 700; font-size: var(--text-lg);">
                    </div>
                </div>

                <!-- Margin Settings -->
                <div class="p-4 rounded-lg mt-4" style="background: var(--neutral-50); border: 1px solid var(--neutral-200);">
                    <h3 class="font-semibold mb-4">Calcul du Prix de Vente</h3>
                    <div class="form-row-3">
                        <div class="form-group">
                            <label class="form-label">Type de Marge</label>
                            <select id="margin_type" name="margin_type" onchange="calculateSellingPrice()" class="form-select">
                                <option value="percentage" {% if not product or product.margin_type == 'percentage' %}selected{% endif %}>Pourcentage (%)</option>
                                <option value="fixed" {% if product and product.margin_type == 'fixed' %}selected{% endif %}>Montant Fixe (DH)</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Valeur de Marge</label>
                            <div class="flex items-center gap-2">
                                <input type="number" id="margin_value" name="margin_value"
                                    value="{% if product %}{{ product.margin_value|stringformat:'f' }}{% else %}25{% endif %}"
                                    step="0.01" min="0" onchange="calculateSellingPrice()" class="form-input">
                                <span id="margin_unit" class="text-muted font-medium" style="white-space: nowrap;">{% if product and product.margin_type == 'fixed' %}DH{% else %}%{% endif %}</span>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Prix de Vente (DH)</label>
                            <input type="number" id="selling_price" name="selling_price"
                                value="{% if product %}{{ product.selling_price|stringformat:'f' }}{% else %}0{% endif %}"
                                step="0.01" min="0" readonly class="form-input"
                                style="background: var(--primary-50); border-color: var(--primary-500); color: var(--primary-700); font-weight: 700; font-size: var(--text-lg);">
                        </div>
                    </div>
                </div>

                <div class="form-row mt-4">
                    <div class="form-group">
                        <label class="form-label">Prix Minimum (DH) <span class="required">*</span></label>
                        <input type="number" name="minimum_price" value="{% if product %}{{ product.minimum_price|stringformat:'f' }}{% else %}0{% endif %}"
                            step="0.01" min="0" required class="form-input">
                        <p class="form-help">Prix minimum en dessous duquel une approbation est necessaire</p>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Compte Bancaire</label>
                        <select name="bank_account" class="form-select">
                            <option value="">Selectionner un compte</option>
                            {% for bank_account in bank_accounts %}
                                <option value="{{ bank_account.id }}" {% if product.bank_account_id == bank_account.id %}selected{% endif %}>
                                    {{ bank_account.bank_name }} - {{ bank_account.account_name }}
                                </option>
                            {% endfor %}
                        </select>
                        <p class="form-help">Compte a partir duquel ce produit a ete achete</p>
                    </div>
                </div>
            </div>

            <!-- Status (if editing) -->
            {% if product %}
            <div class="mb-8">
                <h2 class="text-lg font-semibold mb-4" style="font-family: var(--font-display);">
                    <i class="fas fa-toggle-on text-primary mr-2"></i>
                    Statut
                </h2>
                <div class="form-group">
                    <label class="form-label">Statut du Produit</label>
                    <select name="status" class="form-select">
                        {% for value, label in statuses %}
                            <option value="{{ value }}" {% if product.status == value %}selected{% endif %}>{{ label }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Form Actions -->
        <div class="card-footer">
            <a href="{% if product %}{% url 'products:detail' product.reference %}{% else %}{% url 'products:list' %}{% endif %}" class="btn btn-secondary">
                Annuler
            </a>
            <button type="submit" class="btn btn-primary">
                <i class="fas fa-save"></i>
                <span>{% if product %}Mettre a Jour{% else %}Creer Produit{% endif %}</span>
            </button>
        </div>
    </form>

    <style>
        /* Image Upload Styles */
        .current-images {
            margin-bottom: var(--space-4);
        }

        .images-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: var(--space-3);
        }

        .image-item {
            position: relative;
            aspect-ratio: 1;
            border-radius: var(--radius-lg);
            overflow: hidden;
            border: 2px solid var(--neutral-200);
        }

        .image-item.main-image {
            border-color: var(--primary-500);
        }

        .image-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .image-badge {
            position: absolute;
            top: var(--space-1);
            left: var(--space-1);
            background: var(--primary-500);
            color: white;
            font-size: var(--text-xs);
            padding: 2px 6px;
            border-radius: var(--radius-sm);
        }

        .image-delete {
            position: absolute;
            top: var(--space-1);
            right: var(--space-1);
            width: 28px;
            height: 28px;
            background: var(--error-500);
            color: white;
            border-radius: var(--radius-full);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            opacity: 0.8;
            transition: opacity var(--transition-fast);
        }

        .image-delete:hover {
            opacity: 1;
        }

        .image-delete input {
            display: none;
        }

        .image-delete:has(input:checked) {
            background: var(--error-700);
            opacity: 1;
        }

        .image-delete:has(input:checked)::after {
            content: '';
            position: absolute;
            inset: -4px;
            border: 2px solid var(--error-500);
            border-radius: var(--radius-full);
        }

        .image-item:has(.image-delete input:checked) {
            opacity: 0.5;
            border-color: var(--error-500);
        }

        /* Upload Area */
        .image-upload-area {
            position: relative;
            border: 2px dashed var(--neutral-300);
            border-radius: var(--radius-lg);
            padding: var(--space-8);
            text-align: center;
            transition: all var(--transition-fast);
            cursor: pointer;
        }

        .image-upload-area:hover,
        .image-upload-area.dragover {
            border-color: var(--primary-500);
            background: var(--primary-50);
        }

        .image-input {
            position: absolute;
            inset: 0;
            opacity: 0;
            cursor: pointer;
        }

        .upload-placeholder {
            pointer-events: none;
        }

        .upload-placeholder i {
            font-size: 3rem;
            color: var(--neutral-400);
            margin-bottom: var(--space-3);
        }

        .upload-placeholder p {
            color: var(--neutral-600);
            margin-bottom: var(--space-1);
        }

        .upload-hint {
            font-size: var(--text-xs);
            color: var(--neutral-400);
        }

        /* Image Preview */
        .image-preview-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: var(--space-3);
            margin-top: var(--space-4);
        }

        .image-preview-grid:empty {
            display: none;
        }

        .preview-item {
            position: relative;
            aspect-ratio: 1;
            border-radius: var(--radius-lg);
            overflow: hidden;
            border: 2px solid var(--success-300);
            background: var(--neutral-100);
        }

        .preview-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .preview-remove {
            position: absolute;
            top: 4px;
            right: 4px;
            width: 24px;
            height: 24px;
            background: var(--error-500);
            color: white;
            border: none;
            border-radius: var(--radius-full);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: var(--text-xs);
        }

        .preview-name {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0,0,0,0.7);
            color: white;
            font-size: var(--text-xs);
            padding: 2px 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* Mobile */
        @media (max-width: 768px) {
            .images-grid {
                grid-template-columns: repeat(3, 1fr);
            }

            .image-upload-area {
                padding: var(--space-6);
            }

            .upload-placeholder i {
                font-size: 2rem;
            }
        }
    </style>

    <script>
        function calculateCosts() {
            const netWeight = parseFloat(document.getElementById('net_weight').value) || 0;
            const pricePerGram = parseFloat(document.getElementById('purchase_price_per_gram').value) || 0;
            const laborCost = parseFloat(document.getElementById('labor_cost').value) || 0;
            const stoneCost = parseFloat(document.getElementById('stone_cost').value) || 0;
            const otherCost = parseFloat(document.getElementById('other_cost').value) || 0;

            const metalCost = netWeight * pricePerGram;
            document.getElementById('metal_cost').value = metalCost.toFixed(2);

            const totalCost = metalCost + laborCost + stoneCost + otherCost;
            document.getElementById('total_cost').value = totalCost.toFixed(2);

            calculateSellingPrice();
        }

        function calculateSellingPrice() {
            const totalCost = parseFloat(document.getElementById('total_cost').value) || 0;
            const marginType = document.getElementById('margin_type').value;
            const marginValue = parseFloat(document.getElementById('margin_value').value) || 0;

            let sellingPrice;
            if (marginType === 'percentage') {
                sellingPrice = totalCost * (1 + marginValue / 100);
            } else {
                sellingPrice = totalCost + marginValue;
            }

            document.getElementById('selling_price').value = sellingPrice.toFixed(2);
        }

        // Image upload handling
        document.addEventListener('DOMContentLoaded', function() {
            calculateCosts();

            const marginTypeSelect = document.getElementById('margin_type');
            const marginUnit = document.getElementById('margin_unit');

            if (marginTypeSelect) {
                marginTypeSelect.addEventListener('change', function() {
                    marginUnit.textContent = this.value === 'percentage' ? '%' : 'DH';
                });
            }

            // Image upload preview
            const imageInput = document.getElementById('imageInput');
            const imageUploadArea = document.getElementById('imageUploadArea');
            const previewGrid = document.getElementById('imagePreviewGrid');

            if (imageInput) {
                imageInput.addEventListener('change', function() {
                    previewGrid.innerHTML = '';
                    const files = Array.from(this.files);

                    files.forEach((file, index) => {
                        if (file.type.startsWith('image/')) {
                            const reader = new FileReader();
                            reader.onload = function(e) {
                                const div = document.createElement('div');
                                div.className = 'preview-item';
                                div.innerHTML = `
                                    <img src="${e.target.result}" alt="Preview">
                                    <span class="preview-name">${file.name}</span>
                                `;
                                previewGrid.appendChild(div);
                            };
                            reader.readAsDataURL(file);
                        }
                    });
                });

                // Drag and drop
                imageUploadArea.addEventListener('dragover', function(e) {
                    e.preventDefault();
                    this.classList.add('dragover');
                });

                imageUploadArea.addEventListener('dragleave', function() {
                    this.classList.remove('dragover');
                });

                imageUploadArea.addEventListener('drop', function(e) {
                    e.preventDefault();
                    this.classList.remove('dragover');
                    imageInput.files = e.dataTransfer.files;
                    imageInput.dispatchEvent(new Event('change'));
                });
            }
        });
    </script>
{% endblock %}
