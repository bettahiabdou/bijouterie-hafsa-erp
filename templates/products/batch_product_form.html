{% extends 'base.html' %}

{% block title %}Cr√©er Produits en Lot - Bijouterie Hafsa ERP{% endblock %}

{% block breadcrumb %}
    <span>/</span>
    <a href="{% url 'products:list' %}">Produits</a>
    <span>/</span>
    <span>Cr√©er en Lot</span>
{% endblock %}

{% block page_header %}
    <div class="flex justify-between items-center">
        <div>
            <h1 class="text-3xl font-bold text-gray-900">Cr√©er Produits en Lot</h1>
            <p class="text-gray-600 mt-1">Ajouter plusieurs produits √† la fois avec les m√™mes param√®tres</p>
        </div>
        <a href="{% url 'products:list' %}" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg">
            <i class="fas fa-arrow-left mr-2"></i> Annuler
        </a>
    </div>
{% endblock %}

{% block content %}
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Main Form -->
        <div class="lg:col-span-2">
            <form method="post" class="bg-white rounded-lg shadow-md p-6">
                {% csrf_token %}

                {% if messages %}
                    {% for message in messages %}
                        <div class="mb-6 p-4 {% if message.tags %}bg-{{ message.tags }}-100 text-{{ message.tags }}-800{% else %}bg-blue-100 text-blue-800{% endif %} rounded-lg">
                            {{ message }}
                        </div>
                    {% endfor %}
                {% endif %}

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Common Parameters -->
                    <div class="lg:col-span-2">
                        <h2 class="text-lg font-bold text-gray-900 mb-4">Param√®tres Communs</h2>
                    </div>

                    <!-- Category -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Cat√©gorie *</label>
                        <select name="category" id="category" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">S√©lectionner une cat√©gorie</option>
                            {% for category in categories %}
                                <option value="{{ category.id }}">{{ category.name }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- Type -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Type *</label>
                        <select name="product_type" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            {% for value, label in product_types %}
                                <option value="{{ value }}" {% if value == 'finished' %}selected{% endif %}>{{ label }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- Metal Type -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Type de M√©tal</label>
                        <select name="metal_type" id="metal_type" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">Non sp√©cifi√©</option>
                            {% for metal in metals %}
                                <option value="{{ metal.id }}">{{ metal.name }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- Purity -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Puret√©</label>
                        <select name="metal_purity" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">Non sp√©cifi√©e</option>
                            {% for purity in purities %}
                                <option value="{{ purity.id }}">{{ purity.name }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- Bank Account -->
                    <div class="lg:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Compte Bancaire</label>
                        <select name="bank_account" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">S√©lectionner un compte</option>
                            {% for bank in bank_accounts %}
                                <option value="{{ bank.id }}">{{ bank.bank_name }} - {{ bank.account_name }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- Pricing -->
                    <div class="lg:col-span-2">
                        <h2 class="text-lg font-bold text-gray-900 mb-4">Prix Unitaire (par gramme)</h2>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Prix d'Achat/g (DH) *</label>
                        <input type="number" id="purchase_price_per_gram" name="purchase_price_per_gram" value="0"
                            step="0.01" min="0" required onchange="calculatePreview()"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Main d'≈íuvre (DH)</label>
                        <input type="number" id="labor_cost" name="labor_cost" value="0"
                            step="0.01" min="0" onchange="calculatePreview()"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Pierres (DH)</label>
                        <input type="number" id="stone_cost" name="stone_cost" value="0"
                            step="0.01" min="0" onchange="calculatePreview()"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Autres Co√ªts (DH)</label>
                        <input type="number" id="other_cost" name="other_cost" value="0"
                            step="0.01" min="0" onchange="calculatePreview()"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>

                    <!-- Margin Settings -->
                    <div class="lg:col-span-2">
                        <h2 class="text-lg font-bold text-gray-900 mb-4">Marge sur Prix de Vente</h2>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Type de Marge</label>
                        <select id="margin_type_batch" name="margin_type" onchange="calculatePreview()" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="percentage" selected>Pourcentage (%)</option>
                            <option value="fixed">Montant Fixe (DH)</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Valeur de Marge</label>
                        <div class="flex items-center gap-2">
                            <input type="number" id="margin_value_batch" name="margin_value" value="25"
                                step="0.01" min="0" onchange="calculatePreview()"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <span id="margin_unit_batch" class="text-gray-600 font-medium whitespace-nowrap">%</span>
                        </div>
                        <p class="text-xs text-gray-500 mt-1">Marge √† appliquer au co√ªt total de chaque produit</p>
                    </div>

                    <!-- Products List -->
                    <div class="lg:col-span-2">
                        <h2 class="text-lg font-bold text-gray-900 mb-4">Produits √† Cr√©er</h2>
                        <p class="text-sm text-gray-600 mb-3">Entrez le poids net de chaque produit. Le co√ªt total sera calcul√© automatiquement. Chaque produit recevra une r√©f√©rence unique g√©n√©r√©e automatiquement.</p>
                    </div>

                    <!-- Dynamic Product Entry -->
                    <div class="lg:col-span-2">
                        <div id="products_list" class="space-y-3">
                            <div class="product_item bg-gray-50 p-4 rounded-lg border border-gray-200">
                                <div class="grid grid-cols-1 lg:grid-cols-4 gap-3">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Poids Net (g) *</label>
                                        <input type="number" class="product_weight w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                            step="0.001" min="0" required onchange="calculatePreview()">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Co√ªt Total (DH)</label>
                                        <input type="number" class="product_total_cost w-full px-3 py-2 bg-green-50 border border-green-300 rounded-lg text-green-700 font-semibold"
                                            step="0.01" min="0" readonly>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Prix Vente Calc. (DH)</label>
                                        <input type="number" class="product_selling_price_calc w-full px-3 py-2 bg-orange-50 border border-orange-300 rounded-lg text-orange-700 font-semibold"
                                            step="0.01" min="0" readonly>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Prix Vente Final (DH)</label>
                                        <input type="number" class="product_selling_price w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                            step="0.01" min="0" placeholder="Auto-rempli">
                                    </div>
                                </div>
                                <button type="button" class="mt-3 px-3 py-1 bg-red-500 hover:bg-red-600 text-white rounded text-sm remove_product" style="display:none;">
                                    <i class="fas fa-trash mr-1"></i> Supprimer
                                </button>
                            </div>
                        </div>

                        <button type="button" id="add_product_btn" class="mt-4 px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg flex items-center">
                            <i class="fas fa-plus mr-2"></i> Ajouter un Produit
                        </button>
                    </div>

                    <!-- Summary -->
                    <div class="lg:col-span-2 mt-6 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                        <h3 class="font-bold text-blue-900 mb-2">R√©sum√©</h3>
                        <p class="text-sm text-blue-800">
                            <strong id="total_products">1</strong> produit(s) √† cr√©er
                        </p>
                        <p class="text-sm text-blue-800 mt-2">
                            Co√ªt total estim√©: <strong id="total_estimated_cost">0.00</strong> DH
                        </p>
                    </div>
                </div>

                <!-- Form Actions -->
                <div class="mt-8 flex gap-4">
                    <button type="submit" class="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-lg flex items-center">
                        <i class="fas fa-save mr-2"></i> Cr√©er les Produits
                    </button>
                    <a href="{% url 'products:list' %}" class="px-6 py-2 bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold rounded-lg">
                        Annuler
                    </a>
                </div>
            </form>
        </div>

        <!-- Info Panel -->
        <div class="lg:col-span-1">
            <div class="bg-white rounded-lg shadow-md p-6 sticky top-24">
                <h3 class="text-lg font-bold text-gray-900 mb-4">Aide</h3>
                <div class="space-y-4 text-sm text-gray-600">
                    <div>
                        <h4 class="font-bold text-gray-900 mb-1">Param√®tres Communs</h4>
                        <p>Les param√®tres communs s'appliquent √† tous les produits de ce lot.</p>
                    </div>
                    <div>
                        <h4 class="font-bold text-gray-900 mb-1">Co√ªt Automatique</h4>
                        <p>Le co√ªt total de chaque produit = (Poids √ó Prix/g) + Main d'≈ìuvre + Pierres + Autres</p>
                    </div>
                    <div>
                        <h4 class="font-bold text-gray-900 mb-1">Exemple</h4>
                        <p>Si poids=10g, prix/g=800 DH, main d'≈ìuvre=100 DH:</p>
                        <p class="font-mono text-blue-600">(10 √ó 800) + 100 = 8100 DH</p>
                    </div>
                    <div class="pt-4 border-t">
                        <p class="text-xs text-gray-500">
                            üí° Vous pouvez modifier le prix de vente pour chaque produit individuellement.
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Add product row
        document.getElementById('add_product_btn').addEventListener('click', function(e) {
            e.preventDefault();
            const productsList = document.getElementById('products_list');
            const newItem = document.querySelector('.product_item').cloneNode(true);

            // Clear values in cloned item
            newItem.querySelectorAll('input').forEach(input => {
                input.value = '';
            });

            // Show remove button if there's more than one item
            updateRemoveButtons();

            productsList.appendChild(newItem);
            attachEventListeners(newItem);
            calculatePreview();
        });

        // Remove product row
        function removeProduct(btn) {
            btn.closest('.product_item').remove();
            updateRemoveButtons();
            calculatePreview();
        }

        // Attach event listeners to product items
        function attachEventListeners(item) {
            const removeBtn = item.querySelector('.remove_product');
            if (removeBtn) {
                removeBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    removeProduct(this);
                });
            }

            const inputs = item.querySelectorAll('input');
            inputs.forEach(input => {
                input.addEventListener('change', calculatePreview);
            });
        }

        // Update remove buttons visibility
        function updateRemoveButtons() {
            const items = document.querySelectorAll('.product_item');
            items.forEach(item => {
                const removeBtn = item.querySelector('.remove_product');
                if (removeBtn) {
                    removeBtn.style.display = items.length > 1 ? 'block' : 'none';
                }
            });
        }

        // Calculate costs and selling prices
        function calculatePreview() {
            const pricePerGram = parseFloat(document.getElementById('purchase_price_per_gram').value) || 0;
            const laborCost = parseFloat(document.getElementById('labor_cost').value) || 0;
            const stoneCost = parseFloat(document.getElementById('stone_cost').value) || 0;
            const otherCost = parseFloat(document.getElementById('other_cost').value) || 0;

            // Get margin settings
            const marginType = document.getElementById('margin_type_batch').value;
            const marginValue = parseFloat(document.getElementById('margin_value_batch').value) || 0;

            let totalEstimated = 0;
            let productCount = 0;

            document.querySelectorAll('.product_item').forEach(item => {
                const weight = parseFloat(item.querySelector('.product_weight').value) || 0;
                const metalCost = weight * pricePerGram;
                const totalCost = metalCost + laborCost + stoneCost + otherCost;

                item.querySelector('.product_total_cost').value = totalCost.toFixed(2);

                // Calculate selling price based on margin
                let sellingPriceCalc;
                if (marginType === 'percentage') {
                    sellingPriceCalc = totalCost * (1 + marginValue / 100);
                } else {
                    sellingPriceCalc = totalCost + marginValue;
                }

                item.querySelector('.product_selling_price_calc').value = sellingPriceCalc.toFixed(2);

                // Set the final selling price (or use calculated if not set)
                const finalPrice = item.querySelector('.product_selling_price');
                if (!finalPrice.value || finalPrice.value === '') {
                    finalPrice.value = sellingPriceCalc.toFixed(2);
                }

                totalEstimated += totalCost;
                productCount++;
            });

            document.getElementById('total_products').textContent = productCount;
            document.getElementById('total_estimated_cost').textContent = totalEstimated.toFixed(2);
        }

        // Update margin unit display
        function updateMarginUnit() {
            const marginTypeSelect = document.getElementById('margin_type_batch');
            const marginUnit = document.getElementById('margin_unit_batch');
            marginUnit.textContent = marginTypeSelect.value === 'percentage' ? '%' : 'DH';
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            attachEventListeners(document.querySelector('.product_item'));
            updateRemoveButtons();
            calculatePreview();

            // Update margin unit when type changes
            const marginTypeSelect = document.getElementById('margin_type_batch');
            if (marginTypeSelect) {
                marginTypeSelect.addEventListener('change', function() {
                    updateMarginUnit();
                    calculatePreview();
                });
            }
        });
    </script>
{% endblock %}
