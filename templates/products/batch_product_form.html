{% extends 'base.html' %}

{% block title %}Cr√©er Produits en Lot - Bijouterie Hafsa ERP{% endblock %}

{% block breadcrumb %}
    <span>/</span>
    <a href="{% url 'products:list' %}">Produits</a>
    <span>/</span>
    <span>Cr√©er en Lot</span>
{% endblock %}

{% block page_header %}
    <div class="flex justify-between items-center">
        <div>
            <h1 class="text-3xl font-bold text-gray-900">Cr√©er Produits en Lot</h1>
            <p class="text-gray-600 mt-1">Ajouter plusieurs produits √† la fois avec les m√™mes param√®tres</p>
        </div>
        <a href="{% url 'products:list' %}" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg">
            <i class="fas fa-arrow-left mr-2"></i> Annuler
        </a>
    </div>
{% endblock %}

{% block content %}
    <div class="batch-form-container">
        <!-- Main Form -->
        <div class="batch-form-wrapper">
            <form method="post" class="bg-white rounded-lg shadow-md p-6">
                {% csrf_token %}

                {% if messages %}
                    {% for message in messages %}
                        <div class="mb-6 p-4 {% if message.tags %}bg-{{ message.tags }}-100 text-{{ message.tags }}-800{% else %}bg-blue-100 text-blue-800{% endif %} rounded-lg">
                            {{ message }}
                        </div>
                    {% endfor %}
                {% endif %}

                <div>
                    <!-- Common Parameters (Only truly shared fields) -->
                    <div class="batch-form-section">
                        <h2 class="text-lg font-bold text-gray-900 mb-4">Param√®tres Communs</h2>
                        <p class="text-sm text-gray-600 mb-6">Ces param√®tres s'appliquent √† tous les produits du lot. Les champs sp√©cifiques √† chaque produit (Cat√©gorie, Type, M√©tal, Puret√©, Compte) seront remplis dans le tableau ci-dessous.</p>

                        <!-- Pricing Section -->
                        <h3 class="text-base font-bold text-gray-900 mb-4">Prix Unitaire (par gramme)</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Prix d'Achat/g (DH) *</label>
                                <input type="number" id="purchase_price_per_gram" name="purchase_price_per_gram" value="0"
                                    step="0.01" min="0" required onchange="calculatePreview()"
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Main d'≈íuvre (DH)</label>
                                <input type="number" id="labor_cost" name="labor_cost" value="0"
                                    step="0.01" min="0" onchange="calculatePreview()"
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Pierres (DH)</label>
                                <input type="number" id="stone_cost" name="stone_cost" value="0"
                                    step="0.01" min="0" onchange="calculatePreview()"
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Autres Co√ªts (DH)</label>
                                <input type="number" id="other_cost" name="other_cost" value="0"
                                    step="0.01" min="0" onchange="calculatePreview()"
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                        </div>

                        <!-- Margin Settings -->
                        <h3 class="text-base font-bold text-gray-900 mb-4">Marge sur Prix de Vente</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Type de Marge</label>
                                <select id="margin_type_batch" name="margin_type" onchange="calculatePreview()" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <option value="percentage" selected>Pourcentage (%)</option>
                                    <option value="fixed">Montant Fixe (DH)</option>
                                </select>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Valeur de Marge</label>
                                <div class="flex items-center gap-2">
                                    <input type="number" id="margin_value_batch" name="margin_value" value="25"
                                        step="0.01" min="0" onchange="calculatePreview()"
                                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <span id="margin_unit_batch" class="text-gray-600 font-medium whitespace-nowrap">%</span>
                                </div>
                                <p class="text-xs text-gray-500 mt-1">Marge √† appliquer au co√ªt total de chaque produit</p>
                            </div>
                        </div>
                    </div>

                    <!-- Dynamic Product Entry - Table Format -->
                    <div class="batch-form-section">
                        <h2 class="text-lg font-bold text-gray-900 mb-4">Produits √† Cr√©er</h2>
                        <p class="text-sm text-gray-600 mb-4">Remplissez le tableau ci-dessous avec les produits. Cliquez sur le ‚ñº pour voir et modifier les d√©tails suppl√©mentaires (M√©tal, Puret√©, Compte, Co√ªt). Chaque produit recevra une r√©f√©rence unique g√©n√©r√©e automatiquement.</p>

                        <div class="overflow-x-auto">
                            <table class="batch-table">
                                <thead>
                                    <tr>
                                        <th style="width: 30px;"></th>
                                        <th>Produit</th>
                                        <th>Cat√©gorie *</th>
                                        <th>Type *</th>
                                        <th>Poids Net (g) *</th>
                                        <th>Prix Vente (DH)</th>
                                        <th style="width: 50px;">Action</th>
                                    </tr>
                                </thead>
                                <tbody id="products_list">
                                    <!-- Template row (will be cloned for new rows) -->
                                    <tr class="product_item">
                                        <td>
                                            <button type="button" class="expand-toggle" title="Afficher d√©tails">‚ñº</button>
                                        </td>
                                        <td>
                                            <input type="text" name="product_name" class="product_name w-full px-2 py-1 border border-gray-300 rounded text-sm focus:outline-none focus:ring-2 focus:ring-blue-400"
                                                placeholder="Produit 1" onchange="calculatePreview()">
                                        </td>
                                        <td>
                                            <select name="product_category" class="product_category w-full px-2 py-1 border border-gray-300 rounded text-sm focus:outline-none focus:ring-2 focus:ring-blue-400" required>
                                                <option value="">--S√©lect--</option>
                                                {% for category in categories %}
                                                    <option value="{{ category.id }}">{{ category.name }}</option>
                                                {% endfor %}
                                            </select>
                                        </td>
                                        <td>
                                            <select name="product_type" class="product_type w-full px-2 py-1 border border-gray-300 rounded text-sm focus:outline-none focus:ring-2 focus:ring-blue-400" required>
                                                {% for value, label in product_types %}
                                                    <option value="{{ value }}" {% if value == 'finished' %}selected{% endif %}>{{ label }}</option>
                                                {% endfor %}
                                            </select>
                                        </td>
                                        <td>
                                            <input type="number" name="product_weight" class="product_weight w-full px-2 py-1 border border-gray-300 rounded text-sm focus:outline-none focus:ring-2 focus:ring-blue-400"
                                                step="0.001" min="0" required onchange="calculatePreview()">
                                        </td>
                                        <td>
                                            <input type="number" name="product_selling_price" class="product_selling_price w-full px-2 py-1 bg-orange-50 border border-orange-300 rounded text-sm focus:outline-none focus:ring-2 focus:ring-blue-400"
                                                step="0.01" min="0" onchange="calculatePreview()" placeholder="Auto">
                                        </td>
                                        <td style="text-align: center;">
                                            <button type="button" class="px-2 py-1 bg-red-500 hover:bg-red-600 text-white rounded text-sm remove_product" style="display:none;" title="Supprimer">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </td>
                                    </tr>
                                    <!-- Detail row template (hidden by default) -->
                                    <tr class="detail-row" style="display: none;">
                                        <td colspan="7">
                                            <div class="detail-content">
                                                <div class="detail-field">
                                                    <label>M√©tal</label>
                                                    <select name="product_metal_type" class="product_metal_type">
                                                        <option value="">--Aucun--</option>
                                                        {% for metal in metals %}
                                                            <option value="{{ metal.id }}" {% if metal.name == 'Or' %}selected{% endif %}>{{ metal.name }}</option>
                                                        {% endfor %}
                                                    </select>
                                                </div>
                                                <div class="detail-field">
                                                    <label>Puret√©</label>
                                                    <select name="product_purity" class="product_purity">
                                                        <option value="">--Aucune--</option>
                                                        {% for purity in purities %}
                                                            <option value="{{ purity.id }}" {% if purity.name == '18K' %}selected{% endif %}>{{ purity.name }}</option>
                                                        {% endfor %}
                                                    </select>
                                                </div>
                                                <div class="detail-field">
                                                    <label>Fournisseur</label>
                                                    <select name="product_supplier" class="product_supplier">
                                                        <option value="">--Aucun--</option>
                                                        {% for supplier in suppliers %}
                                                            <option value="{{ supplier.id }}">{{ supplier.name }}</option>
                                                        {% endfor %}
                                                    </select>
                                                </div>
                                                <div class="detail-field">
                                                    <label>Compte Bancaire</label>
                                                    <select name="product_bank_account" class="product_bank_account">
                                                        <option value="">--Aucun--</option>
                                                        {% for bank in bank_accounts %}
                                                            <option value="{{ bank.id }}">{{ bank.bank_name }}</option>
                                                        {% endfor %}
                                                    </select>
                                                </div>
                                                <div class="detail-field">
                                                    <label>Co√ªt Total (DH)</label>
                                                    <input type="number" name="product_total_cost" class="product_total_cost" step="0.01" min="0" readonly style="background-color: #ecfdf5; color: #065f46;">
                                                </div>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <button type="button" id="add_product_btn" class="mt-4 px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg flex items-center text-sm">
                            <i class="fas fa-plus mr-2"></i> Ajouter une Ligne
                        </button>
                    </div>

                    <!-- Summary -->
                    <div class="batch-form-section mt-6 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                        <h3 class="font-bold text-blue-900 mb-2">R√©sum√©</h3>
                        <p class="text-sm text-blue-800">
                            <strong id="total_products">1</strong> produit(s) √† cr√©er
                        </p>
                        <p class="text-sm text-blue-800 mt-2">
                            Co√ªt total estim√©: <strong id="total_estimated_cost">0.00</strong> DH
                        </p>
                    </div>
                </div>

                <!-- Form Actions -->
                <div class="mt-8 flex gap-4 justify-start">
                    <button type="submit" class="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-lg flex items-center">
                        <i class="fas fa-save mr-2"></i> Cr√©er les Produits
                    </button>
                    <a href="{% url 'products:list' %}" class="px-6 py-2 bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold rounded-lg">
                        Annuler
                    </a>
                </div>
            </form>
        </div>
    </div>

    <!-- Help Section (Below Form) -->
    <div class="batch-form-container mt-6">
        <div class="batch-form-wrapper">
            <div class="bg-white rounded-lg shadow-md p-6">
                <h3 class="text-lg font-bold text-gray-900 mb-4">Aide et Conseils</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 text-sm text-gray-600">
                    <div>
                        <h4 class="font-bold text-gray-900 mb-2">Param√®tres Communs</h4>
                        <p>Les param√®tres communs s'appliquent √† tous les produits de ce lot.</p>
                    </div>
                    <div>
                        <h4 class="font-bold text-gray-900 mb-2">Co√ªt Automatique</h4>
                        <p>Le co√ªt total de chaque produit = (Poids √ó Prix/g) + Main d'≈ìuvre + Pierres + Autres</p>
                    </div>
                    <div>
                        <h4 class="font-bold text-gray-900 mb-2">Exemple</h4>
                        <p>Si poids=10g, prix/g=800 DH, main d'≈ìuvre=100 DH:</p>
                        <p class="font-mono text-blue-600">(10 √ó 800) + 100 = 8100 DH</p>
                    </div>
                    <div>
                        <h4 class="font-bold text-gray-900 mb-2">üí° Prix de Vente</h4>
                        <p>Vous pouvez modifier le prix de vente pour chaque produit individuellement en cliquant sur le d√©tail (‚ñº) du produit.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <style>
        /* Centered layout container */
        .batch-form-container {
            display: flex;
            justify-content: center;
            padding: 0;
        }

        .batch-form-wrapper {
            width: 100%;
            max-width: 1200px;
            padding: 0 20px;
        }

        /* Form sections with better spacing */
        .batch-form-section {
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #e5e7eb;
        }

        .batch-form-section:last-child {
            border-bottom: none;
        }

        /* Table styling */
        .batch-table {
            width: 100%;
            margin: 20px 0;
            border-collapse: collapse;
        }

        .batch-table th,
        .batch-table td {
            padding: 12px 8px;
            text-align: left;
        }

        .batch-table th {
            background-color: #f3f4f6;
            border-bottom: 2px solid #d1d5db;
            font-weight: 600;
        }

        .batch-table td {
            border-bottom: 1px solid #e5e7eb;
        }

        .batch-table tbody tr:hover {
            background-color: #f9fafb;
        }

        /* Detail row styling */
        .detail-row {
            background-color: #f9fafb;
        }

        .detail-content {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            padding: 20px;
            background-color: #f9fafb;
            border-radius: 4px;
        }

        .detail-field {
            display: flex;
            flex-direction: column;
        }

        .detail-field label {
            font-weight: 600;
            margin-bottom: 6px;
            font-size: 0.9em;
            color: #374151;
        }

        .detail-field input,
        .detail-field select {
            padding: 8px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            font-size: 0.9em;
        }

        /* Expand toggle button */
        .expand-toggle {
            cursor: pointer;
            background: none;
            border: none;
            padding: 4px 8px;
            font-size: 0.9em;
            color: #6b7280;
            hover: color #111827;
            transition: color 0.2s;
        }

        .expand-toggle:hover {
            color: #111827;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .batch-form-wrapper {
                padding: 0 10px;
            }

            .detail-content {
                grid-template-columns: 1fr;
            }

            .batch-table {
                font-size: 0.85em;
            }

            .batch-table th,
            .batch-table td {
                padding: 8px 4px;
            }
        }
    </style>

    <script>
        // Setup expand/collapse for detail rows
        function setupExpandToggle(item) {
            const toggleBtn = item.querySelector('.expand-toggle');
            const mainRow = item;
            const detailRow = mainRow.nextElementSibling;

            if (toggleBtn && detailRow && detailRow.classList.contains('detail-row')) {
                toggleBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    const isHidden = detailRow.style.display === 'none';
                    detailRow.style.display = isHidden ? 'table-row' : 'none';
                    toggleBtn.textContent = isHidden ? '‚ñ≤' : '‚ñº';
                });
            }
        }

        // Add product row
        document.getElementById('add_product_btn').addEventListener('click', function(e) {
            e.preventDefault();
            const productsList = document.getElementById('products_list');
            const templateRow = document.querySelector('.product_item');
            const newMainRow = templateRow.cloneNode(true);
            const templateDetailRow = templateRow.nextElementSibling;
            const newDetailRow = templateDetailRow.cloneNode(true);

            // Clear values in cloned items
            newMainRow.querySelectorAll('input').forEach(input => {
                input.value = '';
            });
            newDetailRow.querySelectorAll('input').forEach(input => {
                input.value = '';
            });
            newDetailRow.style.display = 'none';

            // Append both rows
            productsList.appendChild(newMainRow);
            productsList.appendChild(newDetailRow);

            // Setup event listeners
            attachEventListeners(newMainRow);
            setupExpandToggle(newMainRow);
            updateRemoveButtons();
            calculatePreview();
        });

        // Remove product row (remove both main and detail rows)
        function removeProduct(btn) {
            const mainRow = btn.closest('.product_item');
            const detailRow = mainRow.nextElementSibling;
            mainRow.remove();
            if (detailRow && detailRow.classList.contains('detail-row')) {
                detailRow.remove();
            }
            updateRemoveButtons();
            calculatePreview();
        }

        // Attach event listeners to product items
        function attachEventListeners(item) {
            const removeBtn = item.querySelector('.remove_product');
            if (removeBtn) {
                removeBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    removeProduct(this);
                });
            }

            // Attach change listeners to inputs and selects
            const inputs = item.querySelectorAll('input, select');
            inputs.forEach(input => {
                input.addEventListener('change', calculatePreview);
            });

            // Also attach to detail row fields
            const detailRow = item.nextElementSibling;
            if (detailRow && detailRow.classList.contains('detail-row')) {
                const detailInputs = detailRow.querySelectorAll('input, select');
                detailInputs.forEach(input => {
                    input.addEventListener('change', calculatePreview);
                });
            }
        }

        // Update remove buttons visibility
        function updateRemoveButtons() {
            const items = document.querySelectorAll('.product_item');
            items.forEach(item => {
                const removeBtn = item.querySelector('.remove_product');
                if (removeBtn) {
                    removeBtn.style.display = items.length > 1 ? 'block' : 'none';
                }
            });
        }

        // Calculate costs and selling prices
        function calculatePreview() {
            const pricePerGram = parseFloat(document.getElementById('purchase_price_per_gram').value) || 0;
            const laborCost = parseFloat(document.getElementById('labor_cost').value) || 0;
            const stoneCost = parseFloat(document.getElementById('stone_cost').value) || 0;
            const otherCost = parseFloat(document.getElementById('other_cost').value) || 0;

            // Get margin settings
            const marginType = document.getElementById('margin_type_batch').value;
            const marginValue = parseFloat(document.getElementById('margin_value_batch').value) || 0;

            let totalEstimated = 0;
            let productCount = 0;
            let rowNumber = 0;

            document.querySelectorAll('.product_item').forEach((item, index) => {
                const weight = parseFloat(item.querySelector('.product_weight').value) || 0;

                // Skip empty rows
                if (weight <= 0) {
                    return;
                }

                rowNumber++;
                const metalCost = weight * pricePerGram;
                const totalCost = metalCost + laborCost + stoneCost + otherCost;

                // Update total cost in detail row
                const detailRow = item.nextElementSibling;
                if (detailRow && detailRow.classList.contains('detail-row')) {
                    detailRow.querySelector('.product_total_cost').value = totalCost.toFixed(2);
                }

                // Calculate selling price based on margin
                let sellingPriceCalc;
                if (marginType === 'percentage') {
                    sellingPriceCalc = totalCost * (1 + marginValue / 100);
                } else {
                    sellingPriceCalc = totalCost + marginValue;
                }

                // Update selling price field
                const finalPrice = item.querySelector('.product_selling_price');

                // Only auto-fill if user hasn't entered an override
                if (!finalPrice.value || finalPrice.value === '') {
                    finalPrice.value = sellingPriceCalc.toFixed(2);
                    finalPrice.classList.remove('bg-white', 'border-blue-300');
                    finalPrice.classList.add('bg-orange-50', 'border-orange-300');
                } else {
                    // User has overridden - show white background
                    finalPrice.classList.remove('bg-orange-50', 'border-orange-300');
                    finalPrice.classList.add('bg-white', 'border-blue-300');
                }

                // Auto-generate product name if empty
                const productNameInput = item.querySelector('.product_name');
                if (!productNameInput.value || productNameInput.value.trim() === '') {
                    productNameInput.value = `Produit ${rowNumber}`;
                }

                totalEstimated += totalCost;
                productCount++;
            });

            document.getElementById('total_products').textContent = productCount;
            document.getElementById('total_estimated_cost').textContent = totalEstimated.toFixed(2);
        }

        // Update margin unit display
        function updateMarginUnit() {
            const marginTypeSelect = document.getElementById('margin_type_batch');
            const marginUnit = document.getElementById('margin_unit_batch');
            marginUnit.textContent = marginTypeSelect.value === 'percentage' ? '%' : 'DH';
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            // Setup all product rows
            document.querySelectorAll('.product_item').forEach(item => {
                attachEventListeners(item);
                setupExpandToggle(item);
            });

            updateRemoveButtons();
            calculatePreview();

            // Update margin unit when type changes
            const marginTypeSelect = document.getElementById('margin_type_batch');
            if (marginTypeSelect) {
                marginTypeSelect.addEventListener('change', function() {
                    updateMarginUnit();
                    calculatePreview();
                });
            }
        });
    </script>
{% endblock %}
