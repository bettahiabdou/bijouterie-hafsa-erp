{% extends 'base.html' %}

{% block title %}Creer Produits en Lot - Bijouterie Hafsa ERP{% endblock %}

{% block breadcrumb %}
    <span class="breadcrumb-separator">/</span>
    <a href="{% url 'products:list' %}" class="breadcrumb-item">Produits</a>
    <span class="breadcrumb-separator">/</span>
    <span class="breadcrumb-item active">Creer en Lot</span>
{% endblock %}

{% block page_header %}
    <div class="page-header">
        <div class="page-header-inner">
            <div>
                <h1 class="page-title">Creer Produits en Lot</h1>
                <p class="page-subtitle">Ajouter plusieurs produits a la fois avec les memes parametres</p>
            </div>
            <div class="page-actions">
                <a href="{% url 'products:list' %}" class="btn btn-secondary">
                    <i class="fas fa-arrow-left"></i>
                    <span>Annuler</span>
                </a>
            </div>
        </div>
    </div>
{% endblock %}

{% block content %}
    <form method="post" enctype="multipart/form-data" class="card animate-slide-up">
        {% csrf_token %}

        {% if form.non_field_errors %}
            <div class="alert alert-error mb-6">
                <i class="alert-icon fas fa-exclamation-circle"></i>
                <div class="alert-content">
                    {% for error in form.non_field_errors %}
                        <p class="alert-message">{{ error }}</p>
                    {% endfor %}
                </div>
            </div>
        {% endif %}

        <div class="card-body">
            <!-- Common Parameters -->
            <div class="mb-8">
                <h2 class="text-lg font-semibold mb-4" style="font-family: var(--font-display);">
                    <i class="fas fa-sliders-h text-primary mr-2"></i>
                    Parametres Communs
                </h2>
                <p class="text-sm text-muted mb-6">Ces parametres s'appliquent a tous les produits du lot. Les champs specifiques a chaque produit seront remplis dans le tableau ci-dessous.</p>

                <!-- Pricing Section -->
                <h3 class="font-semibold mb-4">Prix Unitaire (par gramme)</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Prix d'Achat/g (DH) <span class="required">*</span></label>
                        <input type="number" id="purchase_price_per_gram" name="purchase_price_per_gram" value="0"
                            step="0.01" min="0" required onchange="calculatePreview()" class="form-input">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Main d'Oeuvre (DH)</label>
                        <input type="number" id="labor_cost" name="labor_cost" value="0"
                            step="0.01" min="0" onchange="calculatePreview()" class="form-input">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Pierres (DH)</label>
                        <input type="number" id="stone_cost" name="stone_cost" value="0"
                            step="0.01" min="0" onchange="calculatePreview()" class="form-input">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Autres Couts (DH)</label>
                        <input type="number" id="other_cost" name="other_cost" value="0"
                            step="0.01" min="0" onchange="calculatePreview()" class="form-input">
                    </div>
                </div>

                <!-- Margin Settings -->
                <div class="p-4 rounded-lg mt-6" style="background: var(--neutral-50); border: 1px solid var(--neutral-200);">
                    <h3 class="font-semibold mb-4">Marge sur Prix de Vente</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Type de Marge</label>
                            <select id="margin_type_batch" name="margin_type" onchange="calculatePreview()" class="form-select">
                                <option value="percentage" selected>Pourcentage (%)</option>
                                <option value="fixed">Montant Fixe (DH)</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Valeur de Marge</label>
                            <div class="flex items-center gap-2">
                                <input type="number" id="margin_value_batch" name="margin_value" value="25"
                                    step="0.01" min="0" onchange="calculatePreview()" class="form-input">
                                <span id="margin_unit_batch" class="text-muted font-medium" style="white-space: nowrap;">%</span>
                            </div>
                            <p class="form-help">Marge a appliquer au cout total de chaque produit</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Dynamic Product Entry Table -->
            <div class="mb-8">
                <h2 class="text-lg font-semibold mb-4" style="font-family: var(--font-display);">
                    <i class="fas fa-list text-primary mr-2"></i>
                    Produits a Creer
                </h2>
                <p class="text-sm text-muted mb-4">Remplissez le tableau ci-dessous avec les produits. Cliquez sur le &#9660; pour voir et modifier les details supplementaires.</p>

                <!-- Desktop View -->
                <div class="desktop-view">
                    <div class="table-wrapper">
                        <table class="table" id="batch_table">
                            <thead>
                                <tr>
                                    <th style="width: 40px;"></th>
                                    <th>Produit</th>
                                    <th>Categorie <span class="required">*</span></th>
                                    <th>Type <span class="required">*</span></th>
                                    <th>Poids Net (g) <span class="required">*</span></th>
                                    <th>Prix Vente (DH)</th>
                                    <th style="width: 60px;">Action</th>
                                </tr>
                            </thead>
                            <tbody id="products_list">
                                <!-- Template row -->
                                <tr class="product_item">
                                    <td>
                                        <button type="button" class="btn btn-ghost btn-sm expand-toggle" title="Afficher details">
                                            <i class="fas fa-chevron-down"></i>
                                        </button>
                                    </td>
                                    <td>
                                        <input type="text" name="product_name" class="product_name form-input" placeholder="Produit 1" onchange="calculatePreview()">
                                    </td>
                                    <td>
                                        <select name="product_category" class="product_category form-select">
                                            <option value="">--Select--</option>
                                            {% for category in categories %}
                                                <option value="{{ category.id }}">{{ category.name }}</option>
                                            {% endfor %}
                                        </select>
                                    </td>
                                    <td>
                                        <select name="product_type" class="product_type form-select">
                                            {% for value, label in product_types %}
                                                <option value="{{ value }}" {% if value == 'finished' %}selected{% endif %}>{{ label }}</option>
                                            {% endfor %}
                                        </select>
                                    </td>
                                    <td>
                                        <input type="number" name="product_weight" class="product_weight form-input"
                                            step="0.001" min="0" onchange="calculatePreview()">
                                    </td>
                                    <td>
                                        <input type="number" name="product_selling_price" class="product_selling_price form-input"
                                            step="0.01" min="0" onchange="calculatePreview()" placeholder="Auto"
                                            style="background: var(--accent-50); border-color: var(--accent-300);">
                                    </td>
                                    <td style="text-align: center;">
                                        <button type="button" class="btn btn-ghost btn-sm remove_product" style="display:none; color: var(--error-500);" title="Supprimer">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                                <!-- Detail row template -->
                                <tr class="detail-row" style="display: none;">
                                    <td colspan="7" style="background: var(--neutral-50); padding: var(--space-4);">
                                        <div class="grid" style="grid-template-columns: repeat(5, 1fr); gap: var(--space-4);">
                                            <div class="form-group" style="margin-bottom: 0;">
                                                <label class="form-label">Metal</label>
                                                <select name="product_metal_type" class="product_metal_type form-select">
                                                    <option value="">--Aucun--</option>
                                                    {% for metal in metals %}
                                                        <option value="{{ metal.id }}" {% if metal.name == 'Or' %}selected{% endif %}>{{ metal.name }}</option>
                                                    {% endfor %}
                                                </select>
                                            </div>
                                            <div class="form-group" style="margin-bottom: 0;">
                                                <label class="form-label">Purete</label>
                                                <select name="product_purity" class="product_purity form-select">
                                                    <option value="">--Aucune--</option>
                                                    {% for purity in purities %}
                                                        <option value="{{ purity.id }}" {% if purity.name == 'Or 18 carats' %}selected{% endif %}>{{ purity.name }}</option>
                                                    {% endfor %}
                                                </select>
                                            </div>
                                            <div class="form-group" style="margin-bottom: 0;">
                                                <label class="form-label">Fournisseur</label>
                                                <select name="product_supplier" class="product_supplier form-select">
                                                    <option value="">--Aucun--</option>
                                                    {% for supplier in suppliers %}
                                                        <option value="{{ supplier.id }}">{{ supplier.name }}</option>
                                                    {% endfor %}
                                                </select>
                                            </div>
                                            <div class="form-group" style="margin-bottom: 0;">
                                                <label class="form-label">Compte Bancaire</label>
                                                <select name="product_bank_account" class="product_bank_account form-select">
                                                    <option value="">--Aucun--</option>
                                                    {% for bank in bank_accounts %}
                                                        <option value="{{ bank.id }}">{{ bank.bank_name }}</option>
                                                    {% endfor %}
                                                </select>
                                            </div>
                                            <div class="form-group" style="margin-bottom: 0;">
                                                <label class="form-label">Cout Total (DH)</label>
                                                <input type="number" name="product_total_cost" class="product_total_cost form-input" step="0.01" min="0" readonly
                                                    style="background: var(--success-50); border-color: var(--success-300); color: var(--success-700); font-weight: 600;">
                                            </div>
                                        </div>
                                        <!-- Image Upload Section -->
                                        <div class="mt-4" style="border-top: 1px solid var(--neutral-200); padding-top: var(--space-4);">
                                            <div class="form-group" style="margin-bottom: 0;">
                                                <label class="form-label"><i class="fas fa-image mr-1"></i> Image du Produit</label>
                                                <div class="image-upload-area">
                                                    <input type="file" name="product_image_0" class="product_image form-input" accept="image/*" style="display: none;">
                                                    <div class="image-upload-trigger" onclick="this.previousElementSibling.click()">
                                                        <i class="fas fa-camera"></i>
                                                        <span>Cliquez pour ajouter une image</span>
                                                    </div>
                                                    <div class="image-preview-container" style="display: none;">
                                                        <img class="image-preview" src="" alt="Preview">
                                                        <button type="button" class="btn btn-error btn-sm remove-image-btn">
                                                            <i class="fas fa-times"></i>
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Mobile View -->
                <div class="mobile-view">
                    <div class="mobile-products-list" id="mobile_products_list">
                        <!-- Template mobile card -->
                        <div class="mobile-product-card product_item_mobile" data-index="0">
                            <div class="mobile-product-header">
                                <span class="mobile-product-number">Produit #1</span>
                                <button type="button" class="btn btn-error btn-sm remove_product_mobile" style="display: none;">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                            <div class="mobile-product-form">
                                <div class="form-group">
                                    <label class="form-label">Nom du Produit</label>
                                    <input type="text" name="product_name" class="product_name_mobile form-input" placeholder="Produit 1">
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label class="form-label">Categorie *</label>
                                        <select name="product_category" class="product_category_mobile form-select">
                                            <option value="">--Select--</option>
                                            {% for category in categories %}
                                                <option value="{{ category.id }}">{{ category.name }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Type *</label>
                                        <select name="product_type" class="product_type_mobile form-select">
                                            {% for value, label in product_types %}
                                                <option value="{{ value }}" {% if value == 'finished' %}selected{% endif %}>{{ label }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label class="form-label">Poids Net (g) *</label>
                                        <input type="number" name="product_weight" class="product_weight_mobile form-input"
                                            step="0.001" min="0">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Prix Vente (DH)</label>
                                        <input type="number" name="product_selling_price" class="product_selling_price_mobile form-input form-input-highlight"
                                            step="0.01" min="0" placeholder="Auto">
                                    </div>
                                </div>
                                <!-- Expandable details -->
                                <details class="mobile-product-details">
                                    <summary class="mobile-details-toggle">
                                        <i class="fas fa-chevron-down"></i>
                                        <span>Details supplementaires</span>
                                    </summary>
                                    <div class="mobile-details-content">
                                        <div class="form-row">
                                            <div class="form-group">
                                                <label class="form-label">Metal</label>
                                                <select name="product_metal_type" class="product_metal_type_mobile form-select">
                                                    <option value="">--Aucun--</option>
                                                    {% for metal in metals %}
                                                        <option value="{{ metal.id }}" {% if metal.name == 'Or' %}selected{% endif %}>{{ metal.name }}</option>
                                                    {% endfor %}
                                                </select>
                                            </div>
                                            <div class="form-group">
                                                <label class="form-label">Purete</label>
                                                <select name="product_purity" class="product_purity_mobile form-select">
                                                    <option value="">--Aucune--</option>
                                                    {% for purity in purities %}
                                                        <option value="{{ purity.id }}" {% if purity.name == 'Or 18 carats' %}selected{% endif %}>{{ purity.name }}</option>
                                                    {% endfor %}
                                                </select>
                                            </div>
                                        </div>
                                        <div class="form-row">
                                            <div class="form-group">
                                                <label class="form-label">Fournisseur</label>
                                                <select name="product_supplier" class="product_supplier_mobile form-select">
                                                    <option value="">--Aucun--</option>
                                                    {% for supplier in suppliers %}
                                                        <option value="{{ supplier.id }}">{{ supplier.name }}</option>
                                                    {% endfor %}
                                                </select>
                                            </div>
                                            <div class="form-group">
                                                <label class="form-label">Compte Bancaire</label>
                                                <select name="product_bank_account" class="product_bank_account_mobile form-select">
                                                    <option value="">--Aucun--</option>
                                                    {% for bank in bank_accounts %}
                                                        <option value="{{ bank.id }}">{{ bank.bank_name }}</option>
                                                    {% endfor %}
                                                </select>
                                            </div>
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">Cout Total (DH)</label>
                                            <input type="number" name="product_total_cost" class="product_total_cost_mobile form-input" step="0.01" min="0" readonly
                                                style="background: var(--success-50); border-color: var(--success-300); color: var(--success-700); font-weight: 600;">
                                        </div>
                                        <!-- Image Upload Section (Mobile) -->
                                        <div class="form-group">
                                            <label class="form-label"><i class="fas fa-image mr-1"></i> Image du Produit</label>
                                            <div class="image-upload-area-mobile">
                                                <input type="file" name="product_image_0" class="product_image_mobile" accept="image/*" style="display: none;">
                                                <div class="image-upload-trigger-mobile" onclick="this.previousElementSibling.click()">
                                                    <i class="fas fa-camera"></i>
                                                    <span>Ajouter une image</span>
                                                </div>
                                                <div class="image-preview-container-mobile" style="display: none;">
                                                    <img class="image-preview-mobile" src="" alt="Preview">
                                                    <button type="button" class="btn btn-error btn-sm remove-image-btn-mobile">
                                                        <i class="fas fa-times"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </details>
                            </div>
                        </div>
                    </div>
                </div>

                <button type="button" id="add_product_btn" class="btn btn-secondary mt-4">
                    <i class="fas fa-plus"></i>
                    <span>Ajouter une Ligne</span>
                </button>
            </div>

            <!-- Summary -->
            <div class="p-4 rounded-lg" style="background: var(--info-50); border: 1px solid var(--info-200);">
                <h3 class="font-semibold mb-2" style="color: var(--info-700);">
                    <i class="fas fa-calculator mr-2"></i> Resume
                </h3>
                <p class="text-sm" style="color: var(--info-600);">
                    <strong id="total_products">1</strong> produit(s) a creer
                </p>
                <p class="text-sm mt-2" style="color: var(--info-600);">
                    Cout total estime: <strong id="total_estimated_cost">0.00</strong> DH
                </p>
            </div>

            <!-- Print Option -->
            <div class="p-4 rounded-lg mt-6" style="background: var(--success-50); border: 1px solid var(--success-200);">
                <label class="flex items-center gap-3 cursor-pointer">
                    <input type="checkbox" name="print_labels" id="print_labels" value="1"
                        style="width: 20px; height: 20px; accent-color: var(--success-600);">
                    <div>
                        <span class="font-semibold" style="color: var(--success-700);">
                            <i class="fas fa-print mr-2"></i>Imprimer les etiquettes
                        </span>
                        <p class="text-sm" style="color: var(--success-600);">
                            Les etiquettes seront envoyees a l'imprimante Zebra apres la creation des produits
                        </p>
                    </div>
                </label>
            </div>
        </div>

        <!-- Form Actions -->
        <div class="card-footer">
            <a href="{% url 'products:list' %}" class="btn btn-secondary">
                Annuler
            </a>
            <button type="submit" class="btn btn-primary">
                <i class="fas fa-save"></i>
                <span>Creer les Produits</span>
            </button>
        </div>
    </form>

    <!-- Help Section -->
    <div class="card mt-6 animate-slide-up" style="animation-delay: 100ms;">
        <div class="card-header">
            <h3><i class="fas fa-question-circle mr-2"></i> Aide et Conseils</h3>
        </div>
        <div class="card-body">
            <div class="grid grid-cols-2 gap-6">
                <div>
                    <h4 class="font-semibold mb-2">Parametres Communs</h4>
                    <p class="text-sm text-muted">Les parametres communs s'appliquent a tous les produits de ce lot.</p>
                </div>
                <div>
                    <h4 class="font-semibold mb-2">Cout Automatique</h4>
                    <p class="text-sm text-muted">Le cout total de chaque produit = (Poids x Prix/g) + Main d'oeuvre + Pierres + Autres</p>
                </div>
                <div>
                    <h4 class="font-semibold mb-2">Exemple</h4>
                    <p class="text-sm text-muted">Si poids=10g, prix/g=800 DH, main d'oeuvre=100 DH:</p>
                    <p class="font-mono text-primary">(10 x 800) + 100 = 8100 DH</p>
                </div>
                <div>
                    <h4 class="font-semibold mb-2">Prix de Vente</h4>
                    <p class="text-sm text-muted">Vous pouvez modifier le prix de vente pour chaque produit individuellement en cliquant sur le detail du produit.</p>
                </div>
            </div>
        </div>
    </div>

    <style>
        /* Desktop/Mobile Views */
        .desktop-view {
            display: block;
        }

        .mobile-view {
            display: none;
        }

        /* Mobile Product Cards */
        .mobile-products-list {
            display: flex;
            flex-direction: column;
            gap: var(--space-4);
        }

        .mobile-product-card {
            background: white;
            border: 1px solid var(--neutral-200);
            border-radius: var(--radius-lg);
            padding: var(--space-4);
        }

        .mobile-product-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-4);
            padding-bottom: var(--space-3);
            border-bottom: 1px solid var(--neutral-200);
        }

        .mobile-product-number {
            font-weight: var(--font-semibold);
            color: var(--neutral-800);
        }

        .mobile-product-form {
            display: flex;
            flex-direction: column;
            gap: var(--space-3);
        }

        .mobile-product-details {
            margin-top: var(--space-3);
        }

        .mobile-details-toggle {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            padding: var(--space-2) var(--space-3);
            background: var(--neutral-50);
            border-radius: var(--radius-md);
            cursor: pointer;
            font-size: var(--text-sm);
            color: var(--neutral-600);
        }

        .mobile-details-toggle:hover {
            background: var(--neutral-100);
        }

        .mobile-details-toggle i {
            transition: transform 0.2s ease;
        }

        .mobile-product-details[open] .mobile-details-toggle i {
            transform: rotate(180deg);
        }

        .mobile-details-content {
            padding: var(--space-4);
            margin-top: var(--space-3);
            background: var(--neutral-50);
            border-radius: var(--radius-md);
            display: flex;
            flex-direction: column;
            gap: var(--space-3);
        }

        .form-input-highlight {
            background: var(--accent-50) !important;
            border-color: var(--accent-300) !important;
        }

        /* Image Upload Styles */
        .image-upload-area,
        .image-upload-area-mobile {
            position: relative;
        }

        .image-upload-trigger,
        .image-upload-trigger-mobile {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            padding: var(--space-3);
            border: 2px dashed var(--neutral-300);
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all 0.2s ease;
            background: white;
        }

        .image-upload-trigger:hover,
        .image-upload-trigger-mobile:hover {
            border-color: var(--primary-400);
            background: var(--primary-50);
        }

        .image-upload-trigger i,
        .image-upload-trigger-mobile i {
            color: var(--neutral-400);
            font-size: 1.25rem;
        }

        .image-upload-trigger span,
        .image-upload-trigger-mobile span {
            color: var(--neutral-500);
            font-size: var(--text-sm);
        }

        .image-preview-container,
        .image-preview-container-mobile {
            position: relative;
            display: inline-block;
        }

        .image-preview,
        .image-preview-mobile {
            width: 100px;
            height: 100px;
            object-fit: cover;
            border-radius: var(--radius-md);
            border: 2px solid var(--neutral-200);
        }

        .remove-image-btn,
        .remove-image-btn-mobile {
            position: absolute;
            top: -8px;
            right: -8px;
            width: 24px;
            height: 24px;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .desktop-view {
                display: none;
            }

            .mobile-view {
                display: block;
            }

            .form-row {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: var(--space-3);
            }

            .grid-cols-2 {
                grid-template-columns: 1fr;
            }
        }
    </style>

    <script>
        // Mobile functionality
        const mobileProductsList = document.getElementById('mobile_products_list');
        const mobileTemplateCard = document.querySelector('.product_item_mobile');
        let mobileProductCount = 1;

        // Setup expand/collapse for detail rows
        function setupExpandToggle(item) {
            const toggleBtn = item.querySelector('.expand-toggle');
            const mainRow = item;
            const detailRow = mainRow.nextElementSibling;

            if (toggleBtn && detailRow && detailRow.classList.contains('detail-row')) {
                toggleBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    const isHidden = detailRow.style.display === 'none';
                    detailRow.style.display = isHidden ? 'table-row' : 'none';
                    const icon = toggleBtn.querySelector('i');
                    icon.classList.toggle('fa-chevron-down', !isHidden);
                    icon.classList.toggle('fa-chevron-up', isHidden);
                });
            }
        }

        // Add product row - handles both desktop and mobile views
        document.getElementById('add_product_btn').addEventListener('click', function(e) {
            e.preventDefault();

            // Check if we're in mobile view
            if (window.innerWidth <= 768) {
                addMobileProductCard();
            } else {
                addDesktopProductRow();
            }
        });

        // Add desktop product row
        function addDesktopProductRow() {
            const productsList = document.getElementById('products_list');
            const templateRow = document.querySelector('.product_item');
            const newMainRow = templateRow.cloneNode(true);
            const templateDetailRow = templateRow.nextElementSibling;
            const newDetailRow = templateDetailRow.cloneNode(true);

            // Clear values in cloned items
            newMainRow.querySelectorAll('input').forEach(input => {
                input.value = '';
            });
            newDetailRow.querySelectorAll('input:not([type="file"])').forEach(input => {
                input.value = '';
            });
            // Reset file input
            const fileInput = newDetailRow.querySelector('.product_image');
            if (fileInput) {
                fileInput.value = '';
            }
            // Reset image preview
            const previewContainer = newDetailRow.querySelector('.image-preview-container');
            const uploadTrigger = newDetailRow.querySelector('.image-upload-trigger');
            if (previewContainer) previewContainer.style.display = 'none';
            if (uploadTrigger) uploadTrigger.style.display = 'flex';

            newDetailRow.style.display = 'none';

            // Reset expand toggle icon
            const icon = newMainRow.querySelector('.expand-toggle i');
            if (icon) {
                icon.classList.remove('fa-chevron-up');
                icon.classList.add('fa-chevron-down');
            }

            // Append both rows
            productsList.appendChild(newMainRow);
            productsList.appendChild(newDetailRow);

            // Get the new index
            const newIndex = document.querySelectorAll('.product_item').length - 1;

            // Setup event listeners
            attachEventListeners(newMainRow);
            setupExpandToggle(newMainRow);
            setupImageUpload(newDetailRow, newIndex);
            updateRemoveButtons();
            updateImageInputNames();
            calculatePreview();
        }

        // Add mobile product card
        function addMobileProductCard() {
            mobileProductCount++;
            const newCard = mobileTemplateCard.cloneNode(true);

            // Update card number
            newCard.setAttribute('data-index', mobileProductCount - 1);
            newCard.querySelector('.mobile-product-number').textContent = 'Produit #' + mobileProductCount;

            // Clear input values (except file inputs)
            newCard.querySelectorAll('input:not([type="file"])').forEach(input => {
                input.value = '';
            });
            // Reset file input
            const fileInput = newCard.querySelector('.product_image_mobile');
            if (fileInput) {
                fileInput.value = '';
            }
            // Reset image preview
            const previewContainer = newCard.querySelector('.image-preview-container-mobile');
            const uploadTrigger = newCard.querySelector('.image-upload-trigger-mobile');
            if (previewContainer) previewContainer.style.display = 'none';
            if (uploadTrigger) uploadTrigger.style.display = 'flex';

            newCard.querySelectorAll('select').forEach(select => {
                // Reset to first option or default
                if (select.classList.contains('product_type_mobile')) {
                    // Keep finished as default
                    select.value = 'finished';
                } else {
                    select.selectedIndex = 0;
                }
            });

            // Close details section
            const details = newCard.querySelector('details');
            if (details) {
                details.removeAttribute('open');
            }

            // Show remove button
            const removeBtn = newCard.querySelector('.remove_product_mobile');
            if (removeBtn) {
                removeBtn.style.display = 'inline-flex';
                removeBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    removeMobileProduct(this);
                });
            }

            // Add change listeners for calculation
            newCard.querySelectorAll('input, select').forEach(input => {
                input.addEventListener('change', calculatePreview);
            });

            // Append card
            mobileProductsList.appendChild(newCard);

            // Setup image upload for new card
            const newIndex = document.querySelectorAll('.product_item_mobile').length - 1;
            setupMobileImageUpload(newCard, newIndex);

            updateRemoveButtons();
            updateImageInputNames();
            calculatePreview();
        }

        // Remove mobile product card
        function removeMobileProduct(btn) {
            const card = btn.closest('.product_item_mobile');
            card.remove();
            updateMobileProductNumbers();
            updateRemoveButtons();
            calculatePreview();
        }

        // Update mobile product numbers after removal
        function updateMobileProductNumbers() {
            const cards = document.querySelectorAll('.product_item_mobile');
            cards.forEach((card, index) => {
                card.setAttribute('data-index', index);
                card.querySelector('.mobile-product-number').textContent = 'Produit #' + (index + 1);
            });
            mobileProductCount = cards.length;
        }

        // Remove product row
        function removeProduct(btn) {
            const mainRow = btn.closest('.product_item');
            const detailRow = mainRow.nextElementSibling;
            mainRow.remove();
            if (detailRow && detailRow.classList.contains('detail-row')) {
                detailRow.remove();
            }
            updateRemoveButtons();
            calculatePreview();
        }

        // Attach event listeners to product items
        function attachEventListeners(item) {
            const removeBtn = item.querySelector('.remove_product');
            if (removeBtn) {
                removeBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    removeProduct(this);
                });
            }

            const inputs = item.querySelectorAll('input, select');
            inputs.forEach(input => {
                input.addEventListener('change', calculatePreview);
            });

            // Track manual edits to selling price
            const sellingPriceInput = item.querySelector('.product_selling_price');
            if (sellingPriceInput) {
                sellingPriceInput.addEventListener('input', function() {
                    this.dataset.manuallyEdited = 'true';
                });
                // Double-click to reset to auto-calculation
                sellingPriceInput.addEventListener('dblclick', function() {
                    this.value = '';
                    delete this.dataset.manuallyEdited;
                    calculatePreview();
                });
            }

            const detailRow = item.nextElementSibling;
            if (detailRow && detailRow.classList.contains('detail-row')) {
                const detailInputs = detailRow.querySelectorAll('input, select');
                detailInputs.forEach(input => {
                    input.addEventListener('change', calculatePreview);
                });
            }
        }

        // Update remove buttons visibility for both views
        function updateRemoveButtons() {
            // Desktop view
            const desktopItems = document.querySelectorAll('.product_item');
            desktopItems.forEach(item => {
                const removeBtn = item.querySelector('.remove_product');
                if (removeBtn) {
                    removeBtn.style.display = desktopItems.length > 1 ? 'inline-flex' : 'none';
                }
            });

            // Mobile view
            const mobileItems = document.querySelectorAll('.product_item_mobile');
            mobileItems.forEach(item => {
                const removeBtn = item.querySelector('.remove_product_mobile');
                if (removeBtn) {
                    removeBtn.style.display = mobileItems.length > 1 ? 'inline-flex' : 'none';
                }
            });
        }

        // Calculate costs and selling prices for both desktop and mobile views
        function calculatePreview() {
            const pricePerGram = parseFloat(document.getElementById('purchase_price_per_gram').value) || 0;
            const laborCost = parseFloat(document.getElementById('labor_cost').value) || 0;
            const stoneCost = parseFloat(document.getElementById('stone_cost').value) || 0;
            const otherCost = parseFloat(document.getElementById('other_cost').value) || 0;

            const marginType = document.getElementById('margin_type_batch').value;
            const marginValue = parseFloat(document.getElementById('margin_value_batch').value) || 0;

            let totalEstimated = 0;
            let productCount = 0;
            let rowNumber = 0;

            const isMobile = window.innerWidth <= 768;

            if (isMobile) {
                // Mobile view calculation
                document.querySelectorAll('.product_item_mobile').forEach((card, index) => {
                    const weight = parseFloat(card.querySelector('.product_weight_mobile').value) || 0;

                    if (weight <= 0) {
                        return;
                    }

                    rowNumber++;
                    const metalCost = weight * pricePerGram;
                    const totalCost = metalCost + laborCost + stoneCost + otherCost;

                    // Update total cost in mobile details
                    const totalCostInput = card.querySelector('.product_total_cost_mobile');
                    if (totalCostInput) {
                        totalCostInput.value = totalCost.toFixed(2);
                    }

                    let sellingPriceCalc;
                    if (marginType === 'percentage') {
                        sellingPriceCalc = totalCost + (totalCost * marginValue / 100);
                    } else {
                        sellingPriceCalc = totalCost + marginValue;
                    }

                    const finalPrice = card.querySelector('.product_selling_price_mobile');
                    // Always update unless user manually edited (check data attribute)
                    if (finalPrice && !finalPrice.dataset.manuallyEdited) {
                        finalPrice.value = sellingPriceCalc.toFixed(2);
                    }

                    const productNameInput = card.querySelector('.product_name_mobile');
                    if (productNameInput && (!productNameInput.value || productNameInput.value.trim() === '')) {
                        productNameInput.value = `Produit ${rowNumber}`;
                    }

                    totalEstimated += totalCost;
                    productCount++;
                });
            } else {
                // Desktop view calculation
                document.querySelectorAll('.product_item').forEach((item, index) => {
                    const weight = parseFloat(item.querySelector('.product_weight').value) || 0;

                    if (weight <= 0) {
                        return;
                    }

                    rowNumber++;
                    const metalCost = weight * pricePerGram;
                    const totalCost = metalCost + laborCost + stoneCost + otherCost;

                    const detailRow = item.nextElementSibling;
                    if (detailRow && detailRow.classList.contains('detail-row')) {
                        detailRow.querySelector('.product_total_cost').value = totalCost.toFixed(2);
                    }

                    let sellingPriceCalc;
                    if (marginType === 'percentage') {
                        sellingPriceCalc = totalCost + (totalCost * marginValue / 100);
                    } else {
                        sellingPriceCalc = totalCost + marginValue;
                    }

                    const finalPrice = item.querySelector('.product_selling_price');

                    // Always update unless user manually edited (check data attribute)
                    if (!finalPrice.dataset.manuallyEdited) {
                        finalPrice.value = sellingPriceCalc.toFixed(2);
                        finalPrice.style.background = 'var(--accent-50)';
                        finalPrice.style.borderColor = 'var(--accent-300)';
                    } else {
                        finalPrice.style.background = 'white';
                        finalPrice.style.borderColor = 'var(--primary-300)';
                    }

                    const productNameInput = item.querySelector('.product_name');
                    if (!productNameInput.value || productNameInput.value.trim() === '') {
                        productNameInput.value = `Produit ${rowNumber}`;
                    }

                    totalEstimated += totalCost;
                    productCount++;
                });
            }

            document.getElementById('total_products').textContent = productCount;
            document.getElementById('total_estimated_cost').textContent = totalEstimated.toFixed(2);
        }

        // Update margin unit display
        function updateMarginUnit() {
            const marginTypeSelect = document.getElementById('margin_type_batch');
            const marginUnit = document.getElementById('margin_unit_batch');
            marginUnit.textContent = marginTypeSelect.value === 'percentage' ? '%' : 'DH';
        }

        // Attach event listeners to mobile product cards
        function attachMobileEventListeners(card) {
            const removeBtn = card.querySelector('.remove_product_mobile');
            if (removeBtn) {
                removeBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    removeMobileProduct(this);
                });
            }

            const inputs = card.querySelectorAll('input, select');
            inputs.forEach(input => {
                input.addEventListener('change', calculatePreview);
            });

            // Track manual edits to selling price (mobile)
            const sellingPriceInput = card.querySelector('.product_selling_price_mobile');
            if (sellingPriceInput) {
                sellingPriceInput.addEventListener('input', function() {
                    this.dataset.manuallyEdited = 'true';
                });
                // Double-click to reset to auto-calculation
                sellingPriceInput.addEventListener('dblclick', function() {
                    this.value = '';
                    delete this.dataset.manuallyEdited;
                    calculatePreview();
                });
            }
        }

        // Image upload handling for desktop
        function setupImageUpload(detailRow, index) {
            const imageInput = detailRow.querySelector('.product_image');
            const uploadTrigger = detailRow.querySelector('.image-upload-trigger');
            const previewContainer = detailRow.querySelector('.image-preview-container');
            const previewImg = detailRow.querySelector('.image-preview');
            const removeBtn = detailRow.querySelector('.remove-image-btn');

            if (!imageInput) return;

            // Update input name with correct index
            imageInput.name = `product_image_${index}`;

            imageInput.addEventListener('change', function() {
                if (this.files && this.files[0]) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        previewImg.src = e.target.result;
                        previewContainer.style.display = 'inline-block';
                        uploadTrigger.style.display = 'none';
                    };
                    reader.readAsDataURL(this.files[0]);
                }
            });

            if (removeBtn) {
                removeBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    imageInput.value = '';
                    previewContainer.style.display = 'none';
                    uploadTrigger.style.display = 'flex';
                });
            }
        }

        // Image upload handling for mobile
        function setupMobileImageUpload(card, index) {
            const imageInput = card.querySelector('.product_image_mobile');
            const uploadTrigger = card.querySelector('.image-upload-trigger-mobile');
            const previewContainer = card.querySelector('.image-preview-container-mobile');
            const previewImg = card.querySelector('.image-preview-mobile');
            const removeBtn = card.querySelector('.remove-image-btn-mobile');

            if (!imageInput) return;

            // Update input name with correct index
            imageInput.name = `product_image_${index}`;

            imageInput.addEventListener('change', function() {
                if (this.files && this.files[0]) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        previewImg.src = e.target.result;
                        previewContainer.style.display = 'inline-block';
                        uploadTrigger.style.display = 'none';
                    };
                    reader.readAsDataURL(this.files[0]);
                }
            });

            if (removeBtn) {
                removeBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    imageInput.value = '';
                    previewContainer.style.display = 'none';
                    uploadTrigger.style.display = 'flex';
                });
            }
        }

        // Update all image input names based on row index
        function updateImageInputNames() {
            // Desktop
            document.querySelectorAll('.product_item').forEach((item, index) => {
                const detailRow = item.nextElementSibling;
                if (detailRow && detailRow.classList.contains('detail-row')) {
                    const imageInput = detailRow.querySelector('.product_image');
                    if (imageInput) {
                        imageInput.name = `product_image_${index}`;
                    }
                }
            });

            // Mobile
            document.querySelectorAll('.product_item_mobile').forEach((card, index) => {
                const imageInput = card.querySelector('.product_image_mobile');
                if (imageInput) {
                    imageInput.name = `product_image_${index}`;
                }
            });
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            // Desktop view initialization
            document.querySelectorAll('.product_item').forEach((item, index) => {
                attachEventListeners(item);
                setupExpandToggle(item);
                const detailRow = item.nextElementSibling;
                if (detailRow && detailRow.classList.contains('detail-row')) {
                    setupImageUpload(detailRow, index);
                }
            });

            // Mobile view initialization
            document.querySelectorAll('.product_item_mobile').forEach((card, index) => {
                attachMobileEventListeners(card);
                setupMobileImageUpload(card, index);
            });

            updateRemoveButtons();
            calculatePreview();

            // Recalculate on window resize
            window.addEventListener('resize', function() {
                calculatePreview();
            });

            const marginTypeSelect = document.getElementById('margin_type_batch');
            if (marginTypeSelect) {
                marginTypeSelect.addEventListener('change', function() {
                    updateMarginUnit();
                    calculatePreview();
                });
            }
        });
    </script>
{% endblock %}
