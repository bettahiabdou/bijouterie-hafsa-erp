{% extends 'base.html' %}

{% block title %}Achat via Dépôt - {{ account.client.full_name }} - Bijouterie Hafsa ERP{% endblock %}

{% block breadcrumb %}
    <span class="breadcrumb-separator">/</span>
    <a href="{% url 'deposits:list' %}" class="breadcrumb-item">Comptes Dépôt</a>
    <span class="breadcrumb-separator">/</span>
    <a href="{% url 'deposits:detail' account.pk %}" class="breadcrumb-item">{{ account.client.full_name }}</a>
    <span class="breadcrumb-separator">/</span>
    <span class="breadcrumb-item active">Achat</span>
{% endblock %}

{% block page_header %}
    <div class="page-header">
        <div class="page-header-inner">
            <div>
                <h1 class="page-title">Achat via Dépôt</h1>
                <p class="page-subtitle">
                    Client: <strong>{{ account.client.full_name }}</strong> |
                    Solde: <strong class="{% if account.balance > 0 %}text-success{% else %}text-error{% endif %}">{{ account.balance|floatformat:2 }} DH</strong>
                </p>
            </div>
            <div class="page-actions">
                <a href="{% url 'deposits:detail' account.pk %}" class="btn btn-ghost">
                    <i class="fas fa-arrow-left"></i>
                    <span>Retour</span>
                </a>
            </div>
        </div>
    </div>
{% endblock %}

{% block content %}
    <form method="post" action="{% url 'deposits:make_purchase' account.pk %}" id="purchaseForm">
        {% csrf_token %}

        <div class="grid grid-cols-3 gap-6">
            <!-- Product Selection -->
            <div class="card animate-slide-up" style="grid-column: span 2;">
                <div class="card-header">
                    <h3><i class="fas fa-gem mr-2"></i> Sélection des Produits</h3>
                </div>
                <div class="card-body" style="padding: 0;">
                    <!-- Search & Filters -->
                    <div class="p-4 border-b" style="border-color: var(--neutral-100);">
                        <div class="filter-grid">
                            <div class="form-group" style="margin-bottom: 0;">
                                <input type="text" id="productSearch" placeholder="Rechercher..." class="form-input" value="{{ search_query }}">
                            </div>
                            <div class="form-group" style="margin-bottom: 0;">
                                <select id="categoryFilter" class="form-select">
                                    <option value="">Toutes catégories</option>
                                    {% for cat in categories %}
                                        <option value="{{ cat.pk }}" {% if category_id == cat.pk|stringformat:"s" %}selected{% endif %}>{{ cat.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="form-group" style="margin-bottom: 0;">
                                <button type="button" onclick="applyFilters()" class="btn btn-secondary">
                                    <i class="fas fa-search"></i> Filtrer
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Products Table -->
                    <div class="table-wrapper" style="border: none; border-radius: 0;">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th style="width: 50px;">
                                        <input type="checkbox" id="selectAll" onchange="toggleSelectAll(this)">
                                    </th>
                                    <th>Référence</th>
                                    <th>Description</th>
                                    <th>Catégorie</th>
                                    <th>Prix Original</th>
                                    <th>Prix de Vente</th>
                                    <th>Remise</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for product in products %}
                                    <tr data-price="{{ product.selling_price|stringformat:'.2f' }}" data-product-id="{{ product.pk }}" data-reference="{{ product.reference }}" data-description="{{ product.description|default:'' }}">
                                        <td>
                                            <input type="checkbox" class="product-checkbox" data-product-id="{{ product.pk }}">
                                        </td>
                                        <td>
                                            <span class="font-semibold text-primary">{{ product.reference }}</span>
                                        </td>
                                        <td>{{ product.description|default:"-"|truncatewords:10 }}</td>
                                        <td>
                                            {% if product.category %}
                                                <span class="badge badge-neutral">{{ product.category.name }}</span>
                                            {% else %}
                                                -
                                            {% endif %}
                                        </td>
                                        <td class="font-semibold original-price">{{ product.selling_price|floatformat:2 }} DH</td>
                                        <td>
                                            <input type="number"
                                                   class="form-input selling-price-input"
                                                   style="width: 100px;"
                                                   step="0.01"
                                                   min="0"
                                                   value="{{ product.selling_price|stringformat:'.2f' }}"
                                                   data-original="{{ product.selling_price|stringformat:'.2f' }}">
                                        </td>
                                        <td>
                                            <input type="number"
                                                   class="form-input discount-input"
                                                   style="width: 80px;"
                                                   step="0.01"
                                                   min="0"
                                                   value="0"
                                                   data-product-id="{{ product.pk }}">
                                        </td>
                                    </tr>
                                {% empty %}
                                    <tr>
                                        <td colspan="7">
                                            <div class="empty-state" style="padding: var(--space-8);">
                                                <div class="empty-state-icon">
                                                    <i class="fas fa-gem"></i>
                                                </div>
                                                <h4 class="empty-state-title">Aucun produit disponible</h4>
                                                <p class="empty-state-text">Il n'y a pas de produits disponibles à la vente.</p>
                                            </div>
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>

                    <!-- Confirm Selection Button -->
                    <div class="p-4 border-t" style="border-color: var(--neutral-100);">
                        <button type="button" onclick="confirmSelection()" class="btn btn-primary" id="confirmBtn">
                            <i class="fas fa-check-circle mr-2"></i> Confirmer la Sélection (<span id="selectionCount">0</span>)
                        </button>
                    </div>

                    <!-- Pagination -->
                    {% if page_obj.has_other_pages %}
                        <div class="card-footer">
                            <div class="pagination">
                                {% if page_obj.has_previous %}
                                    <a href="?page={{ page_obj.previous_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}{% if category_id %}&category={{ category_id }}{% endif %}" class="pagination-btn">
                                        <i class="fas fa-chevron-left"></i>
                                    </a>
                                {% endif %}

                                <span class="pagination-info">
                                    Page {{ page_obj.number }} sur {{ page_obj.paginator.num_pages }}
                                </span>

                                {% if page_obj.has_next %}
                                    <a href="?page={{ page_obj.next_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}{% if category_id %}&category={{ category_id }}{% endif %}" class="pagination-btn">
                                        <i class="fas fa-chevron-right"></i>
                                    </a>
                                {% endif %}
                            </div>
                        </div>
                    {% endif %}
                </div>
            </div>

            <!-- Payment Summary -->
            <div class="card animate-slide-up sticky-card">
                <div class="card-header">
                    <h3><i class="fas fa-calculator mr-2"></i> Récapitulatif</h3>
                </div>
                <div class="card-body">
                    <!-- Balance Info -->
                    <div class="balance-box mb-4">
                        <div class="balance-label">Solde Disponible</div>
                        <div class="balance-value {% if account.balance > 0 %}text-success{% else %}text-error{% endif %}">
                            {{ account.balance|floatformat:2 }} DH
                        </div>
                    </div>

                    <!-- Confirmed Products List -->
                    <div class="confirmed-products-section mb-4">
                        <h4 class="section-title mb-2">Produits Confirmés</h4>
                        <div id="confirmedProductsList" class="confirmed-products-list">
                            <div class="empty-selection">
                                <i class="fas fa-hand-pointer"></i>
                                <p>Sélectionnez des produits et cliquez sur "Confirmer la Sélection"</p>
                            </div>
                        </div>
                    </div>

                    <!-- Hidden inputs for form submission -->
                    <div id="hiddenInputsContainer"></div>

                    <!-- Selected Products Summary -->
                    <div class="summary-box mb-4">
                        <div class="summary-row">
                            <span>Produits confirmés:</span>
                            <span id="selectedCount">0</span>
                        </div>
                        <div class="summary-row">
                            <span>Prix original:</span>
                            <span id="originalTotal">0.00 DH</span>
                        </div>
                        <div class="summary-row" id="discountRow" style="display: none;">
                            <span class="text-success">Remise totale:</span>
                            <span id="totalDiscount" class="text-success">-0.00 DH</span>
                        </div>
                        <div class="summary-row total">
                            <span>Total à payer:</span>
                            <span id="totalAmount">0.00 DH</span>
                        </div>
                    </div>

                    <!-- Payment Options -->
                    <div class="payment-section">
                        <h4 class="mb-3">Paiement</h4>

                        <div class="form-group">
                            <label class="form-label">Utiliser du dépôt (DH)</label>
                            <input type="number" name="use_deposit" id="useDeposit" class="form-input" step="0.01" min="0" max="{{ account.balance }}" value="0" oninput="onDepositChange()">
                            <small class="form-text">Max: {{ account.balance|floatformat:2 }} DH</small>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Paiement complémentaire (DH)</label>
                            <input type="number" name="additional_payment" id="additionalPayment" class="form-input" step="0.01" min="0" value="0" oninput="onAdditionalPaymentChange()">
                        </div>

                        <div class="form-group">
                            <label class="form-label">Mode de paiement (complémentaire)</label>
                            <select name="payment_method" id="paymentMethod" class="form-select" onchange="onPaymentMethodChange()">
                                <option value="" data-code="">-- Sélectionner --</option>
                                {% for pm in payment_methods %}
                                    <option value="{{ pm.pk }}" data-code="{{ pm.code|default:pm.name|lower }}">{{ pm.name }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="form-group" id="bankAccountGroup" style="display: none;">
                            <label class="form-label">Compte bancaire</label>
                            <select name="bank_account" class="form-select">
                                <option value="">-- Sélectionner --</option>
                                {% for ba in bank_accounts %}
                                    <option value="{{ ba.pk }}">{{ ba.name }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="form-group" id="paymentReferenceGroup" style="display: none;">
                            <label class="form-label">Référence</label>
                            <input type="text" name="payment_reference" class="form-input" placeholder="N° chèque, N° virement...">
                        </div>
                    </div>

                    <!-- Payment Summary -->
                    <div class="payment-summary mt-4 p-3 bg-neutral-50 rounded">
                        <div class="summary-row">
                            <span>Dépôt utilisé:</span>
                            <span id="depositUsed">0.00 DH</span>
                        </div>
                        <div class="summary-row">
                            <span>Paiement complémentaire:</span>
                            <span id="additionalUsed">0.00 DH</span>
                        </div>
                        <div class="summary-row total">
                            <span>Total payé:</span>
                            <span id="totalPaid">0.00 DH</span>
                        </div>
                        <div class="summary-row" id="remainingRow" style="display: none;">
                            <span class="text-error">Reste à payer:</span>
                            <span id="remaining" class="text-error">0.00 DH</span>
                        </div>
                    </div>

                    <div class="form-group mt-4">
                        <label class="form-label">Notes</label>
                        <textarea name="notes" class="form-input" rows="2" placeholder="Notes sur l'achat..."></textarea>
                    </div>

                    <button type="submit" class="btn btn-primary w-full mt-4" id="submitBtn" disabled>
                        <i class="fas fa-check"></i> Confirmer l'Achat
                    </button>
                </div>
            </div>
        </div>
    </form>

    <style>
        .filter-grid {
            display: grid;
            grid-template-columns: 1fr 1fr auto;
            gap: var(--space-4);
        }

        .sticky-card {
            position: sticky;
            top: var(--space-4);
        }

        .balance-box {
            text-align: center;
            padding: var(--space-4);
            background: var(--neutral-50);
            border-radius: var(--radius-md);
        }

        .balance-label {
            font-size: var(--text-sm);
            color: var(--neutral-500);
            margin-bottom: var(--space-1);
        }

        .balance-value {
            font-size: var(--text-2xl);
            font-weight: var(--font-bold);
        }

        .summary-box {
            padding: var(--space-3);
            background: var(--neutral-50);
            border-radius: var(--radius-md);
        }

        .summary-row {
            display: flex;
            justify-content: space-between;
            padding: var(--space-2) 0;
        }

        .summary-row.total {
            border-top: 1px solid var(--neutral-200);
            margin-top: var(--space-2);
            padding-top: var(--space-3);
            font-weight: var(--font-bold);
        }

        .payment-section h4, .section-title {
            font-size: var(--text-sm);
            font-weight: var(--font-semibold);
            color: var(--neutral-700);
        }

        .payment-summary {
            font-size: var(--text-sm);
        }

        .selling-price-input, .discount-input {
            padding: var(--space-2);
            font-size: var(--text-sm);
            text-align: right;
        }

        .selling-price-input:focus, .discount-input:focus {
            border-color: var(--primary-500);
            box-shadow: 0 0 0 3px rgba(var(--primary-500-rgb), 0.1);
        }

        /* Confirmed products list */
        .confirmed-products-section {
            border: 1px solid var(--neutral-200);
            border-radius: var(--radius-md);
            padding: var(--space-3);
        }

        .confirmed-products-list {
            max-height: 200px;
            overflow-y: auto;
        }

        .empty-selection {
            text-align: center;
            padding: var(--space-4);
            color: var(--neutral-400);
        }

        .empty-selection i {
            font-size: var(--text-2xl);
            margin-bottom: var(--space-2);
        }

        .empty-selection p {
            font-size: var(--text-sm);
            margin: 0;
        }

        .confirmed-product-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--space-2);
            border-bottom: 1px solid var(--neutral-100);
            font-size: var(--text-sm);
        }

        .confirmed-product-item:last-child {
            border-bottom: none;
        }

        .confirmed-product-info {
            flex: 1;
        }

        .confirmed-product-ref {
            font-weight: var(--font-semibold);
            color: var(--primary-600);
        }

        .confirmed-product-price {
            font-weight: var(--font-semibold);
            margin-left: var(--space-2);
        }

        .confirmed-product-discount {
            color: var(--success-600);
            font-size: var(--text-xs);
        }

        .remove-product-btn {
            background: none;
            border: none;
            color: var(--error-500);
            cursor: pointer;
            padding: var(--space-1);
            margin-left: var(--space-2);
        }

        .remove-product-btn:hover {
            color: var(--error-700);
        }

        @media (max-width: 1023px) {
            .grid-cols-3 {
                grid-template-columns: 1fr !important;
            }

            .card[style*="grid-column: span 2"] {
                grid-column: span 1 !important;
            }

            .sticky-card {
                position: static;
            }

            .filter-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>

    <script>
        const accountBalance = parseFloat("{{ account.balance|stringformat:'f' }}".replace(',', '.')) || 0;
        let confirmedProducts = {};  // Store confirmed products {id: {reference, description, originalPrice, sellingPrice, discount}}
        let selectedTotal = 0;
        let originalTotal = 0;
        let totalDiscount = 0;

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Handle discount input change
            document.querySelectorAll('.discount-input').forEach(input => {
                input.addEventListener('input', function() {
                    const row = this.closest('tr');
                    const priceInput = row.querySelector('.selling-price-input');
                    const originalPrice = parseFloat(priceInput.dataset.original) || 0;
                    const discount = parseFloat(this.value) || 0;

                    // Calculate new price after discount
                    const newPrice = Math.max(0, originalPrice - discount);
                    priceInput.value = newPrice.toFixed(2);
                });
            });

            // Handle selling price input change
            document.querySelectorAll('.selling-price-input').forEach(input => {
                input.addEventListener('input', function() {
                    const row = this.closest('tr');
                    const discountInput = row.querySelector('.discount-input');
                    const originalPrice = parseFloat(this.dataset.original) || 0;
                    const newPrice = parseFloat(this.value) || 0;

                    // Calculate discount
                    const discount = Math.max(0, originalPrice - newPrice);
                    discountInput.value = discount.toFixed(2);
                });
            });

            // Update selection count when checkboxes change
            document.querySelectorAll('.product-checkbox').forEach(cb => {
                cb.addEventListener('change', function() {
                    updateSelectionCount();
                    // Update selectAll checkbox state
                    const allCheckboxes = document.querySelectorAll('.product-checkbox');
                    const checkedCheckboxes = document.querySelectorAll('.product-checkbox:checked');
                    const selectAllCheckbox = document.getElementById('selectAll');
                    selectAllCheckbox.checked = allCheckboxes.length > 0 && allCheckboxes.length === checkedCheckboxes.length;
                    selectAllCheckbox.indeterminate = checkedCheckboxes.length > 0 && checkedCheckboxes.length < allCheckboxes.length;
                });
            });

            // Initialize selection count
            updateSelectionCount();
        });

        function toggleSelectAll(checkbox) {
            const checkboxes = document.querySelectorAll('.product-checkbox');
            checkboxes.forEach(cb => {
                cb.checked = checkbox.checked;
            });
            updateSelectionCount();
        }

        function updateSelectionCount() {
            const count = document.querySelectorAll('.product-checkbox:checked').length;
            document.getElementById('selectionCount').textContent = count;
        }

        function confirmSelection() {
            const checkedBoxes = document.querySelectorAll('.product-checkbox:checked');

            if (checkedBoxes.length === 0) {
                alert('Veuillez sélectionner au moins un produit.');
                return;
            }

            checkedBoxes.forEach(cb => {
                const row = cb.closest('tr');
                const productId = row.dataset.productId;
                const reference = row.dataset.reference;
                const description = row.dataset.description;
                const priceInput = row.querySelector('.selling-price-input');
                const discountInput = row.querySelector('.discount-input');

                const originalPrice = parseFloat(priceInput.dataset.original) || 0;
                const sellingPrice = parseFloat(priceInput.value) || 0;
                const discount = parseFloat(discountInput.value) || 0;

                // Add to confirmed products (overwrites if already exists)
                confirmedProducts[productId] = {
                    reference: reference,
                    description: description,
                    originalPrice: originalPrice,
                    sellingPrice: sellingPrice,
                    discount: discount
                };

                // Uncheck the checkbox
                cb.checked = false;

                // Visually mark the row as confirmed
                row.classList.add('confirmed-row');
            });

            // Update the selection count
            updateSelectionCount();

            // Update the confirmed products list
            renderConfirmedProducts();

            // Update totals and payment fields
            updateTotals();
        }

        function renderConfirmedProducts() {
            const container = document.getElementById('confirmedProductsList');
            const hiddenContainer = document.getElementById('hiddenInputsContainer');
            const productIds = Object.keys(confirmedProducts);

            if (productIds.length === 0) {
                container.innerHTML = `
                    <div class="empty-selection">
                        <i class="fas fa-hand-pointer"></i>
                        <p>Sélectionnez des produits et cliquez sur "Confirmer la Sélection"</p>
                    </div>
                `;
                hiddenContainer.innerHTML = '';
                return;
            }

            let html = '';
            let hiddenInputs = '';

            productIds.forEach(id => {
                const product = confirmedProducts[id];
                const discountText = product.discount > 0 ? `<span class="confirmed-product-discount">(-${product.discount.toFixed(2)} DH)</span>` : '';

                html += `
                    <div class="confirmed-product-item" data-product-id="${id}">
                        <div class="confirmed-product-info">
                            <span class="confirmed-product-ref">${product.reference}</span>
                            ${discountText}
                        </div>
                        <span class="confirmed-product-price">${product.sellingPrice.toFixed(2)} DH</span>
                        <button type="button" class="remove-product-btn" onclick="removeProduct('${id}')">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                `;

                // Hidden inputs for form submission
                hiddenInputs += `
                    <input type="hidden" name="products" value="${id}">
                    <input type="hidden" name="selling_price_${id}" value="${product.sellingPrice.toFixed(2)}">
                `;
            });

            container.innerHTML = html;
            hiddenContainer.innerHTML = hiddenInputs;
        }

        function removeProduct(productId) {
            delete confirmedProducts[productId];

            // Remove the confirmed-row class from the table row if visible
            const row = document.querySelector(`tr[data-product-id="${productId}"]`);
            if (row) {
                row.classList.remove('confirmed-row');
            }

            renderConfirmedProducts();
            updateTotals();
        }

        function updateTotals() {
            let total = 0;
            let origTotal = 0;
            let discount = 0;
            let count = 0;

            Object.values(confirmedProducts).forEach(product => {
                total += product.sellingPrice;
                origTotal += product.originalPrice;
                discount += product.discount;
                count++;
            });

            selectedTotal = total;
            originalTotal = origTotal;
            totalDiscount = discount;

            document.getElementById('selectedCount').textContent = count;
            document.getElementById('originalTotal').textContent = origTotal.toFixed(2) + ' DH';
            document.getElementById('totalAmount').textContent = total.toFixed(2) + ' DH';

            // Show/hide discount row
            const discountRow = document.getElementById('discountRow');
            if (totalDiscount > 0) {
                document.getElementById('totalDiscount').textContent = '-' + totalDiscount.toFixed(2) + ' DH';
                discountRow.style.display = 'flex';
            } else {
                discountRow.style.display = 'none';
            }

            // Auto-fill deposit amount
            const depositInput = document.getElementById('useDeposit');
            const suggestedDeposit = Math.min(total, accountBalance);
            depositInput.value = suggestedDeposit.toFixed(2);

            // Calculate additional payment needed
            const additionalNeeded = Math.max(0, total - suggestedDeposit);
            document.getElementById('additionalPayment').value = additionalNeeded.toFixed(2);

            updatePaymentSummary();
        }

        // Called when deposit input changes - auto-calculate additional payment
        function onDepositChange() {
            let depositUsed = parseFloat(document.getElementById('useDeposit').value) || 0;

            // Validate deposit doesn't exceed balance
            if (depositUsed > accountBalance) {
                depositUsed = accountBalance;
                document.getElementById('useDeposit').value = depositUsed.toFixed(2);
            }

            // Auto-calculate additional payment needed
            const additionalNeeded = Math.max(0, selectedTotal - depositUsed);
            document.getElementById('additionalPayment').value = additionalNeeded.toFixed(2);

            updatePaymentDisplay();
        }

        // Called when additional payment input changes - just update display
        function onAdditionalPaymentChange() {
            updatePaymentDisplay();
        }

        // Called when payment method changes - show/hide bank account and reference fields
        function onPaymentMethodChange() {
            const select = document.getElementById('paymentMethod');
            const selectedOption = select.options[select.selectedIndex];
            const code = (selectedOption.dataset.code || '').toLowerCase();
            const methodName = selectedOption.text.toLowerCase();

            const bankAccountGroup = document.getElementById('bankAccountGroup');
            const paymentReferenceGroup = document.getElementById('paymentReferenceGroup');

            // Show bank account only for "virement" (transfer)
            const isVirement = code.includes('virement') || methodName.includes('virement');
            bankAccountGroup.style.display = isVirement ? 'block' : 'none';

            // Show reference for everything except "espèces" (cash) and empty selection
            const isEspeces = code.includes('espece') || code.includes('cash') || methodName.includes('espèce') || methodName.includes('espece');
            const isEmpty = !select.value;
            paymentReferenceGroup.style.display = (!isEmpty && !isEspeces) ? 'block' : 'none';
        }

        // Update the payment summary display (no auto-calculation)
        function updatePaymentDisplay() {
            const depositUsed = parseFloat(document.getElementById('useDeposit').value) || 0;
            const additionalPayment = parseFloat(document.getElementById('additionalPayment').value) || 0;
            const totalPaid = depositUsed + additionalPayment;
            const remaining = selectedTotal - totalPaid;

            document.getElementById('depositUsed').textContent = depositUsed.toFixed(2) + ' DH';
            document.getElementById('additionalUsed').textContent = additionalPayment.toFixed(2) + ' DH';
            document.getElementById('totalPaid').textContent = totalPaid.toFixed(2) + ' DH';

            const remainingRow = document.getElementById('remainingRow');
            const submitBtn = document.getElementById('submitBtn');

            if (remaining > 0.01) {
                document.getElementById('remaining').textContent = remaining.toFixed(2) + ' DH';
                remainingRow.style.display = 'flex';
                submitBtn.disabled = true;
            } else {
                remainingRow.style.display = 'none';
                submitBtn.disabled = Object.keys(confirmedProducts).length === 0;
            }
        }

        // Legacy function for compatibility
        function updatePaymentSummary() {
            updatePaymentDisplay();
        }

        function applyFilters() {
            const search = document.getElementById('productSearch').value;
            const category = document.getElementById('categoryFilter').value;
            let url = '{% url "deposits:purchase" account.pk %}?';

            if (search) url += 'search=' + encodeURIComponent(search) + '&';
            if (category) url += 'category=' + category + '&';

            window.location.href = url;
        }

        // Enter key triggers filter
        document.getElementById('productSearch').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                applyFilters();
            }
        });

        // Form validation
        document.getElementById('purchaseForm').addEventListener('submit', function(e) {
            if (Object.keys(confirmedProducts).length === 0) {
                e.preventDefault();
                alert('Veuillez confirmer au moins un produit.');
                return;
            }

            const depositUsed = parseFloat(document.getElementById('useDeposit').value) || 0;
            const additionalPayment = parseFloat(document.getElementById('additionalPayment').value) || 0;
            const totalPaid = depositUsed + additionalPayment;

            if (totalPaid < selectedTotal - 0.01) {
                e.preventDefault();
                alert('Le paiement est insuffisant. Reste à payer: ' + (selectedTotal - totalPaid).toFixed(2) + ' DH');
                return;
            }

            if (depositUsed > accountBalance) {
                e.preventDefault();
                alert('Le montant dépôt dépasse le solde disponible.');
                return;
            }
        });
    </script>
{% endblock %}
