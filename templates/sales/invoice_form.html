{% extends 'base.html' %}
{% load humanize %}

{% block title %}{% if form.instance.pk %}Éditer Facture{% else %}Nouvelle Facture{% endif %} - Bijouterie Hafsa ERP{% endblock %}

{% block breadcrumb %}
    <span>/</span>
    <span><a href="{% url 'sales:invoice_list' %}" class="text-blue-600 hover:text-blue-700">Factures</a></span>
    <span>/</span>
    <span>{% if form.instance.pk %}Éditer{% else %}Nouvelle{% endif %}</span>
{% endblock %}

{% block page_header %}
    <style>
        /* Invoice Form Header - Refined Minimalist */
        .invoice-header {
            display: flex;
            flex-direction: column;
            gap: var(--space-4);
        }

        .invoice-header h1 {
            font-family: var(--font-serif);
            font-size: var(--text-4xl);
            color: var(--color-neutral-black);
            font-weight: var(--weight-normal);
            margin: 0;
        }

        .invoice-header p {
            font-size: var(--text-sm);
            color: var(--color-neutral-gray);
            margin: 0;
        }

        .breadcrumb a {
            color: var(--color-primary);
            text-decoration: none;
            transition: color var(--transition-fast);
        }

        .breadcrumb a:hover {
            color: var(--color-primary-dark);
            text-decoration: underline;
        }
    </style>

    <div class="invoice-header">
        <h1>
            {% if form.instance.pk %}
                Éditer Facture #{{ form.instance.reference }}
            {% else %}
                Créer une Nouvelle Facture
            {% endif %}
        </h1>
        <p>Complétez les détails de la facture de vente</p>
    </div>
{% endblock %}

{% block content %}
    <style>
        /* Invoice Form Container - Refined Minimalist */
        .invoice-form-container {
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: var(--space-8);
        }

        .invoice-form-main {
            background: white;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-sm);
            padding: var(--space-6);
        }

        .invoice-form {
            display: flex;
            flex-direction: column;
            gap: var(--space-6);
        }

        /* Error Display */
        .form-error-alert {
            background: rgba(200, 90, 84, 0.1);
            border: 1px solid var(--color-error);
            border-radius: var(--radius-md);
            padding: var(--space-4);
            margin-bottom: var(--space-4);
        }

        .form-error-alert-title {
            color: var(--color-error);
            font-weight: var(--weight-semibold);
            margin-bottom: var(--space-2);
        }

        .form-error-alert-message {
            color: var(--color-error);
            font-size: var(--text-sm);
        }

        /* Form Sections */
        .form-section-wrapper {
            border-bottom: 1px solid var(--color-neutral-medium);
            padding-bottom: var(--space-6);
        }

        .form-section-wrapper:last-of-type {
            border-bottom: none;
        }

        .form-section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: var(--space-4);
            gap: var(--space-4);
        }

        .form-section-title {
            font-family: var(--font-serif);
            font-size: var(--text-2xl);
            color: var(--color-neutral-black);
            font-weight: var(--weight-normal);
            margin: 0;
        }

        .form-section-toggle {
            display: none;
        }

        @media (max-width: 767px) {
            .invoice-form-container {
                grid-template-columns: 1fr;
            }

            .form-section-toggle {
                display: block;
                background: none;
                border: none;
                cursor: pointer;
                padding: 0;
                color: var(--color-neutral-gray);
            }

            .form-section-toggle:focus {
                outline: none;
            }
        }
    </style>

    <div class="invoice-form-container">
        <!-- Main Form -->
        <div class="invoice-form-main">
            <form method="post" action="{% url 'sales:invoice_create' %}" class="invoice-form">
                {% csrf_token %}

                <!-- Display Form Errors -->
                {% if form.non_field_errors %}
                    <div class="form-error-alert">
                        <p class="form-error-alert-title">Erreurs:</p>
                        {% for error in form.non_field_errors %}
                            <p class="form-error-alert-message">{{ error }}</p>
                        {% endfor %}
                    </div>
                {% endif %}

                <!-- Client Section -->
                <div class="form-section-wrapper">
                    <style>
                        .add-client-btn {
                            display: inline-flex;
                            align-items: center;
                            gap: var(--space-2);
                            padding: var(--space-2) var(--space-3);
                            background: rgba(183, 110, 121, 0.1);
                            color: var(--color-primary);
                            border: 1px solid var(--color-primary);
                            border-radius: var(--radius-md);
                            font-size: var(--text-sm);
                            font-weight: var(--weight-semibold);
                            text-decoration: none;
                            cursor: pointer;
                            transition: all var(--transition-fast);
                            min-height: 2.25rem;
                        }

                        .add-client-btn:hover {
                            background: var(--color-primary);
                            color: white;
                        }

                        .form-input-wrapper {
                            display: flex;
                            flex-direction: column;
                            gap: var(--space-2);
                        }

                        .form-input-wrapper select {
                            padding: var(--space-3) var(--space-4);
                            border: 1px solid var(--color-neutral-medium);
                            border-radius: var(--radius-md);
                            font-size: var(--text-base);
                            color: var(--color-neutral-dark);
                            background: white;
                            transition: all var(--transition-fast);
                        }

                        .form-input-wrapper select:focus {
                            outline: none;
                            border-color: var(--color-primary);
                            box-shadow: 0 0 0 3px rgba(183, 110, 121, 0.1);
                        }

                        .form-help-text {
                            font-size: var(--text-xs);
                            color: var(--color-neutral-gray);
                        }

                        .form-error-text {
                            font-size: var(--text-sm);
                            color: var(--color-error);
                        }
                    </style>

                    <div class="form-section-header">
                        <h2 class="form-section-title">Client</h2>
                        <button type="button" class="add-client-btn"
                                data-bs-toggle="modal" data-bs-target="#addClientModal">
                            <i class="fas fa-plus"></i> Nouveau
                        </button>
                    </div>

                    <div id="clientContent" class="form-input-wrapper">
                        {{ form.client }}
                        <p class="form-help-text">Laissez vide pour une vente sans client (walk-in)</p>
                        {% if form.client.errors %}
                            <p class="form-error-text">{{ form.client.errors.0 }}</p>
                        {% endif %}
                    </div>
                </div>

                <!-- Essential Info Section -->
                <div class="form-section-wrapper">
                    <style>
                        .form-grid-2 {
                            display: grid;
                            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                            gap: var(--space-4);
                        }

                        .form-group {
                            display: flex;
                            flex-direction: column;
                            gap: var(--space-2);
                        }

                        .form-group label {
                            font-size: var(--text-sm);
                            font-weight: var(--weight-semibold);
                            color: var(--color-neutral-dark);
                            text-transform: uppercase;
                            letter-spacing: var(--tracking-wide);
                        }

                        .form-group input,
                        .form-group select {
                            padding: var(--space-3) var(--space-4);
                            border: 1px solid var(--color-neutral-medium);
                            border-radius: var(--radius-md);
                            font-size: var(--text-base);
                            color: var(--color-neutral-dark);
                            background: white;
                            transition: all var(--transition-fast);
                        }

                        .form-group input:focus,
                        .form-group select:focus {
                            outline: none;
                            border-color: var(--color-primary);
                            box-shadow: 0 0 0 3px rgba(183, 110, 121, 0.1);
                        }

                        .form-group input[type="number"] {
                            font-family: var(--font-serif);
                        }
                    </style>

                    <h2 class="form-section-title">Paramètres</h2>
                    <div class="form-grid-2">
                        <div class="form-group">
                            <label for="{{ form.tax_rate.id_for_label }}">TVA (%)</label>
                            {{ form.tax_rate }}
                            {% if form.tax_rate.errors %}
                                <p class="form-error-text">{{ form.tax_rate.errors.0 }}</p>
                            {% endif %}
                        </div>
                        <div class="form-group">
                            <label for="{{ form.payment_method.id_for_label }}">Méthode de Paiement</label>
                            {{ form.payment_method }}
                            {% if form.payment_method.errors %}
                                <p class="form-error-text">{{ form.payment_method.errors.0 }}</p>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Conditional Payment Reference (for bank transfer, cheque, mobile payment, cards) -->
                    <div id="paymentRefSection" class="hidden" style="margin-top: var(--space-4);">
                        <div class="form-group">
                            <label for="paymentReference">
                                Référence de Paiement <span style="color: var(--color-error);">*</span>
                            </label>
                            <input type="text" id="paymentReference" name="payment_reference"
                                   placeholder="N° de chèque, référence virement, n° de carte...">
                            <p class="form-help-text">
                                Obligatoire pour virement, chèque, paiement mobile ou carte
                            </p>
                        </div>
                    </div>

                    <!-- Conditional Bank Account (for bank transfer only) -->
                    <div id="bankAccountSection" class="hidden" style="margin-top: var(--space-4);">
                        <div class="form-group">
                            <label for="bankAccount">
                                Compte Bancaire <span style="color: var(--color-error);">*</span>
                            </label>
                            <select id="bankAccount" name="bank_account">
                                <option value="">-- Sélectionnez un compte --</option>
                                {% for bank in bank_accounts %}
                                    <option value="{{ bank.id }}">{{ bank.bank_name }} - {{ bank.account_number }}</option>
                                {% endfor %}
                            </select>
                            <p class="form-help-text">
                                Sélectionnez le compte bancaire pour ce virement
                            </p>
                        </div>
                    </div>

                    <div style="margin-top: var(--space-4);">
                        <p class="form-help-text">
                            <i class="fas fa-info-circle" style="margin-right: var(--space-2);"></i>
                            Remises appliquées par produit • Livraison configurée après création
                        </p>
                    </div>
                </div>

                <!-- Items Section -->
                <div class="form-section-wrapper">
                    <style>
                        .add-item-btn {
                            display: inline-flex;
                            align-items: center;
                            gap: var(--space-2);
                            padding: var(--space-3) var(--space-4);
                            background: linear-gradient(135deg, var(--color-primary), var(--color-primary-light));
                            color: white;
                            border: none;
                            border-radius: var(--radius-md);
                            font-weight: var(--weight-semibold);
                            font-size: var(--text-sm);
                            text-transform: uppercase;
                            letter-spacing: var(--tracking-wide);
                            cursor: pointer;
                            transition: all var(--transition-fast);
                            min-height: 2.75rem;
                        }

                        .add-item-btn:hover {
                            background: linear-gradient(135deg, var(--color-primary-dark), var(--color-primary));
                            box-shadow: var(--shadow-hover);
                            transform: translateY(-2px);
                        }

                        .items-container {
                            display: flex;
                            flex-direction: column;
                            gap: var(--space-4);
                            margin-bottom: var(--space-4);
                        }

                        .empty-state {
                            background: var(--color-neutral-light);
                            border: 1px solid var(--color-neutral-medium);
                            border-radius: var(--radius-md);
                            padding: var(--space-6);
                            text-align: center;
                        }

                        .empty-state-icon {
                            font-size: 2rem;
                            color: var(--color-neutral-gray);
                            opacity: 0.5;
                            margin-bottom: var(--space-2);
                        }

                        .empty-state-text {
                            color: var(--color-neutral-gray);
                            font-size: var(--text-sm);
                        }
                    </style>

                    <div class="form-section-header">
                        <h2 class="form-section-title">Articles</h2>
                        <button type="button" class="add-item-btn" id="addItemBtn">
                            <i class="fas fa-plus"></i> Ajouter
                        </button>
                    </div>

                    <!-- Items List -->
                    <div id="itemsContainer" class="items-container">
                        <!-- Items will be added here dynamically -->
                    </div>

                    <!-- Add Item Form (Hidden by default) -->
                    <style>
                        .add-item-form {
                            background: var(--color-neutral-light);
                            border: 1px solid var(--color-neutral-medium);
                            border-radius: var(--radius-md);
                            padding: var(--space-4);
                        }

                        .add-item-form h3 {
                            font-size: var(--text-lg);
                            font-weight: var(--weight-semibold);
                            color: var(--color-neutral-dark);
                            margin-bottom: var(--space-4);
                        }

                        .add-item-fields {
                            display: flex;
                            flex-direction: column;
                            gap: var(--space-3);
                        }

                        .item-calculation-box {
                            background: white;
                            padding: var(--space-4);
                            border-radius: var(--radius-md);
                            border: 1px solid var(--color-neutral-medium);
                            margin-bottom: var(--space-3);
                        }

                        .item-calc-row {
                            display: flex;
                            justify-content: space-between;
                            align-items: baseline;
                            font-size: var(--text-sm);
                            margin-bottom: var(--space-2);
                        }

                        .item-calc-row:last-child {
                            margin-bottom: 0;
                            border-top: 1px solid var(--color-neutral-medium);
                            padding-top: var(--space-2);
                            font-weight: var(--weight-semibold);
                        }

                        .item-calc-value {
                            font-family: var(--font-serif);
                            font-weight: var(--weight-semibold);
                            color: var(--color-primary);
                        }

                        .item-buttons {
                            display: grid;
                            grid-template-columns: 1fr 1fr;
                            gap: var(--space-2);
                        }

                        .item-btn {
                            padding: var(--space-3) var(--space-4);
                            border: none;
                            border-radius: var(--radius-md);
                            font-weight: var(--weight-semibold);
                            font-size: var(--text-sm);
                            cursor: pointer;
                            transition: all var(--transition-fast);
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            gap: var(--space-2);
                            min-height: 2.5rem;
                        }

                        .item-btn-confirm {
                            background: var(--color-success);
                            color: white;
                        }

                        .item-btn-confirm:hover {
                            background: var(--color-success);
                            opacity: 0.9;
                            transform: translateY(-1px);
                            box-shadow: var(--shadow-sm);
                        }

                        .item-btn-cancel {
                            background: var(--color-neutral-medium);
                            color: var(--color-neutral-dark);
                        }

                        .item-btn-cancel:hover {
                            background: var(--color-neutral-medium);
                            opacity: 0.8;
                        }
                    </style>

                    <div id="addItemSection" class="add-item-form hidden">
                        <h3>Ajouter un Nouvel Article</h3>
                        <div class="add-item-fields">
                            <div class="form-group">
                                <label for="product_id">Produit *</label>
                                <select id="product_id" required>
                                    <option value="">-- Sélectionnez un produit --</option>
                                    {% for product in products %}
                                        <option value="{{ product.id }}" data-price="{{ product.selling_price }}">
                                            {{ product.reference }} - {{ product.name }}
                                        </option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="form-grid-2">
                                <div class="form-group">
                                    <label for="quantity">Quantité *</label>
                                    <input type="number" id="quantity" step="0.001" min="0.001" value="1" required>
                                </div>
                                <div class="form-group">
                                    <label for="unit_price">Prix Unitaire (DH)</label>
                                    <input type="number" id="unit_price" step="0.01" min="0" readonly style="background: var(--color-neutral-light);">
                                    <p class="form-help-text">Auto-détecté du produit</p>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="discount_amount">Remise (DH)</label>
                                <input type="number" id="discount_amount" step="0.01" min="0" value="0">
                            </div>
                            <div class="item-calculation-box">
                                <div class="item-calc-row">
                                    <span>Sous-total:</span>
                                    <span class="item-calc-value"><span id="subtotal_display">0.00</span> DH</span>
                                </div>
                                <div class="item-calc-row">
                                    <span>Remise:</span>
                                    <span class="item-calc-value">-<span id="discount_display">0.00</span> DH</span>
                                </div>
                                <div class="item-calc-row" style="color: var(--color-primary);">
                                    <span>Total de l'article:</span>
                                    <span id="estimated_total">0.00 DH</span>
                                </div>
                            </div>
                            <div class="item-buttons">
                                <button type="button" id="confirmItemBtn" class="item-btn item-btn-confirm">
                                    <i class="fas fa-check"></i> Ajouter
                                </button>
                                <button type="button" id="cancelItemBtn" class="item-btn item-btn-cancel">
                                    Annuler
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Empty State -->
                    <div id="emptyState" class="empty-state">
                        <div class="empty-state-icon">
                            <i class="fas fa-inbox"></i>
                        </div>
                        <p class="empty-state-text">
                            Aucun article ajouté. Cliquez sur "Ajouter un Article" pour commencer.
                        </p>
                    </div>
                </div>

                <!-- Payment Amount Section -->
                <div class="form-section-wrapper">
                    <h2 class="form-section-title">Paiement à la Création</h2>
                    <div class="form-group">
                        <label for="amountPaidInput">Montant Payé (Optionnel)</label>
                        <input type="number" name="amount_paid" id="amountPaidInput"
                               step="0.01" min="0" value="0" placeholder="0.00">
                        <p class="form-help-text">
                            Montant payé lors de la création de la facture
                        </p>
                    </div>
                </div>

                <!-- Notes Section -->
                <div class="form-section-wrapper">
                    <h2 class="form-section-title">Notes</h2>
                    <div class="form-group">
                        <label for="{{ form.notes.id_for_label }}">Observations</label>
                        {{ form.notes }}
                        {% if form.notes.errors %}
                            <p class="form-error-text">{{ form.notes.errors.0 }}</p>
                        {% endif %}
                    </div>
                </div>

                <!-- Submit Buttons -->
                <style>
                    .form-actions {
                        display: flex;
                        gap: var(--space-4);
                        padding-top: var(--space-6);
                        border-top: 1px solid var(--color-neutral-medium);
                    }

                    .form-submit-btn {
                        display: inline-flex;
                        align-items: center;
                        justify-content: center;
                        gap: var(--space-2);
                        padding: var(--space-3) var(--space-4);
                        border: none;
                        border-radius: var(--radius-md);
                        font-weight: var(--weight-semibold);
                        font-size: var(--text-sm);
                        text-transform: uppercase;
                        letter-spacing: var(--tracking-wide);
                        text-decoration: none;
                        cursor: pointer;
                        transition: all var(--transition-fast);
                        min-height: 2.75rem;
                        flex: 1;
                    }

                    .form-submit-btn-primary {
                        background: linear-gradient(135deg, var(--color-primary), var(--color-primary-light));
                        color: white;
                    }

                    .form-submit-btn-primary:hover {
                        background: linear-gradient(135deg, var(--color-primary-dark), var(--color-primary));
                        box-shadow: var(--shadow-hover);
                        transform: translateY(-2px);
                    }

                    .form-submit-btn-secondary {
                        background: var(--color-neutral-light);
                        color: var(--color-neutral-dark);
                        border: 1px solid var(--color-neutral-medium);
                    }

                    .form-submit-btn-secondary:hover {
                        background: var(--color-neutral-medium);
                        text-decoration: none;
                    }

                    @media (max-width: 767px) {
                        .form-actions {
                            flex-direction: column;
                        }

                        .form-submit-btn {
                            width: 100%;
                        }
                    }
                </style>

                <div class="form-actions">
                    <button type="submit" class="form-submit-btn form-submit-btn-primary">
                        <i class="fas fa-save"></i>
                        {% if form.instance.pk %}Mettre à jour{% else %}Créer la Facture{% endif %}
                    </button>
                    <a href="{% url 'sales:invoice_list' %}" class="form-submit-btn form-submit-btn-secondary">
                        <i class="fas fa-arrow-left"></i> Annuler
                    </a>
                </div>
            </form>
        </div>

        <!-- Info Panel / Sidebar -->
        <style>
            /* Invoice Form Sidebar */
            .invoice-sidebar {
                display: flex;
                flex-direction: column;
                gap: var(--space-6);
            }

            .sidebar-card {
                background: white;
                border-radius: var(--radius-lg);
                box-shadow: var(--shadow-sm);
                padding: var(--space-6);
            }

            .sidebar-title {
                font-size: var(--text-lg);
                font-weight: var(--weight-semibold);
                color: var(--color-neutral-dark);
                margin-bottom: var(--space-4);
            }

            .reference-box {
                background: var(--color-neutral-light);
                padding: var(--space-4);
                border-radius: var(--radius-md);
                text-align: center;
            }

            .reference-label {
                font-size: var(--text-xs);
                color: var(--color-neutral-gray);
                text-transform: uppercase;
                letter-spacing: var(--tracking-wide);
                margin-bottom: var(--space-2);
            }

            .reference-value {
                font-family: var(--font-serif);
                font-size: var(--text-xl);
                font-weight: var(--weight-semibold);
                color: var(--color-neutral-black);
            }

            .reference-date {
                font-size: var(--text-xs);
                color: var(--color-neutral-gray);
                margin-top: var(--space-3);
            }

            .help-box {
                background: rgba(124, 179, 66, 0.1);
                border: 1px solid var(--color-success);
                border-radius: var(--radius-md);
                padding: var(--space-6);
            }

            .help-box-title {
                font-size: var(--text-lg);
                font-weight: var(--weight-semibold);
                color: var(--color-success);
                margin-bottom: var(--space-3);
            }

            .help-list {
                list-style: none;
                padding: 0;
                margin: 0;
                display: flex;
                flex-direction: column;
                gap: var(--space-2);
            }

            .help-list li {
                font-size: var(--text-sm);
                color: var(--color-success);
            }

            .help-list i {
                margin-right: var(--space-2);
                color: var(--color-success);
            }

            .summary-box {
                border-top: 1px solid var(--color-neutral-medium);
                padding-top: var(--space-4);
            }

            .summary-row {
                background: var(--color-neutral-light);
                padding: var(--space-4);
                border-radius: var(--radius-md);
                margin-bottom: var(--space-3);
            }

            .summary-row:last-of-type {
                margin-bottom: 0;
            }

            .summary-label {
                font-size: var(--text-sm);
                color: var(--color-neutral-dark);
                margin-bottom: var(--space-2);
            }

            .summary-value {
                font-family: var(--font-serif);
                font-size: var(--text-2xl);
                font-weight: var(--weight-normal);
                color: var(--color-primary);
            }

            .status-indicator {
                font-size: var(--text-xs);
                color: var(--color-neutral-gray);
                padding-top: var(--space-2);
                border-top: 1px solid var(--color-neutral-medium);
            }

            .status-indicator i {
                margin-right: var(--space-1);
            }

            .existing-status {
                display: flex;
                flex-direction: column;
                gap: var(--space-3);
            }

            .status-row {
                display: flex;
                justify-content: space-between;
                align-items: center;
                font-size: var(--text-sm);
            }

            .status-row strong {
                font-weight: var(--weight-semibold);
                color: var(--color-neutral-dark);
            }

            .status-row-value {
                font-family: var(--font-serif);
                font-weight: var(--weight-semibold);
                color: var(--color-primary);
            }

            @media (max-width: 767px) {
                .invoice-sidebar {
                    display: none;
                }
            }
        </style>

        <div class="invoice-sidebar">
            <!-- Reference Info -->
            <div class="sidebar-card">
                <h3 class="sidebar-title">Référence</h3>
                <div class="reference-box">
                    <div class="reference-label">Numéro de Facture</div>
                    <p class="reference-value">
                        {% if form.instance.pk %}
                            {{ form.instance.reference }}
                        {% else %}
                            Auto-généré
                        {% endif %}
                    </p>
                </div>
                {% if form.instance.pk %}
                    <p class="reference-date">Créée le {{ form.instance.created_at|date:'d/m/Y H:i' }}</p>
                {% endif %}
            </div>

            <!-- Quick Help -->
            <div class="help-box">
                <h3 class="help-box-title">Workflow Simple</h3>
                <ul class="help-list">
                    <li><i class="fas fa-check"></i> Sélectionnez un client (optionnel)</li>
                    <li><i class="fas fa-check"></i> Ajoutez les articles</li>
                    <li><i class="fas fa-check"></i> Paramètres: remise, TVA, paiement</li>
                    <li><i class="fas fa-check"></i> Créer → Facture prête!</li>
                </ul>
            </div>

            <!-- Invoice Summary -->
            <div class="sidebar-card">
                <h3 class="sidebar-title">Résumé & Paiement</h3>

                <!-- Total Amount -->
                <div class="summary-row">
                    <div class="summary-label">Total Facture</div>
                    <div class="summary-value" id="invoiceTotal">0.00 DH</div>
                </div>

                <!-- Balance Due -->
                <div class="summary-row">
                    <div class="summary-label">Solde Restant</div>
                    <div class="summary-value" id="balanceDue">0.00 DH</div>
                </div>

                <!-- Status Indicator -->
                <div class="status-indicator">
                    <i class="fas fa-info-circle"></i>
                    <span id="paymentStatus">Ajoutez les articles pour voir le total</span>
                </div>
            </div>

            <!-- Status Info -->
            {% if form.instance.pk %}
                <div class="sidebar-card">
                    <h3 class="sidebar-title">État</h3>
                    <div class="existing-status">
                        <div class="status-row">
                            <strong>Statut:</strong>
                            <span class="badge" style="background: rgba(212, 169, 55, 0.1); color: var(--color-warning);">{{ form.instance.get_status_display }}</span>
                        </div>
                        <div class="status-row">
                            <strong>Total:</strong>
                            <span class="status-row-value">{{ form.instance.total_amount|floatformat:2 }} DH</span>
                        </div>
                        <div class="status-row">
                            <strong>Payé:</strong>
                            <span>{{ form.instance.amount_paid|floatformat:2 }} DH</span>
                        </div>
                        <div class="status-row">
                            <strong>Dû:</strong>
                            <span class="status-row-value">{{ form.instance.balance_due|floatformat:2 }} DH</span>
                        </div>
                    </div>
                </div>
            {% endif %}
        </div>
    </div><!-- End invoice-form-container -->

    <!-- Modal: Quick Add Client -->
    <style>
        /* Modal Styling - Refined Minimalist */
        .modal-header {
            border-bottom: 1px solid var(--color-neutral-medium);
            background: transparent;
        }

        .modal-title {
            font-family: var(--font-serif);
            font-size: var(--text-xl);
            color: var(--color-neutral-black);
            font-weight: var(--weight-normal);
        }

        .modal-body {
            padding: var(--space-6);
        }

        .modal-footer {
            border-top: 1px solid var(--color-neutral-medium);
            background: transparent;
        }

        .modal-form-group {
            display: flex;
            flex-direction: column;
            gap: var(--space-2);
            margin-bottom: var(--space-4);
        }

        .modal-form-group:last-child {
            margin-bottom: 0;
        }

        .modal-form-group label {
            font-size: var(--text-sm);
            font-weight: var(--weight-semibold);
            color: var(--color-neutral-dark);
        }

        .modal-form-group input {
            padding: var(--space-3) var(--space-4);
            border: 1px solid var(--color-neutral-medium);
            border-radius: var(--radius-md);
            font-size: var(--text-base);
            color: var(--color-neutral-dark);
            background: white;
            transition: all var(--transition-fast);
        }

        .modal-form-group input:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 3px rgba(183, 110, 121, 0.1);
        }

        .modal-btn {
            padding: var(--space-3) var(--space-4);
            border: none;
            border-radius: var(--radius-md);
            font-weight: var(--weight-semibold);
            font-size: var(--text-sm);
            text-transform: uppercase;
            letter-spacing: var(--tracking-wide);
            cursor: pointer;
            transition: all var(--transition-fast);
            min-height: 2.5rem;
        }

        .modal-btn-primary {
            background: linear-gradient(135deg, var(--color-primary), var(--color-primary-light));
            color: white;
        }

        .modal-btn-primary:hover {
            background: linear-gradient(135deg, var(--color-primary-dark), var(--color-primary));
            box-shadow: var(--shadow-hover);
        }

        .modal-btn-secondary {
            background: var(--color-neutral-light);
            color: var(--color-neutral-dark);
            border: 1px solid var(--color-neutral-medium);
        }

        .modal-btn-secondary:hover {
            background: var(--color-neutral-medium);
        }
    </style>

    <div class="modal fade" id="addClientModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Ajouter un Nouveau Client</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="quickAddClientForm">
                        {% csrf_token %}
                        <div class="modal-form-group">
                            <label for="first_name">Prénom</label>
                            <input type="text" id="first_name" name="first_name" required>
                        </div>
                        <div class="modal-form-group">
                            <label for="last_name">Nom</label>
                            <input type="text" id="last_name" name="last_name" required>
                        </div>
                        <div class="modal-form-group">
                            <label for="phone">Téléphone</label>
                            <input type="tel" id="phone" name="phone" required>
                        </div>
                        <div class="modal-form-group">
                            <label for="email">Email</label>
                            <input type="email" id="email" name="email">
                        </div>
                        <div class="modal-form-group">
                            <label for="city">Ville</label>
                            <input type="text" id="city" name="city">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="modal-btn modal-btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button type="button" class="modal-btn modal-btn-primary" id="saveClientBtn">Ajouter Client</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let invoiceItems = [];

        document.addEventListener('DOMContentLoaded', function() {
            // ============ QUICK ADD CLIENT ============
            const saveClientBtn = document.getElementById('saveClientBtn');
            if (saveClientBtn) {
                saveClientBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    const form = document.getElementById('quickAddClientForm');
                    const formData = new FormData(form);
                    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

                    fetch('{% url "clients:quick_create" %}', {
                        method: 'POST',
                        body: formData,
                        headers: {
                            'X-CSRFToken': csrfToken
                        }
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            const selectElement = document.querySelector('select[name="client"]');
                            if (selectElement) {
                                const option = document.createElement('option');
                                option.value = data.client_id;
                                option.textContent = data.client_name + ' (' + data.client_email + ')';
                                selectElement.appendChild(option);
                                selectElement.value = data.client_id;
                            }
                            const modalEl = document.getElementById('addClientModal');
                            const modal = bootstrap.Modal.getInstance(modalEl);
                            if (modal) modal.hide();
                            form.reset();
                            alert('Client ajouté avec succès!');
                        } else {
                            alert('Erreur: ' + (data.error || 'Erreur inconnue'));
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('Erreur: ' + error);
                    });
                });
            }

            // ============ PAYMENT REFERENCE & BANK ACCOUNT CONDITIONAL ============
            const paymentMethodSelect = document.querySelector('select[name="payment_method"]');
            const paymentRefSection = document.getElementById('paymentRefSection');
            const bankAccountSection = document.getElementById('bankAccountSection');

            function updatePaymentFieldsVisibility() {
                if (!paymentRefSection || !bankAccountSection) {
                    console.warn('⚠ Payment or bank account sections not found in DOM');
                    return;
                }

                if (!paymentMethodSelect || !paymentMethodSelect.value) {
                    paymentRefSection.classList.add('hidden');
                    paymentRefSection.style.display = 'none';
                    bankAccountSection.classList.add('hidden');
                    bankAccountSection.style.display = 'none';
                    return;
                }

                // Get the selected option's text
                const selectedText = paymentMethodSelect.options[paymentMethodSelect.selectedIndex].text;
                const selectedTextLower = selectedText.toLowerCase();

                // Define payment methods that DO NOT require reference (only Espèces)
                const noReferenceNeeded = ['Espèces', 'espece', 'cash'];

                // Show reference field for everything EXCEPT cash/espèces
                const showReference = !noReferenceNeeded.some(text =>
                    selectedTextLower.includes(text.toLowerCase())
                );

                // Show bank account field ONLY for Virement Bancaire
                const isBankTransfer = selectedTextLower.includes('virement');

                // Update payment reference visibility
                if (showReference) {
                    paymentRefSection.classList.remove('hidden');
                    paymentRefSection.style.display = 'block';
                } else {
                    paymentRefSection.classList.add('hidden');
                    paymentRefSection.style.display = 'none';
                }

                // Update bank account visibility
                if (isBankTransfer) {
                    bankAccountSection.classList.remove('hidden');
                    bankAccountSection.style.display = 'block';
                } else {
                    bankAccountSection.classList.add('hidden');
                    bankAccountSection.style.display = 'none';
                }
            }

            if (paymentMethodSelect) {
                paymentMethodSelect.addEventListener('change', updatePaymentFieldsVisibility);
                // Check on page load
                setTimeout(updatePaymentFieldsVisibility, 100);
            } else {
                console.warn('⚠ Payment method select not found');
            }

            // ============ HELPER FUNCTIONS ============
            function updateEstimatedTotal() {
                const quantityInput = document.getElementById('quantity');
                const unitPriceInput = document.getElementById('unit_price');
                const discountInput = document.getElementById('discount_amount');
                const estimatedTotalSpan = document.getElementById('estimated_total');

                if (!quantityInput || !unitPriceInput || !discountInput) return;

                const qty = parseFloat(quantityInput.value) || 0;
                const price = parseFloat(unitPriceInput.value) || 0;
                const discount = parseFloat(discountInput.value) || 0;
                const subtotal = qty * price;
                const total = Math.max(0, subtotal - discount);

                const subtotalEl = document.getElementById('subtotal_display');
                const discountEl = document.getElementById('discount_display');
                if (subtotalEl) subtotalEl.textContent = subtotal.toFixed(2);
                if (discountEl) discountEl.textContent = discount.toFixed(2);
                if (estimatedTotalSpan) estimatedTotalSpan.textContent = total.toFixed(2) + ' DH';
            }

            function resetItemForm() {
                const productSelect = document.getElementById('product_id');
                const quantityInput = document.getElementById('quantity');
                const unitPriceInput = document.getElementById('unit_price');
                const discountInput = document.getElementById('discount_amount');
                const estimatedTotalSpan = document.getElementById('estimated_total');

                if (productSelect) productSelect.value = '';
                if (quantityInput) quantityInput.value = '1';
                if (unitPriceInput) unitPriceInput.value = '';
                if (discountInput) discountInput.value = '0';
                if (estimatedTotalSpan) estimatedTotalSpan.textContent = '0.00 DH';

                const subtotalEl = document.getElementById('subtotal_display');
                const discountEl = document.getElementById('discount_display');
                if (subtotalEl) subtotalEl.textContent = '0.00';
                if (discountEl) discountEl.textContent = '0.00';
            }

            function renderItems() {
                const container = document.getElementById('itemsContainer');
                const emptyState = document.getElementById('emptyState');

                if (!container || !emptyState) {
                    console.warn('⚠ Items container or empty state not found');
                    return;
                }

                if (invoiceItems.length === 0) {
                    container.innerHTML = '';
                    emptyState.classList.remove('hidden');
                    return;
                }

                emptyState.classList.add('hidden');
                container.innerHTML = invoiceItems.map((item, index) => `
                    <div class="bg-white border border-gray-200 rounded-lg p-4 hover:shadow-md transition">
                        <div class="flex items-center justify-between mb-2">
                            <div class="flex-1">
                                <p class="font-bold text-gray-900">${item.product_name}</p>
                                <p class="text-sm text-gray-600">Qty: ${item.quantity} × ${item.unit_price.toFixed(2)} DH</p>
                            </div>
                            <button type="button" class="text-red-600 hover:text-red-800 text-sm ml-2" onclick="window.removeItem(${index})">
                                <i class="fas fa-trash mr-1"></i> Supprimer
                            </button>
                        </div>
                        <div class="bg-gray-50 p-2 rounded text-sm">
                            <div class="flex justify-between">
                                <span>Sous-total:</span>
                                <span>${(item.quantity * item.unit_price).toFixed(2)} DH</span>
                            </div>
                            ${item.discount_amount > 0 ? `<div class="flex justify-between text-red-600">
                                <span>Remise:</span>
                                <span>-${item.discount_amount.toFixed(2)} DH</span>
                            </div>` : ''}
                            <div class="flex justify-between font-bold border-t pt-1 mt-1">
                                <span>Total:</span>
                                <span class="text-green-600">${item.total_amount.toFixed(2)} DH</span>
                            </div>
                        </div>
                    </div>
                `).join('');

                // Update invoice totals in sidebar
                updateInvoiceSummary();
            }

            function updateInvoiceSummary() {
                const invoiceTotal = invoiceItems.reduce((sum, item) => sum + item.total_amount, 0);
                const amountPaidInput = document.getElementById('amountPaidInput');
                const invoiceTotalDisplay = document.getElementById('invoiceTotal');
                const balanceDueDisplay = document.getElementById('balanceDue');
                const paymentStatusDisplay = document.getElementById('paymentStatus');

                if (!invoiceTotalDisplay || !balanceDueDisplay || !amountPaidInput) {
                    return;
                }

                // Update total display
                invoiceTotalDisplay.textContent = invoiceTotal.toFixed(2) + ' DH';

                // Calculate balance
                const amountPaid = parseFloat(amountPaidInput.value) || 0;
                const balance = invoiceTotal - amountPaid;

                // Update balance display with color
                balanceDueDisplay.textContent = balance.toFixed(2) + ' DH';
                if (balance <= 0) {
                    balanceDueDisplay.className = 'text-2xl font-bold text-green-600';
                } else if (balance < invoiceTotal && amountPaid > 0) {
                    balanceDueDisplay.className = 'text-2xl font-bold text-orange-600';
                } else {
                    balanceDueDisplay.className = 'text-2xl font-bold text-red-600';
                }

                // Update payment status
                if (invoiceTotal === 0) {
                    paymentStatusDisplay.textContent = 'Ajoutez les articles pour voir le total';
                } else if (balance <= 0) {
                    paymentStatusDisplay.textContent = '✓ Facture payée en intégralité';
                } else if (amountPaid > 0) {
                    paymentStatusDisplay.textContent = '⚠ Paiement partiel - ' + balance.toFixed(2) + ' DH restants';
                } else {
                    paymentStatusDisplay.textContent = '• Facture non payée - Cliquez sur "Créer" pour l\'enregistrer';
                }
            }

            window.removeItem = function(index) {
                invoiceItems.splice(index, 1);
                renderItems();
            };

            // ============ ARTICLE MANAGEMENT ============
            const addItemBtn = document.getElementById('addItemBtn');
            const cancelItemBtn = document.getElementById('cancelItemBtn');
            const confirmItemBtn = document.getElementById('confirmItemBtn');
            const addItemSection = document.getElementById('addItemSection');
            const productSelect = document.getElementById('product_id');
            const quantityInput = document.getElementById('quantity');
            const unitPriceInput = document.getElementById('unit_price');
            const discountInput = document.getElementById('discount_amount');

            if (addItemBtn) {
                console.log('✓ Article management elements found');

                // Show/hide add item form
                addItemBtn.addEventListener('click', function() {
                    console.log('✓ Add item button clicked');
                    if (addItemSection) {
                        addItemSection.classList.remove('hidden');
                        if (productSelect) productSelect.focus();
                    }
                });

                if (cancelItemBtn) {
                    cancelItemBtn.addEventListener('click', function() {
                        console.log('✓ Cancel item button clicked');
                        if (addItemSection) addItemSection.classList.add('hidden');
                        resetItemForm();
                    });
                }

                // Auto-fill price when product selected
                if (productSelect) {
                    productSelect.addEventListener('change', function() {
                        if (this.value) {
                            const option = this.options[this.selectedIndex];
                            const price = parseFloat(option.dataset.price) || 0;
                            if (unitPriceInput) unitPriceInput.value = price.toFixed(2);
                            updateEstimatedTotal();
                        }
                    });
                }

                // Update total on input change
                [quantityInput, unitPriceInput, discountInput].forEach(input => {
                    if (input) {
                        input.addEventListener('change', updateEstimatedTotal);
                        input.addEventListener('keyup', updateEstimatedTotal);
                    }
                });

                // Add item to list
                if (confirmItemBtn) {
                    confirmItemBtn.addEventListener('click', function() {
                        console.log('✓ Confirm item button clicked');

                        if (!productSelect || !productSelect.value) {
                            alert('Sélectionnez un produit');
                            return;
                        }
                        if (!quantityInput || !quantityInput.value || parseFloat(quantityInput.value) <= 0) {
                            alert('Entrez une quantité valide');
                            return;
                        }
                        if (!unitPriceInput || !unitPriceInput.value || parseFloat(unitPriceInput.value) < 0) {
                            alert('Entrez un prix valide');
                            return;
                        }

                        const productOption = productSelect.options[productSelect.selectedIndex];
                        const qty = parseFloat(quantityInput.value);
                        const price = parseFloat(unitPriceInput.value);
                        const discount = parseFloat(discountInput.value) || 0;
                        const subtotal = qty * price;
                        const total = Math.max(0, subtotal - discount);

                        const item = {
                            id: Date.now(),
                            product_id: productSelect.value,
                            product_name: productOption.text,
                            quantity: qty,
                            unit_price: price,
                            discount_amount: discount,
                            total_amount: total
                        };

                        console.log('✓ Item added:', item.product_name, 'Qty:', qty);
                        invoiceItems.push(item);
                        renderItems();
                        resetItemForm();
                        if (addItemSection) addItemSection.classList.add('hidden');
                    });
                }
            } else {
                console.warn('⚠ Article management elements not found');
            }

            // ============ PAYMENT AMOUNT INPUT ============
            const amountPaidInput = document.getElementById('amountPaidInput');
            if (amountPaidInput) {
                amountPaidInput.addEventListener('change', updateInvoiceSummary);
                amountPaidInput.addEventListener('keyup', updateInvoiceSummary);
            }

            // Add items to form before submit
            const mainForm = document.querySelector('form[method="post"]');

            if (!mainForm) {
                console.error('✗ CRITICAL ERROR: Form element not found!');
            } else {
                console.log('✓ Main form found:', mainForm.action);

                // Add items before form submission
                // This needs to happen BEFORE the form tries to validate
                const submitBtn = mainForm.querySelector('button[type="submit"]');
                if (submitBtn) {
                    submitBtn.addEventListener('click', function(e) {
                        console.log('✓ Submit button clicked');

                        // Add items as hidden inputs BEFORE submit
                        if (invoiceItems.length > 0) {
                            console.log('✓ Adding', invoiceItems.length, 'items to form');

                            // Remove any existing item inputs first
                            mainForm.querySelectorAll('input[name^="items["]').forEach(el => el.remove());

                            invoiceItems.forEach((item, index) => {
                                const input = document.createElement('input');
                                input.type = 'hidden';
                                input.name = `items[${index}]`;
                                input.value = JSON.stringify(item);
                                mainForm.appendChild(input);
                                console.log(`  ✓ Item ${index} added:`, item.product_id);
                            });

                            console.log('✓ Items added, now submitting form');
                        }

                        // Now submit the form
                        console.log('✓ Submitting form to:', mainForm.action);
                        mainForm.submit();
                        console.log('✓ Form.submit() called');
                    });

                    console.log('✓ Submit button listener attached');
                }

                console.log('✓ Submit handler ready');
            }
        });
    </script>
{% endblock %}
