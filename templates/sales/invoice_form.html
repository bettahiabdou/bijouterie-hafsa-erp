{% extends 'base.html' %}
{% load humanize %}

{% block title %}{% if form.instance.pk %}√âditer Facture{% else %}Nouvelle Facture{% endif %} - Bijouterie Hafsa ERP{% endblock %}

{% block breadcrumb %}
    <span>/</span>
    <span><a href="{% url 'sales:invoice_list' %}" class="text-blue-600 hover:text-blue-700">Factures</a></span>
    <span>/</span>
    <span>{% if form.instance.pk %}√âditer{% else %}Nouvelle{% endif %}</span>
{% endblock %}

{% block page_header %}
    <div>
        <h1 class="text-3xl font-bold text-gray-900">
            {% if form.instance.pk %}
                √âditer Facture #{{ form.instance.reference }}
            {% else %}
                Cr√©er une Nouvelle Facture
            {% endif %}
        </h1>
        <p class="text-gray-600 mt-1">Compl√©tez les d√©tails de la facture de vente</p>
    </div>
{% endblock %}

{% block content %}
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Main Form -->
        <div class="lg:col-span-2">
            <form method="post" class="bg-white rounded-lg shadow-md p-6 space-y-6">
                {% csrf_token %}

                <!-- Display Form Errors -->
                {% if form.non_field_errors %}
                    <div class="bg-red-50 border border-red-200 rounded-lg p-4 mb-4">
                        <p class="text-red-700 font-bold">Erreurs:</p>
                        {% for error in form.non_field_errors %}
                            <p class="text-red-600 text-sm">{{ error }}</p>
                        {% endfor %}
                    </div>
                {% endif %}

                <!-- Client Section -->
                <div class="border-b border-gray-200 pb-6">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-lg font-bold text-gray-900">Client</h2>
                        <button type="button" class="bg-blue-100 hover:bg-blue-200 text-blue-700 px-3 py-1 rounded text-sm"
                                data-bs-toggle="modal" data-bs-target="#addClientModal">
                            <i class="fas fa-plus"></i> Nouveau Client
                        </button>
                    </div>

                    <div>
                        {{ form.client }}
                        <p class="text-xs text-gray-500 mt-2">Laissez vide pour une vente sans client (walk-in)</p>
                        {% if form.client.errors %}
                            <p class="text-red-600 text-sm mt-2">{{ form.client.errors.0 }}</p>
                        {% endif %}
                    </div>
                </div>

                <!-- Essential Info Section -->
                <div class="border-b border-gray-200 pb-6">
                    <h2 class="text-lg font-bold text-gray-900 mb-4">Param√®tres</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">TVA (%)</label>
                            {{ form.tax_rate }}
                            {% if form.tax_rate.errors %}
                                <p class="text-red-600 text-sm mt-1">{{ form.tax_rate.errors.0 }}</p>
                            {% endif %}
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">M√©thode de Paiement</label>
                            {{ form.payment_method }}
                            {% if form.payment_method.errors %}
                                <p class="text-red-600 text-sm mt-1">{{ form.payment_method.errors.0 }}</p>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Conditional Payment Reference (for bank transfer, cheque, mobile payment, cards) -->
                    <div id="paymentRefSection" class="hidden mt-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            R√©f√©rence de Paiement <span class="text-red-500">*</span>
                        </label>
                        <input type="text" id="paymentReference" name="payment_reference"
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                               placeholder="N¬∞ de ch√®que, r√©f√©rence virement, n¬∞ de carte...">
                        <p class="text-xs text-gray-500 mt-1">
                            Obligatoire pour virement, ch√®que, paiement mobile ou carte
                        </p>
                    </div>

                    <p class="text-xs text-gray-500 mt-3">
                        <i class="fas fa-info-circle mr-1"></i>
                        Remises appliqu√©es par produit ‚Ä¢ Livraison configur√©e apr√®s cr√©ation
                    </p>
                </div>

                <!-- Items Section -->
                <div class="border-b border-gray-200 pb-6">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-lg font-bold text-gray-900">Articles</h2>
                        <button type="button" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg flex items-center text-sm"
                                id="addItemBtn">
                            <i class="fas fa-plus mr-2"></i> Ajouter un Article
                        </button>
                    </div>

                    <!-- Items List -->
                    <div id="itemsContainer" class="space-y-3 mb-4">
                        <!-- Items will be added here dynamically -->
                    </div>

                    <!-- Add Item Form (Hidden by default) -->
                    <div id="addItemSection" class="bg-gray-50 border border-gray-200 rounded-lg p-4 hidden">
                        <h3 class="font-bold text-gray-900 mb-4">Ajouter un Nouvel Article</h3>
                        <div class="space-y-3">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Produit *</label>
                                <select id="product_id" class="w-full border border-gray-300 rounded px-3 py-2" required>
                                    <option value="">-- S√©lectionnez un produit --</option>
                                    {% for product in products %}
                                        <option value="{{ product.id }}" data-price="{{ product.selling_price }}">
                                            {{ product.reference }} - {{ product.name }}
                                        </option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Quantit√© *</label>
                                    <input type="number" id="quantity" class="w-full border border-gray-300 rounded px-3 py-2"
                                           step="0.001" min="0.001" value="1" required>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Prix Unitaire (DH)</label>
                                    <input type="number" id="unit_price" class="w-full border border-gray-300 rounded px-3 py-2 bg-gray-100"
                                           step="0.01" min="0" readonly>
                                    <p class="text-xs text-gray-500 mt-1">Auto-d√©tect√© du produit</p>
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Remise (DH)</label>
                                <input type="number" id="discount_amount" class="w-full border border-gray-300 rounded px-3 py-2"
                                       step="0.01" min="0" value="0">
                            </div>
                            <div class="bg-white p-3 rounded border border-gray-200">
                                <div class="mb-2">
                                    <div class="flex justify-between text-sm">
                                        <span>Sous-total:</span>
                                        <span><span id="subtotal_display">0.00</span> DH</span>
                                    </div>
                                </div>
                                <div class="mb-2">
                                    <div class="flex justify-between text-sm">
                                        <span>Remise:</span>
                                        <span>-<span id="discount_display">0.00</span> DH</span>
                                    </div>
                                </div>
                                <hr style="margin: 0.5rem 0;">
                                <div class="flex justify-between items-center font-bold">
                                    <span>Total de l'article:</span>
                                    <span class="text-lg text-green-600" id="estimated_total">0.00 DH</span>
                                </div>
                            </div>
                            <div class="flex gap-2">
                                <button type="button" id="confirmItemBtn" class="flex-1 bg-green-600 hover:bg-green-700 text-white font-bold py-2 rounded">
                                    <i class="fas fa-check mr-2"></i> Ajouter
                                </button>
                                <button type="button" id="cancelItemBtn" class="flex-1 bg-gray-400 hover:bg-gray-500 text-white font-bold py-2 rounded">
                                    Annuler
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Empty State -->
                    <div id="emptyState" class="bg-gray-50 border border-gray-200 rounded-lg p-6 text-center">
                        <p class="text-gray-600">
                            <i class="fas fa-inbox text-2xl mb-2 block"></i>
                            Aucun article ajout√©. Cliquez sur "Ajouter un Article" pour commencer.
                        </p>
                    </div>
                </div>

                <!-- Notes Section -->
                <div>
                    <h2 class="text-lg font-bold text-gray-900 mb-4">Notes</h2>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Observations</label>
                    {{ form.notes }}
                    {% if form.notes.errors %}
                        <p class="text-red-600 text-sm mt-1">{{ form.notes.errors.0 }}</p>
                    {% endif %}
                </div>

                <!-- Submit Buttons -->
                <div class="flex gap-4 pt-6 border-t border-gray-200">
                    <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg flex items-center">
                        <i class="fas fa-save mr-2"></i>
                        {% if form.instance.pk %}Mettre √† jour{% else %}Cr√©er la Facture{% endif %}
                    </button>
                    <a href="{% url 'sales:invoice_list' %}" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-6 rounded-lg flex items-center">
                        <i class="fas fa-arrow-left mr-2"></i> Annuler
                    </a>
                </div>
            </form>
        </div>

        <!-- Info Panel -->
        <div class="space-y-6">
            <!-- Reference Info -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h3 class="text-lg font-bold text-gray-900 mb-4">R√©f√©rence</h3>
                <div class="bg-gray-100 p-3 rounded text-center">
                    <p class="text-sm text-gray-600">Num√©ro de Facture</p>
                    <p class="text-xl font-bold text-gray-900">
                        {% if form.instance.pk %}
                            {{ form.instance.reference }}
                        {% else %}
                            Auto-g√©n√©r√©
                        {% endif %}
                    </p>
                </div>
                {% if form.instance.pk %}
                    <p class="text-xs text-gray-500 mt-3">Cr√©√©e le {{ form.instance.created_at|date:'d/m/Y H:i' }}</p>
                {% endif %}
            </div>

            <!-- Quick Help -->
            <div class="bg-green-50 border border-green-200 rounded-lg p-6">
                <h3 class="text-lg font-bold text-green-900 mb-3">üöÄ Workflow Simple</h3>
                <ul class="space-y-2 text-sm text-green-800">
                    <li><i class="fas fa-check text-green-600 mr-2"></i> S√©lectionnez un client (optionnel)</li>
                    <li><i class="fas fa-check text-green-600 mr-2"></i> Ajoutez les articles</li>
                    <li><i class="fas fa-check text-green-600 mr-2"></i> Param√®tres: remise, TVA, paiement</li>
                    <li><i class="fas fa-check text-green-600 mr-2"></i> Cr√©er ‚Üí Facture pr√™te!</li>
                </ul>
            </div>

            <!-- Status Info -->
            {% if form.instance.pk %}
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h3 class="text-lg font-bold text-gray-900 mb-4">√âtat</h3>
                    <div class="space-y-2">
                        <p><strong>Statut:</strong> <span class="badge bg-warning">{{ form.instance.get_status_display }}</span></p>
                        <p><strong>Total:</strong> <span class="text-xl font-bold text-green-600">{{ form.instance.total_amount|floatformat:2 }} DH</span></p>
                        <p><strong>Pay√©:</strong> <span>{{ form.instance.amount_paid|floatformat:2 }} DH</span></p>
                        <p><strong>D√ª:</strong> <span class="font-bold">{{ form.instance.balance_due|floatformat:2 }} DH</span></p>
                    </div>
                </div>
            {% endif %}
        </div>
    </div>

    <!-- Modal: Quick Add Client -->
    <div class="modal fade" id="addClientModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Ajouter un Nouveau Client</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="quickAddClientForm">
                        {% csrf_token %}
                        <div class="mb-3">
                            <label class="form-label">Pr√©nom</label>
                            <input type="text" name="first_name" class="form-control" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Nom</label>
                            <input type="text" name="last_name" class="form-control" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">T√©l√©phone</label>
                            <input type="tel" name="phone" class="form-control" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Email</label>
                            <input type="email" name="email" class="form-control">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Ville</label>
                            <input type="text" name="city" class="form-control">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button type="button" class="btn btn-primary" id="saveClientBtn">Ajouter Client</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let invoiceItems = [];

        document.addEventListener('DOMContentLoaded', function() {
            // ============ QUICK ADD CLIENT ============
            const saveClientBtn = document.getElementById('saveClientBtn');
            if (saveClientBtn) {
                saveClientBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    const form = document.getElementById('quickAddClientForm');
                    const formData = new FormData(form);
                    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

                    fetch('{% url "clients:quick_create" %}', {
                        method: 'POST',
                        body: formData,
                        headers: {
                            'X-CSRFToken': csrfToken
                        }
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            const selectElement = document.querySelector('select[name="client"]');
                            if (selectElement) {
                                const option = document.createElement('option');
                                option.value = data.client_id;
                                option.textContent = data.client_name + ' (' + data.client_email + ')';
                                selectElement.appendChild(option);
                                selectElement.value = data.client_id;
                            }
                            const modalEl = document.getElementById('addClientModal');
                            const modal = bootstrap.Modal.getInstance(modalEl);
                            if (modal) modal.hide();
                            form.reset();
                            alert('Client ajout√© avec succ√®s!');
                        } else {
                            alert('Erreur: ' + (data.error || 'Erreur inconnue'));
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('Erreur: ' + error);
                    });
                });
            }

            // ============ PAYMENT REFERENCE CONDITIONAL ============
            const paymentMethodSelect = document.querySelector('select[name="payment_method"]');
            const paymentRefSection = document.getElementById('paymentRefSection');

            function updatePaymentRefVisibility() {
                if (!paymentMethodSelect || !paymentMethodSelect.value) {
                    paymentRefSection.classList.add('hidden');
                    paymentRefSection.style.display = 'none';
                    return;
                }

                // Get the selected option's text
                const selectedText = paymentMethodSelect.options[paymentMethodSelect.selectedIndex].text;

                // Define payment methods that DO NOT require reference (only Esp√®ces)
                const noReferenceNeeded = ['Esp√®ces', 'espece', 'cash'];

                // Show reference field for everything EXCEPT cash/esp√®ces
                const showReference = !noReferenceNeeded.some(text =>
                    selectedText.toLowerCase().includes(text.toLowerCase())
                );

                if (showReference) {
                    paymentRefSection.classList.remove('hidden');
                    paymentRefSection.style.display = 'block';
                } else {
                    paymentRefSection.classList.add('hidden');
                    paymentRefSection.style.display = 'none';
                }
            }

            if (paymentMethodSelect) {
                paymentMethodSelect.addEventListener('change', updatePaymentRefVisibility);
                // Check on page load
                setTimeout(updatePaymentRefVisibility, 100);
            }

            // ============ ARTICLE MANAGEMENT ============
            const addItemBtn = document.getElementById('addItemBtn');
            const cancelItemBtn = document.getElementById('cancelItemBtn');
            const confirmItemBtn = document.getElementById('confirmItemBtn');
            const addItemSection = document.getElementById('addItemSection');
            const productSelect = document.getElementById('product_id');
            const quantityInput = document.getElementById('quantity');
            const unitPriceInput = document.getElementById('unit_price');
            const estimatedTotalSpan = document.getElementById('estimated_total');

            // Show/hide add item form
            addItemBtn.addEventListener('click', function() {
                addItemSection.classList.remove('hidden');
                productSelect.focus();
            });

            cancelItemBtn.addEventListener('click', function() {
                addItemSection.classList.add('hidden');
                resetItemForm();
            });

            const discountInput = document.getElementById('discount_amount');

            // Auto-fill price when product selected
            productSelect.addEventListener('change', function() {
                if (this.value) {
                    const option = this.options[this.selectedIndex];
                    const price = parseFloat(option.dataset.price) || 0;
                    unitPriceInput.value = price.toFixed(2);
                    updateEstimatedTotal();
                }
            });

            // Update total on input change
            [quantityInput, unitPriceInput, discountInput].forEach(input => {
                input.addEventListener('change', updateEstimatedTotal);
                input.addEventListener('keyup', updateEstimatedTotal);
            });

            function updateEstimatedTotal() {
                const qty = parseFloat(quantityInput.value) || 0;
                const price = parseFloat(unitPriceInput.value) || 0;
                const discount = parseFloat(discountInput.value) || 0;
                const subtotal = qty * price;
                const total = Math.max(0, subtotal - discount);

                document.getElementById('subtotal_display').textContent = subtotal.toFixed(2);
                document.getElementById('discount_display').textContent = discount.toFixed(2);
                estimatedTotalSpan.textContent = total.toFixed(2) + ' DH';
            }

            // Add item to list
            confirmItemBtn.addEventListener('click', function() {
                if (!productSelect.value) {
                    alert('S√©lectionnez un produit');
                    return;
                }
                if (!quantityInput.value || parseFloat(quantityInput.value) <= 0) {
                    alert('Entrez une quantit√© valide');
                    return;
                }
                if (!unitPriceInput.value || parseFloat(unitPriceInput.value) < 0) {
                    alert('Entrez un prix valide');
                    return;
                }

                const productOption = productSelect.options[productSelect.selectedIndex];
                const qty = parseFloat(quantityInput.value);
                const price = parseFloat(unitPriceInput.value);
                const discount = parseFloat(discountInput.value) || 0;
                const subtotal = qty * price;
                const total = Math.max(0, subtotal - discount);

                const item = {
                    id: Date.now(),
                    product_id: productSelect.value,
                    product_name: productOption.text,
                    quantity: qty,
                    unit_price: price,
                    discount_amount: discount,
                    total_amount: total
                };

                invoiceItems.push(item);
                renderItems();
                resetItemForm();
                addItemSection.classList.add('hidden');
            });

            function resetItemForm() {
                productSelect.value = '';
                quantityInput.value = '1';
                unitPriceInput.value = '';
                discountInput.value = '0';
                estimatedTotalSpan.textContent = '0.00 DH';
                document.getElementById('subtotal_display').textContent = '0.00';
                document.getElementById('discount_display').textContent = '0.00';
            }

            function renderItems() {
                const container = document.getElementById('itemsContainer');
                const emptyState = document.getElementById('emptyState');

                if (invoiceItems.length === 0) {
                    container.innerHTML = '';
                    emptyState.classList.remove('hidden');
                    return;
                }

                emptyState.classList.add('hidden');
                container.innerHTML = invoiceItems.map((item, index) => `
                    <div class="bg-white border border-gray-200 rounded-lg p-4 hover:shadow-md transition">
                        <div class="flex items-center justify-between mb-2">
                            <div class="flex-1">
                                <p class="font-bold text-gray-900">${item.product_name}</p>
                                <p class="text-sm text-gray-600">Qty: ${item.quantity} √ó ${item.unit_price.toFixed(2)} DH</p>
                            </div>
                            <button type="button" class="text-red-600 hover:text-red-800 text-sm ml-2" onclick="removeItem(${index})">
                                <i class="fas fa-trash mr-1"></i> Supprimer
                            </button>
                        </div>
                        <div class="bg-gray-50 p-2 rounded text-sm">
                            <div class="flex justify-between">
                                <span>Sous-total:</span>
                                <span>${(item.quantity * item.unit_price).toFixed(2)} DH</span>
                            </div>
                            ${item.discount_amount > 0 ? `<div class="flex justify-between text-red-600">
                                <span>Remise:</span>
                                <span>-${item.discount_amount.toFixed(2)} DH</span>
                            </div>` : ''}
                            <div class="flex justify-between font-bold border-t pt-1 mt-1">
                                <span>Total:</span>
                                <span class="text-green-600">${item.total_amount.toFixed(2)} DH</span>
                            </div>
                        </div>
                    </div>
                `).join('');
            }

            window.removeItem = function(index) {
                invoiceItems.splice(index, 1);
                renderItems();
            };

            // Add items to form before submit
            const form = document.querySelector('form');
            form.addEventListener('submit', function(e) {
                if (invoiceItems.length > 0) {
                    // Create hidden inputs for articles
                    const container = document.createElement('div');
                    invoiceItems.forEach((item, index) => {
                        const input = document.createElement('input');
                        input.type = 'hidden';
                        input.name = `items[${index}]`;
                        input.value = JSON.stringify(item);
                        container.appendChild(input);
                    });
                    form.appendChild(container);
                }
            });
        });
    </script>
{% endblock %}
