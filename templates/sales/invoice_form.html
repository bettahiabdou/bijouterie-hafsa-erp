{% extends 'base.html' %}
{% load humanize %}

{% block title %}{% if form.instance.pk %}Editer Facture{% else %}Nouvelle Facture{% endif %} - Bijouterie Hafsa ERP{% endblock %}

{% block breadcrumb %}
    <span class="breadcrumb-separator">/</span>
    <a href="{% url 'sales:invoice_list' %}" class="breadcrumb-item">Factures</a>
    <span class="breadcrumb-separator">/</span>
    <span class="breadcrumb-item active">{% if form.instance.pk %}Editer{% else %}Nouvelle{% endif %}</span>
{% endblock %}

{% block page_header %}
    <div class="page-header">
        <div class="page-header-inner">
            <div>
                <h1 class="page-title">
                    {% if form.instance.pk %}
                        Editer Facture #{{ form.instance.reference }}
                    {% else %}
                        Creer une Nouvelle Facture
                    {% endif %}
                </h1>
                <p class="page-subtitle">Completez les details de la facture de vente</p>
            </div>
            <div class="page-actions">
                <a href="{% url 'sales:invoice_list' %}" class="btn btn-secondary">
                    <i class="fas fa-arrow-left"></i>
                    <span>Annuler</span>
                </a>
            </div>
        </div>
    </div>
{% endblock %}

{% block content %}
    <form method="post" action="{% url 'sales:invoice_create' %}" class="invoice-form">
        {% csrf_token %}

        {% if messages %}
            {% for message in messages %}
                <div class="alert alert-{% if message.tags %}{{ message.tags }}{% else %}info{% endif %} mb-6 animate-slide-up">
                    <i class="fas fa-{% if message.tags == 'success' %}check-circle{% elif message.tags == 'error' %}exclamation-circle{% else %}info-circle{% endif %}"></i>
                    {{ message }}
                </div>
            {% endfor %}
        {% endif %}

        <!-- Display Form Errors -->
        {% if form.non_field_errors %}
            <div class="alert alert-error mb-6">
                <i class="fas fa-exclamation-circle"></i>
                {% for error in form.non_field_errors %}
                    {{ error }}
                {% endfor %}
            </div>
        {% endif %}

        <div class="invoice-layout">
            <!-- Main Form Column -->
            <div class="invoice-main">
                <!-- Client Section -->
                <div class="card mb-6 animate-slide-up">
                    <div class="card-header">
                        <h3><i class="fas fa-user mr-2"></i> Client</h3>
                        <button type="button" class="btn btn-secondary btn-sm"
                                data-bs-toggle="modal" data-bs-target="#addClientModal">
                            <i class="fas fa-plus"></i>
                            <span>Nouveau</span>
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="form-group">
                            {{ form.client }}
                            <p class="form-hint">Laissez vide pour une vente sans client (walk-in)</p>
                            {% if form.client.errors %}
                                <p class="form-error">{{ form.client.errors.0 }}</p>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Parameters Section -->
                <div class="card mb-6 animate-slide-up" style="animation-delay: 50ms;">
                    <div class="card-header">
                        <h3><i class="fas fa-cog mr-2"></i> Parametres</h3>
                    </div>
                    <div class="card-body">
                        <div class="form-group">
                            <label class="form-label" for="{{ form.tax_rate.id_for_label }}">TVA (%)</label>
                            {{ form.tax_rate }}
                            {% if form.tax_rate.errors %}
                                <p class="form-error">{{ form.tax_rate.errors.0 }}</p>
                            {% endif %}
                        </div>

                        <div class="info-hint mt-4">
                            <i class="fas fa-info-circle"></i>
                            Remises appliquees par produit - Les paiements se configurent dans la section "Paiements" ci-dessous
                        </div>
                    </div>
                </div>

                <!-- Articles Section -->
                <div class="card mb-6 animate-slide-up" style="animation-delay: 100ms;">
                    <div class="card-header">
                        <h3><i class="fas fa-shopping-cart mr-2"></i> Articles</h3>
                        <button type="button" class="btn btn-primary btn-sm" id="addItemBtn">
                            <i class="fas fa-plus"></i>
                            <span>Ajouter</span>
                        </button>
                    </div>
                    <div class="card-body">
                        <!-- Items List -->
                        <div id="itemsContainer" class="items-container">
                            <!-- Items will be added here dynamically -->
                        </div>

                        <!-- Add Item Form (Hidden by default) -->
                        <div id="addItemSection" class="add-item-form" style="display: none;">
                            <h4 class="mb-4"><i class="fas fa-plus-circle mr-2"></i> Ajouter un Nouvel Article</h4>
                            <div class="form-group">
                                <label class="form-label" for="product_id">Produit *</label>
                                <select id="product_id" class="form-select" required>
                                    <option value="">-- Selectionnez un produit --</option>
                                    {% for product in products %}
                                        <option value="{{ product.id }}" data-price="{{ product.selling_price }}">
                                            {{ product.reference }} - {{ product.name }}
                                        </option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label" for="quantity">Quantite *</label>
                                    <input type="number" id="quantity" class="form-input" step="0.001" min="0.001" value="1" required>
                                </div>
                                <div class="form-group">
                                    <label class="form-label" for="unit_price">Prix de Vente (DH) *</label>
                                    <input type="number" id="unit_price" class="form-input" step="0.01" min="0" required>
                                    <p class="form-hint">Modifiable pour appliquer une remise</p>
                                </div>
                            </div>
                            <div class="form-group" id="originalPriceInfo" style="display: none;">
                                <div class="price-comparison">
                                    <span class="original-price-label">Prix catalogue:</span>
                                    <span class="original-price-value" id="catalogPrice">0.00 DH</span>
                                    <span class="discount-badge" id="discountBadge" style="display: none;">-<span id="discountPercent">0</span>%</span>
                                </div>
                            </div>

                            <!-- Calculation Box -->
                            <div class="calculation-box">
                                <div class="calc-row">
                                    <span>Sous-total:</span>
                                    <span class="calc-value"><span id="subtotal_display">0.00</span> DH</span>
                                </div>
                                <div class="calc-row">
                                    <span>Remise:</span>
                                    <span class="calc-value text-error">-<span id="discount_display">0.00</span> DH</span>
                                </div>
                                <div class="calc-row calc-total">
                                    <span>Total de l'article:</span>
                                    <span id="estimated_total" class="text-primary">0.00 DH</span>
                                </div>
                            </div>

                            <div class="item-actions">
                                <button type="button" id="confirmItemBtn" class="btn btn-success">
                                    <i class="fas fa-check"></i> Ajouter
                                </button>
                                <button type="button" id="cancelItemBtn" class="btn btn-secondary">
                                    Annuler
                                </button>
                            </div>
                        </div>

                        <!-- Empty State -->
                        <div id="emptyState" class="empty-state">
                            <div class="empty-state-icon">
                                <i class="fas fa-inbox"></i>
                            </div>
                            <p>Aucun article ajoute. Cliquez sur "Ajouter" pour commencer.</p>
                        </div>
                    </div>
                </div>

                <!-- Payment Section - Multi-payment support -->
                <div class="card mb-6 animate-slide-up" style="animation-delay: 150ms;">
                    <div class="card-header">
                        <h3><i class="fas fa-money-bill-wave mr-2"></i> Paiements</h3>
                        <button type="button" class="btn btn-secondary btn-sm" id="addPaymentBtn">
                            <i class="fas fa-plus"></i>
                            <span>Ajouter</span>
                        </button>
                    </div>
                    <div class="card-body">
                        <!-- Payment Lines Container -->
                        <div id="paymentLinesContainer">
                            <!-- Payment lines will be added here dynamically -->
                        </div>

                        <!-- Empty State -->
                        <div id="paymentEmptyState" class="empty-state-small">
                            <i class="fas fa-credit-card"></i>
                            <p>Aucun paiement ajouté. Cliquez sur "Ajouter" pour enregistrer un paiement.</p>
                        </div>

                        <!-- Payment Summary -->
                        <div id="paymentSummary" class="payment-summary" style="display: none;">
                            <div class="payment-summary-row">
                                <span>Total des paiements:</span>
                                <span id="totalPayments">0.00 DH</span>
                            </div>
                        </div>

                        <p class="form-hint mt-3">
                            <i class="fas fa-info-circle"></i>
                            Vous pouvez ajouter plusieurs paiements (ex: Espèces + Virement)
                        </p>
                    </div>
                </div>

                <!-- Notes Section -->
                <div class="card mb-6 animate-slide-up" style="animation-delay: 200ms;">
                    <div class="card-header">
                        <h3><i class="fas fa-sticky-note mr-2"></i> Notes</h3>
                    </div>
                    <div class="card-body">
                        <div class="form-group">
                            <label class="form-label" for="{{ form.notes.id_for_label }}">Observations</label>
                            {{ form.notes }}
                            {% if form.notes.errors %}
                                <p class="form-error">{{ form.notes.errors.0 }}</p>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Form Actions -->
                <div class="form-actions animate-slide-up" style="animation-delay: 250ms;">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i>
                        <span>{% if form.instance.pk %}Mettre a jour{% else %}Creer la Facture{% endif %}</span>
                    </button>
                    <a href="{% url 'sales:invoice_list' %}" class="btn btn-secondary">
                        <i class="fas fa-times"></i>
                        <span>Annuler</span>
                    </a>
                </div>
            </div>

            <!-- Sidebar -->
            <div class="invoice-sidebar">
                <!-- Reference Card -->
                <div class="card mb-6 animate-slide-up">
                    <div class="card-header">
                        <h3>Reference</h3>
                    </div>
                    <div class="card-body">
                        <div class="form-group">
                            <label class="form-label" for="custom_reference">Numéro de Facture</label>
                            <input type="text" id="custom_reference" name="custom_reference" class="form-input"
                                   placeholder="Ex: FAC-2026-001 (laisser vide pour auto-générer)"
                                   value="{% if form.instance.pk %}{{ form.instance.reference }}{% endif %}">
                            <p class="form-hint">Laissez vide pour générer automatiquement (INV-YYYYMMDD-XXXX)</p>
                        </div>
                        {% if form.instance.pk %}
                            <p class="reference-date">Creee le {{ form.instance.created_at|date:'d/m/Y H:i' }}</p>
                        {% endif %}
                    </div>
                </div>

                <!-- Help Card -->
                <div class="card mb-6 animate-slide-up help-card" style="animation-delay: 50ms;">
                    <div class="card-body">
                        <h4 class="help-title"><i class="fas fa-lightbulb mr-2"></i> Workflow Simple</h4>
                        <ul class="help-list">
                            <li><i class="fas fa-check text-success"></i> Selectionnez un client (optionnel)</li>
                            <li><i class="fas fa-check text-success"></i> Ajoutez les articles</li>
                            <li><i class="fas fa-check text-success"></i> Parametres: remise, TVA, paiement</li>
                            <li><i class="fas fa-check text-success"></i> Creer - Facture prete!</li>
                        </ul>
                    </div>
                </div>

                <!-- Summary Card -->
                <div class="card animate-slide-up" style="animation-delay: 100ms;">
                    <div class="card-header">
                        <h3>Resume & Paiement</h3>
                    </div>
                    <div class="card-body">
                        <div class="summary-row">
                            <span class="summary-label">Total Facture</span>
                            <span class="summary-value" id="invoiceTotal">0.00 DH</span>
                        </div>
                        <div class="summary-row">
                            <span class="summary-label">Solde Restant</span>
                            <span class="summary-value" id="balanceDue">0.00 DH</span>
                        </div>
                        <div class="summary-status">
                            <i class="fas fa-info-circle"></i>
                            <span id="paymentStatus">Ajoutez les articles pour voir le total</span>
                        </div>
                    </div>
                </div>

                <!-- Existing Invoice Status -->
                {% if form.instance.pk %}
                    <div class="card mt-6 animate-slide-up" style="animation-delay: 150ms;">
                        <div class="card-header">
                            <h3>Etat</h3>
                        </div>
                        <div class="card-body">
                            <div class="status-grid">
                                <div class="status-row">
                                    <span>Statut:</span>
                                    <span class="badge badge-{% if form.instance.status == 'paid' %}success{% elif form.instance.status == 'partial' %}warning{% else %}error{% endif %}">
                                        {{ form.instance.get_status_display }}
                                    </span>
                                </div>
                                <div class="status-row">
                                    <span>Total:</span>
                                    <span class="text-primary font-semibold">{{ form.instance.total_amount|floatformat:2 }} DH</span>
                                </div>
                                <div class="status-row">
                                    <span>Paye:</span>
                                    <span>{{ form.instance.amount_paid|floatformat:2 }} DH</span>
                                </div>
                                <div class="status-row">
                                    <span>Du:</span>
                                    <span class="text-primary font-semibold">{{ form.instance.balance_due|floatformat:2 }} DH</span>
                                </div>
                            </div>
                        </div>
                    </div>
                {% endif %}
            </div>
        </div>
    </form>

    <!-- Modal: Quick Add Client -->
    <div class="modal fade" id="addClientModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Ajouter un Nouveau Client</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="quickAddClientForm">
                        {% csrf_token %}
                        <div class="form-group mb-4">
                            <label class="form-label" for="first_name">Prenom</label>
                            <input type="text" id="first_name" name="first_name" class="form-input" required>
                        </div>
                        <div class="form-group mb-4">
                            <label class="form-label" for="last_name">Nom</label>
                            <input type="text" id="last_name" name="last_name" class="form-input" required>
                        </div>
                        <div class="form-group mb-4">
                            <label class="form-label" for="phone">Telephone</label>
                            <input type="tel" id="phone" name="phone" class="form-input" required>
                        </div>
                        <div class="form-group mb-4">
                            <label class="form-label" for="email">Email</label>
                            <input type="email" id="email" name="email" class="form-input">
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="city">Ville</label>
                            <input type="text" id="city" name="city" class="form-input">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button type="button" class="btn btn-primary" id="saveClientBtn">Ajouter Client</button>
                </div>
            </div>
        </div>
    </div>

    <style>
        /* Invoice Form Layout */
        .invoice-form {
            max-width: 1400px;
            margin: 0 auto;
        }

        .invoice-layout {
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: var(--space-6);
        }

        @media (max-width: 1024px) {
            .invoice-layout {
                grid-template-columns: 1fr;
            }

            .invoice-sidebar {
                order: -1;
            }
        }

        /* Form Elements */
        .form-row {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: var(--space-4);
        }

        @media (max-width: 640px) {
            .form-row {
                grid-template-columns: 1fr;
            }
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: var(--space-2);
        }

        .form-label {
            font-size: var(--text-sm);
            font-weight: var(--font-medium);
            color: var(--neutral-700);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .form-input,
        .form-select {
            padding: var(--space-3) var(--space-4);
            border: 1px solid var(--neutral-300);
            border-radius: var(--radius-md);
            font-size: var(--text-base);
            color: var(--neutral-800);
            background: white;
            transition: all var(--transition-fast);
        }

        .form-input:focus,
        .form-select:focus {
            outline: none;
            border-color: var(--primary-400);
            box-shadow: 0 0 0 3px rgba(183, 110, 121, 0.1);
        }

        .form-hint {
            font-size: var(--text-xs);
            color: var(--neutral-500);
            margin: 0;
        }

        .form-error {
            font-size: var(--text-sm);
            color: var(--error-500);
            margin: 0;
        }

        .info-hint {
            font-size: var(--text-sm);
            color: var(--neutral-500);
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }

        /* Items Container */
        .items-container {
            display: flex;
            flex-direction: column;
            gap: var(--space-4);
            margin-bottom: var(--space-4);
        }

        .item-card {
            background: var(--neutral-50);
            border: 1px solid var(--neutral-200);
            border-radius: var(--radius-md);
            padding: var(--space-4);
        }

        .item-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: var(--space-3);
        }

        .item-card-title {
            font-weight: var(--font-semibold);
            color: var(--neutral-800);
        }

        .item-card-subtitle {
            font-size: var(--text-sm);
            color: var(--neutral-600);
        }

        .item-card-summary {
            background: white;
            padding: var(--space-3);
            border-radius: var(--radius-md);
            font-size: var(--text-sm);
        }

        .item-summary-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: var(--space-1);
        }

        .item-summary-row:last-child {
            margin-bottom: 0;
            padding-top: var(--space-2);
            border-top: 1px solid var(--neutral-200);
            font-weight: var(--font-semibold);
        }

        /* Add Item Form */
        .add-item-form {
            background: var(--neutral-50);
            border: 1px solid var(--neutral-200);
            border-radius: var(--radius-md);
            padding: var(--space-4);
        }

        .add-item-form h4 {
            font-size: var(--text-lg);
            font-weight: var(--font-semibold);
            color: var(--neutral-800);
        }

        /* Price comparison display */
        .price-comparison {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            padding: var(--space-2) var(--space-3);
            background: var(--warning-50);
            border: 1px solid var(--warning-200);
            border-radius: var(--radius-md);
            font-size: var(--text-sm);
        }

        .original-price-label {
            color: var(--neutral-600);
        }

        .original-price-value {
            font-weight: var(--font-semibold);
            color: var(--neutral-800);
            text-decoration: line-through;
        }

        .discount-badge {
            background: var(--success-500);
            color: white;
            padding: var(--space-1) var(--space-2);
            border-radius: var(--radius-sm);
            font-weight: var(--font-semibold);
            font-size: var(--text-xs);
        }

        .calculation-box {
            background: white;
            padding: var(--space-4);
            border-radius: var(--radius-md);
            border: 1px solid var(--neutral-200);
            margin: var(--space-4) 0;
        }

        .calc-row {
            display: flex;
            justify-content: space-between;
            font-size: var(--text-sm);
            margin-bottom: var(--space-2);
        }

        .calc-row:last-child {
            margin-bottom: 0;
        }

        .calc-total {
            padding-top: var(--space-2);
            border-top: 1px solid var(--neutral-200);
            font-weight: var(--font-semibold);
        }

        .calc-value {
            font-weight: var(--font-medium);
        }

        .item-actions {
            display: flex;
            gap: var(--space-3);
        }

        /* Empty State */
        .empty-state {
            background: var(--neutral-50);
            border: 1px dashed var(--neutral-300);
            border-radius: var(--radius-md);
            padding: var(--space-8);
            text-align: center;
        }

        .empty-state-icon {
            font-size: 2.5rem;
            color: var(--neutral-400);
            margin-bottom: var(--space-3);
        }

        .empty-state p {
            color: var(--neutral-500);
            font-size: var(--text-sm);
            margin: 0;
        }

        /* Form Actions */
        .form-actions {
            display: flex;
            gap: var(--space-4);
        }

        @media (max-width: 640px) {
            .form-actions {
                flex-direction: column;
            }

            .form-actions .btn {
                width: 100%;
                justify-content: center;
            }
        }

        /* Sidebar */
        .invoice-sidebar {
            display: flex;
            flex-direction: column;
        }

        .reference-box {
            background: var(--neutral-50);
            padding: var(--space-4);
            border-radius: var(--radius-md);
            text-align: center;
        }

        .reference-label {
            display: block;
            font-size: var(--text-xs);
            color: var(--neutral-500);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: var(--space-2);
        }

        .reference-value {
            display: block;
            font-size: var(--text-xl);
            font-weight: var(--font-semibold);
            color: var(--neutral-800);
        }

        .reference-date {
            font-size: var(--text-xs);
            color: var(--neutral-500);
            text-align: center;
            margin-top: var(--space-3);
        }

        /* Help Card */
        .help-card {
            background: var(--success-50);
            border: 1px solid var(--success-200);
        }

        .help-card .card-body {
            padding: var(--space-4);
        }

        .help-title {
            font-size: var(--text-base);
            font-weight: var(--font-semibold);
            color: var(--success-700);
            margin-bottom: var(--space-3);
        }

        .help-list {
            list-style: none;
            padding: 0;
            margin: 0;
            display: flex;
            flex-direction: column;
            gap: var(--space-2);
        }

        .help-list li {
            font-size: var(--text-sm);
            color: var(--success-700);
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }

        /* Summary */
        .summary-row {
            background: var(--neutral-50);
            padding: var(--space-3);
            border-radius: var(--radius-md);
            margin-bottom: var(--space-3);
        }

        .summary-label {
            display: block;
            font-size: var(--text-sm);
            color: var(--neutral-600);
            margin-bottom: var(--space-1);
        }

        .summary-value {
            display: block;
            font-size: var(--text-2xl);
            font-weight: var(--font-semibold);
            color: var(--primary-500);
        }

        .summary-status {
            font-size: var(--text-xs);
            color: var(--neutral-500);
            display: flex;
            align-items: center;
            gap: var(--space-2);
            padding-top: var(--space-3);
            border-top: 1px solid var(--neutral-200);
        }

        /* Status Grid */
        .status-grid {
            display: flex;
            flex-direction: column;
            gap: var(--space-3);
        }

        .status-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: var(--text-sm);
        }

        /* Utility Classes */
        .mt-4 { margin-top: var(--space-4); }
        .mb-4 { margin-bottom: var(--space-4); }
        .mr-2 { margin-right: var(--space-2); }
        .text-primary { color: var(--primary-500); }
        .text-success { color: var(--success-500); }
        .text-error { color: var(--error-500); }
        .font-semibold { font-weight: var(--font-semibold); }

        /* Mobile Sidebar */
        @media (max-width: 1024px) {
            .invoice-sidebar {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
                gap: var(--space-4);
            }

            .invoice-sidebar .card {
                margin-bottom: 0 !important;
            }
        }
    </style>

    <script>
        let invoiceItems = [];

        document.addEventListener('DOMContentLoaded', function() {
            // ============ QUICK ADD CLIENT ============
            const saveClientBtn = document.getElementById('saveClientBtn');
            if (saveClientBtn) {
                saveClientBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    const form = document.getElementById('quickAddClientForm');
                    const formData = new FormData(form);
                    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

                    fetch('{% url "clients:quick_create" %}', {
                        method: 'POST',
                        body: formData,
                        headers: {
                            'X-CSRFToken': csrfToken
                        }
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            const selectElement = document.querySelector('select[name="client"]');
                            if (selectElement) {
                                const option = document.createElement('option');
                                option.value = data.client_id;
                                option.textContent = data.client_name + ' (' + data.client_email + ')';
                                selectElement.appendChild(option);
                                selectElement.value = data.client_id;
                            }
                            const modalEl = document.getElementById('addClientModal');
                            const modal = bootstrap.Modal.getInstance(modalEl);
                            if (modal) modal.hide();
                            form.reset();
                            alert('Client ajoute avec succes!');
                        } else {
                            alert('Erreur: ' + (data.error || 'Erreur inconnue'));
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('Erreur: ' + error);
                    });
                });
            }

            // ============ HELPER FUNCTIONS ============
            // Track current catalog price globally for calculations
            let globalCatalogPrice = 0;

            function updateEstimatedTotal() {
                const quantityInput = document.getElementById('quantity');
                const unitPriceInput = document.getElementById('unit_price');

                if (!quantityInput || !unitPriceInput) return;

                const qty = parseFloat(quantityInput.value) || 0;
                const enteredPrice = parseFloat(unitPriceInput.value) || 0;
                const catalogPrice = globalCatalogPrice || enteredPrice;

                // Calculate discount as difference between catalog and entered price
                const priceDiscount = Math.max(0, catalogPrice - enteredPrice);
                const totalDiscount = priceDiscount * qty;
                const subtotal = catalogPrice * qty;  // Original price * quantity
                const total = enteredPrice * qty;  // Final price after discount

                const subtotalEl = document.getElementById('subtotal_display');
                const discountEl = document.getElementById('discount_display');
                const estimatedTotalSpan = document.getElementById('estimated_total');

                if (subtotalEl) subtotalEl.textContent = subtotal.toFixed(2);
                if (discountEl) discountEl.textContent = totalDiscount.toFixed(2);
                if (estimatedTotalSpan) estimatedTotalSpan.textContent = total.toFixed(2) + ' DH';
            }

            function resetItemForm() {
                const productSelect = document.getElementById('product_id');
                const quantityInput = document.getElementById('quantity');
                const unitPriceInput = document.getElementById('unit_price');

                if (productSelect) productSelect.value = '';
                if (quantityInput) quantityInput.value = '1';
                if (unitPriceInput) unitPriceInput.value = '';

                // Reset global catalog price
                globalCatalogPrice = 0;

                // Hide price info and discount badge
                const priceInfo = document.getElementById('originalPriceInfo');
                const discountBadge = document.getElementById('discountBadge');
                if (priceInfo) priceInfo.style.display = 'none';
                if (discountBadge) discountBadge.style.display = 'none';

                const subtotalEl = document.getElementById('subtotal_display');
                const discountEl = document.getElementById('discount_display');
                const estimatedTotalSpan = document.getElementById('estimated_total');

                if (subtotalEl) subtotalEl.textContent = '0.00';
                if (discountEl) discountEl.textContent = '0.00';
                if (estimatedTotalSpan) estimatedTotalSpan.textContent = '0.00 DH';
            }

            function renderItems() {
                const container = document.getElementById('itemsContainer');
                const emptyState = document.getElementById('emptyState');

                if (!container || !emptyState) return;

                if (invoiceItems.length === 0) {
                    container.innerHTML = '';
                    emptyState.style.display = 'block';
                    return;
                }

                emptyState.style.display = 'none';
                container.innerHTML = invoiceItems.map((item, index) => {
                    const originalPrice = item.original_price || item.unit_price;
                    const hasDiscount = item.discount_amount > 0;
                    const originalSubtotal = originalPrice * item.quantity;

                    return `
                    <div class="item-card">
                        <div class="item-card-header">
                            <div>
                                <p class="item-card-title">${item.product_name}</p>
                                <p class="item-card-subtitle">Qty: ${item.quantity} x ${item.unit_price.toFixed(2)} DH${hasDiscount ? ` <span style="text-decoration: line-through; color: var(--neutral-400);">(${originalPrice.toFixed(2)} DH)</span>` : ''}</p>
                            </div>
                            <button type="button" class="btn btn-error btn-sm" onclick="window.removeItem(${index})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                        <div class="item-card-summary">
                            ${hasDiscount ? `<div class="item-summary-row">
                                <span>Prix catalogue:</span>
                                <span style="text-decoration: line-through; color: var(--neutral-400);">${originalSubtotal.toFixed(2)} DH</span>
                            </div>` : ''}
                            ${hasDiscount ? `<div class="item-summary-row text-error">
                                <span>Remise:</span>
                                <span>-${item.discount_amount.toFixed(2)} DH</span>
                            </div>` : ''}
                            <div class="item-summary-row">
                                <span>Total:</span>
                                <span class="text-success font-semibold">${item.total_amount.toFixed(2)} DH</span>
                            </div>
                        </div>
                    </div>
                `}).join('');

                updateInvoiceSummary();
            }

            function updateInvoiceSummary() {
                const invoiceTotal = invoiceItems.reduce((sum, item) => sum + item.total_amount, 0);
                const invoiceTotalDisplay = document.getElementById('invoiceTotal');
                const balanceDueDisplay = document.getElementById('balanceDue');
                const paymentStatusDisplay = document.getElementById('paymentStatus');

                if (!invoiceTotalDisplay || !balanceDueDisplay) return;

                invoiceTotalDisplay.textContent = invoiceTotal.toFixed(2) + ' DH';

                // Get total from payment lines (will be 0 if paymentLines not yet initialized)
                const amountPaid = (typeof paymentLines !== 'undefined') ?
                    paymentLines.reduce((sum, p) => sum + (p.amount || 0), 0) : 0;
                const balance = invoiceTotal - amountPaid;

                balanceDueDisplay.textContent = balance.toFixed(2) + ' DH';

                if (balance <= 0 && invoiceTotal > 0) {
                    balanceDueDisplay.style.color = 'var(--success-500)';
                } else if (balance < invoiceTotal && amountPaid > 0) {
                    balanceDueDisplay.style.color = 'var(--warning-500)';
                } else {
                    balanceDueDisplay.style.color = 'var(--error-500)';
                }

                if (paymentStatusDisplay) {
                    if (invoiceTotal === 0) {
                        paymentStatusDisplay.textContent = 'Ajoutez les articles pour voir le total';
                    } else if (balance <= 0) {
                        paymentStatusDisplay.textContent = 'Facture payee en integralite';
                    } else if (amountPaid > 0) {
                        paymentStatusDisplay.textContent = 'Paiement partiel - ' + balance.toFixed(2) + ' DH restants';
                    } else {
                        paymentStatusDisplay.textContent = 'Facture non payee';
                    }
                }
            }

            window.removeItem = function(index) {
                invoiceItems.splice(index, 1);
                renderItems();
            };

            // ============ ARTICLE MANAGEMENT ============
            const addItemBtn = document.getElementById('addItemBtn');
            const cancelItemBtn = document.getElementById('cancelItemBtn');
            const confirmItemBtn = document.getElementById('confirmItemBtn');
            const addItemSection = document.getElementById('addItemSection');
            const productSelect = document.getElementById('product_id');
            const quantityInput = document.getElementById('quantity');
            const unitPriceInput = document.getElementById('unit_price');
            const discountInput = document.getElementById('discount_amount');

            if (addItemBtn) {
                addItemBtn.addEventListener('click', function() {
                    if (addItemSection) {
                        addItemSection.style.display = 'block';
                        if (productSelect) productSelect.focus();
                    }
                });

                if (cancelItemBtn) {
                    cancelItemBtn.addEventListener('click', function() {
                        if (addItemSection) addItemSection.style.display = 'none';
                        resetItemForm();
                    });
                }

                if (productSelect) {
                    productSelect.addEventListener('change', function() {
                        if (this.value) {
                            const option = this.options[this.selectedIndex];
                            const price = parseFloat(option.dataset.price) || 0;
                            globalCatalogPrice = price;  // Update global variable

                            if (unitPriceInput) unitPriceInput.value = price.toFixed(2);

                            // Show original price info
                            const priceInfo = document.getElementById('originalPriceInfo');
                            const catalogPriceEl = document.getElementById('catalogPrice');
                            if (priceInfo && catalogPriceEl) {
                                catalogPriceEl.textContent = price.toFixed(2) + ' DH';
                                priceInfo.style.display = 'block';
                            }

                            updateEstimatedTotal();
                        } else {
                            globalCatalogPrice = 0;
                            const priceInfo = document.getElementById('originalPriceInfo');
                            if (priceInfo) priceInfo.style.display = 'none';
                        }
                    });
                }

                // Update discount badge when price changes
                function updateDiscountBadge() {
                    const enteredPrice = parseFloat(unitPriceInput?.value) || 0;
                    const discountBadge = document.getElementById('discountBadge');
                    const discountPercent = document.getElementById('discountPercent');

                    if (discountBadge && discountPercent && globalCatalogPrice > 0) {
                        const priceDiff = globalCatalogPrice - enteredPrice;
                        if (priceDiff > 0) {
                            const percent = Math.round((priceDiff / currentCatalogPrice) * 100);
                            discountPercent.textContent = percent;
                            discountBadge.style.display = 'inline';
                        } else {
                            discountBadge.style.display = 'none';
                        }
                    }
                }

                [quantityInput, unitPriceInput].forEach(input => {
                    if (input) {
                        input.addEventListener('change', function() {
                            updateEstimatedTotal();
                            updateDiscountBadge();
                        });
                        input.addEventListener('keyup', function() {
                            updateEstimatedTotal();
                            updateDiscountBadge();
                        });
                    }
                });

                if (confirmItemBtn) {
                    confirmItemBtn.addEventListener('click', function() {
                        if (!productSelect || !productSelect.value) {
                            alert('Selectionnez un produit');
                            return;
                        }
                        if (!quantityInput || !quantityInput.value || parseFloat(quantityInput.value) <= 0) {
                            alert('Entrez une quantite valide');
                            return;
                        }
                        if (!unitPriceInput || !unitPriceInput.value || parseFloat(unitPriceInput.value) < 0) {
                            alert('Entrez un prix valide');
                            return;
                        }

                        const productOption = productSelect.options[productSelect.selectedIndex];
                        const qty = parseFloat(quantityInput.value);
                        const enteredPrice = parseFloat(unitPriceInput.value);
                        const catalogPrice = globalCatalogPrice || enteredPrice;

                        // Calculate discount as difference between catalog and entered price
                        const priceDiscount = Math.max(0, catalogPrice - enteredPrice);
                        const subtotal = qty * enteredPrice;
                        const total = subtotal;

                        const item = {
                            id: Date.now(),
                            product_id: productSelect.value,
                            product_name: productOption.text,
                            quantity: qty,
                            unit_price: enteredPrice,
                            original_price: catalogPrice,  // Include catalog price
                            discount_amount: priceDiscount * qty,  // Total discount for this item
                            total_amount: total
                        };

                        invoiceItems.push(item);
                        renderItems();
                        resetItemForm();
                        globalCatalogPrice = 0;
                        const priceInfo = document.getElementById('originalPriceInfo');
                        if (priceInfo) priceInfo.style.display = 'none';
                        if (addItemSection) addItemSection.style.display = 'none';
                    });
                }
            }

            // ============ MULTI-PAYMENT SYSTEM ============
            let paymentLines = [];
            let paymentLineCounter = 0;

            const paymentMethods = [
                {% for method in payment_methods %}
                { id: '{{ method.id }}', name: '{{ method.name }}', nameL: '{{ method.name|lower }}' },
                {% endfor %}
            ];

            const bankAccounts = [
                {% for bank in bank_accounts %}
                { id: '{{ bank.id }}', name: '{{ bank.bank_name }} - {{ bank.account_number }}' },
                {% endfor %}
            ];

            function addPaymentLine() {
                paymentLineCounter++;
                const lineId = paymentLineCounter;

                paymentLines.push({
                    id: lineId,
                    method_id: '',
                    amount: 0,
                    reference: '',
                    bank_account_id: ''
                });

                renderPaymentLines();
                updatePaymentSummary();
                document.getElementById('paymentEmptyState').style.display = 'none';
                document.getElementById('paymentSummary').style.display = 'block';
            }

            function removePaymentLine(lineId) {
                paymentLines = paymentLines.filter(p => p.id !== lineId);
                renderPaymentLines();
                updatePaymentSummary();

                if (paymentLines.length === 0) {
                    document.getElementById('paymentEmptyState').style.display = 'block';
                    document.getElementById('paymentSummary').style.display = 'none';
                }
            }

            function updatePaymentLine(lineId, field, value) {
                const line = paymentLines.find(p => p.id === lineId);
                if (line) {
                    line[field] = value;
                    updatePaymentSummary();

                    // Show/hide reference and bank account fields based on method
                    if (field === 'method_id' && value) {
                        const method = paymentMethods.find(m => m.id == value);
                        const methodName = method ? method.nameL : '';
                        const isVirement = methodName.includes('virement') || methodName.includes('bank');
                        const isEspece = methodName.includes('espece') || methodName.includes('cash') || methodName.includes('espèce');

                        const refInput = document.querySelector(`#payment-ref-${lineId}`);
                        const bankSelect = document.querySelector(`#payment-bank-${lineId}`);
                        const refGroup = document.querySelector(`#payment-ref-group-${lineId}`);
                        const bankGroup = document.querySelector(`#payment-bank-group-${lineId}`);

                        if (refGroup) refGroup.style.display = isEspece ? 'none' : 'block';
                        if (bankGroup) bankGroup.style.display = isVirement ? 'block' : 'none';
                    }
                }
            }

            function renderPaymentLines() {
                const container = document.getElementById('paymentLinesContainer');
                container.innerHTML = paymentLines.map((line, index) => `
                    <div class="payment-line" data-id="${line.id}">
                        <div class="payment-line-header">
                            <span class="payment-line-number">Paiement ${index + 1}</span>
                            <button type="button" class="btn btn-ghost btn-sm text-error" onclick="removePaymentLine(${line.id})">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="payment-line-content">
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Méthode *</label>
                                    <select class="form-select" onchange="updatePaymentLine(${line.id}, 'method_id', this.value)">
                                        <option value="">-- Sélectionner --</option>
                                        ${paymentMethods.map(m => `<option value="${m.id}" ${line.method_id == m.id ? 'selected' : ''}>${m.name}</option>`).join('')}
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Montant (DH) *</label>
                                    <input type="number" class="form-input" step="0.01" min="0" value="${line.amount || ''}"
                                           placeholder="0.00" onchange="updatePaymentLine(${line.id}, 'amount', parseFloat(this.value) || 0)"
                                           oninput="updatePaymentLine(${line.id}, 'amount', parseFloat(this.value) || 0)">
                                </div>
                            </div>
                            <div class="form-row" id="payment-ref-group-${line.id}" style="display: none;">
                                <div class="form-group">
                                    <label class="form-label">Référence paiement</label>
                                    <input type="text" id="payment-ref-${line.id}" class="form-input" value="${line.reference || ''}"
                                           placeholder="N° chèque, réf. virement..."
                                           onchange="updatePaymentLine(${line.id}, 'reference', this.value)">
                                </div>
                                <div class="form-group" id="payment-bank-group-${line.id}" style="display: none;">
                                    <label class="form-label">Compte bancaire</label>
                                    <select id="payment-bank-${line.id}" class="form-select" onchange="updatePaymentLine(${line.id}, 'bank_account_id', this.value)">
                                        <option value="">-- Sélectionner --</option>
                                        ${bankAccounts.map(b => `<option value="${b.id}" ${line.bank_account_id == b.id ? 'selected' : ''}>${b.name}</option>`).join('')}
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                `).join('');
            }

            function updatePaymentSummary() {
                const total = paymentLines.reduce((sum, p) => sum + (p.amount || 0), 0);
                document.getElementById('totalPayments').textContent = total.toFixed(2) + ' DH';
                updateInvoiceSummary();
            }

            function getTotalPayments() {
                return paymentLines.reduce((sum, p) => sum + (p.amount || 0), 0);
            }

            // Expose payment functions globally for onclick handlers
            window.removePaymentLine = removePaymentLine;
            window.updatePaymentLine = updatePaymentLine;

            // Add Payment button event
            const addPaymentBtn = document.getElementById('addPaymentBtn');
            if (addPaymentBtn) {
                addPaymentBtn.addEventListener('click', addPaymentLine);
            }

            // Add items and payments to form before submit
            const mainForm = document.querySelector('form[method="post"]');
            if (mainForm) {
                const submitBtn = mainForm.querySelector('button[type="submit"]');
                if (submitBtn) {
                    submitBtn.addEventListener('click', function(e) {
                        // Add items
                        if (invoiceItems.length > 0) {
                            mainForm.querySelectorAll('input[name^="items["]').forEach(el => el.remove());

                            invoiceItems.forEach((item, index) => {
                                const input = document.createElement('input');
                                input.type = 'hidden';
                                input.name = `items[${index}]`;
                                input.value = JSON.stringify(item);
                                mainForm.appendChild(input);
                            });
                        }

                        // Add payments
                        mainForm.querySelectorAll('input[name^="payments["]').forEach(el => el.remove());
                        mainForm.querySelectorAll('input[name="amount_paid"]').forEach(el => el.remove());

                        if (paymentLines.length > 0) {
                            paymentLines.forEach((payment, index) => {
                                const input = document.createElement('input');
                                input.type = 'hidden';
                                input.name = `payments[${index}]`;
                                input.value = JSON.stringify(payment);
                                mainForm.appendChild(input);
                            });
                        }

                        // Add total amount_paid for backward compatibility
                        const totalPaid = getTotalPayments();
                        const amountPaidInput = document.createElement('input');
                        amountPaidInput.type = 'hidden';
                        amountPaidInput.name = 'amount_paid';
                        amountPaidInput.value = totalPaid.toFixed(2);
                        mainForm.appendChild(amountPaidInput);

                        mainForm.submit();
                    });
                }
            }
        });
    </script>

    <style>
        /* Multi-payment styles */
        .empty-state-small {
            text-align: center;
            padding: var(--space-4);
            color: var(--neutral-500);
        }

        .empty-state-small i {
            font-size: 2rem;
            margin-bottom: var(--space-2);
            opacity: 0.5;
        }

        .empty-state-small p {
            font-size: var(--text-sm);
            margin: 0;
        }

        .payment-line {
            border: 1px solid var(--neutral-200);
            border-radius: var(--radius-md);
            margin-bottom: var(--space-3);
            overflow: hidden;
        }

        .payment-line-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--space-2) var(--space-3);
            background: var(--neutral-50);
            border-bottom: 1px solid var(--neutral-200);
        }

        .payment-line-number {
            font-weight: var(--font-semibold);
            font-size: var(--text-sm);
            color: var(--neutral-700);
        }

        .payment-line-content {
            padding: var(--space-3);
        }

        .payment-line-content .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--space-3);
        }

        .payment-line-content .form-group {
            margin-bottom: var(--space-2);
        }

        .payment-line-content .form-label {
            font-size: var(--text-xs);
            margin-bottom: var(--space-1);
        }

        .payment-summary {
            margin-top: var(--space-3);
            padding-top: var(--space-3);
            border-top: 2px solid var(--neutral-200);
        }

        .payment-summary-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: var(--font-semibold);
            color: var(--primary-600);
        }

        @media (max-width: 600px) {
            .payment-line-content .form-row {
                grid-template-columns: 1fr;
            }
        }
    </style>
{% endblock %}
